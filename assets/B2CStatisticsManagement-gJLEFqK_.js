import{f as se,r as k,w as Xe,k as Va,aV as x,Z as $,bH as s,b2 as Ia,a8 as a,a0 as d,a7 as c,u as y,_ as j,bJ as pe,bf as w,$ as E,aG as Ve,b0 as ve,F as oe,aH as We,bM as il,bK as Da}from"./@vue-Cr_z6yfx.js";import{l as Ea}from"./lodash-CiJWSuVn.js";import{_ as qa,b as $a}from"./index-ZcDhEpUM.js";import{i as za}from"./vuetify-use-dialog-C5oZ13xz.js";import{C as Na}from"./ConfirmDeleteDialogWithTextField-DtpfDroW.js";import{b as Ra,e as La,c as F}from"./yup-WHNMwcW8.js";import{u as Ma,a as A}from"./vee-validate-BXV9nMa7.js";import{b as Vl}from"./route-block-B_A1xBdJ.js";import{q as Ta,Q as Oa,w as p,v as R,a as Y,f as Z,g as b,A as J,c as G,P as Q,_ as ge,r as S,T as fe,d as ne,R as ja,C as Il,D as Dl,x as Ie,y as El,J as ql,U as $l,a1 as Ua,e as De,V as ye,b as Ba,O as Aa,a3 as Fa,a4 as zl}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";import"./core-js-D2hAHviU.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./vue-router-CS4OewbW.js";import"./jspdf-DacfHTdZ.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-DzadwsAs.js";const Za={class:"d-flex align-center px-6 px-sm-10 py-3"},Ha={class:"d-flex align-center"},Xa={class:"d-flex align-center"},Wa={class:"d-flex align-center"},Ya={class:"d-flex align-center"},Ja={class:"d-flex align-center"},Ga={class:"d-flex align-center"},Ka={key:0},Qa={class:"text-caption text-grey-darken-1"},et=["innerHTML"],lt={key:1,class:"inquiry-result-text text-grey-darken-1"},at={class:"d-flex align-center"},tt={class:"white-space-pre-wrap flex-grow-1"},st={key:0,class:"text-caption text-grey-darken-1"},ot={key:1,class:"text-grey"},nt={class:"text-center"},rt={class:"card-title px-6 py-4 bg-blue-grey-darken-2 d-flex align-center"},it={key:0,class:"d-flex justify-center align-center",style:{"min-height":"458px"}},ut={class:"d-flex align-end my-2"},dt={key:0,class:"d-flex justify-center align-center",style:{"min-height":"200px"}},ct={key:1},mt={class:"card-title px-6 py-4 bg-blue-grey-darken-2 d-flex align-center"},pt={class:"mt-4 mt-md-8 selected-employees-container"},vt={class:"sub-title mb-4 text-blue-grey-darken-2"},gt={class:"d-flex flex-wrap ps-1"},ft={class:"d-flex justify-space-between align-center ps-2 pe-1 py-1"},yt={class:"text-subtitle-2 text-deep-purple-darken-2 d-flex align-center"},bt={class:"order-badge me-2"},kt={class:"text-caption text-deep-purple-darken-2 mt-1 d-flex align-center"},xt=["onClick"],ht={key:1},_t={class:"d-flex justify-space-between align-center"},wt={class:"d-flex flex-column align-center me-2"},Pt={class:"card-title px-6 py-4 bg-blue-grey-darken-2 d-flex align-center"},St={class:"mt-8 selected-employees-container"},Ct={class:"sub-title mb-4 text-blue-grey-darken-2"},Vt={class:"d-flex flex-wrap ps-1"},It={class:"d-flex justify-space-between align-center ps-2 pe-1 py-1"},Dt={class:"text-subtitle-2 text-deep-purple-darken-2 d-flex align-center"},Et={class:"text-grey-darken-2"},qt={class:"card-title px-6 py-2 mb-2 d-flex justify-space-between align-center bg-teal-darken-2"},$t={key:0},zt={key:1},Nt={class:"card-title px-6 py-1 mb-2 d-flex justify-space-between align-center bg-teal-darken-2"},Rt={class:"d-flex justify-space-between align-center"},Lt={class:"card-title text-grey-darken-2 mb-3"},Nl={__name:"B2CStatisticsManagement",setup(Mt){const{apiAuth:I}=$a(),h=za(),{mdAndUp:Rl,smAndUp:ul,lgAndUp:dl}=Ta(),Ll=se(()=>Rl.value?"880":"100%"),Ee=k(!1),z=k(!1),L=se(()=>ul.value?"default":"small"),Ml=[{title:"公司",key:"company.name",minWidth:"100px",align:"start",sortable:!0},{title:"日期 / 時間",key:"inquiryDate",minWidth:"116px",align:"start",sortable:!0},{title:"來源",key:"source",width:"90px",align:"start",sortable:!0},{title:"地區",key:"inquiryPlace",minWidth:"84px",align:"start",sortable:!0},{title:"詢問內容",key:"inquiryContent",width:"240px",align:"start",sortable:!0},{title:"客戶姓名",key:"customerName",minWidth:"104px",align:"start",sortable:!0},{title:"稱謂",key:"customerTitle",align:"start",sortable:!0},{title:"電話",key:"customerPhone",align:"start",sortable:!0},{title:"Line ID",key:"customerLineId",align:"start",sortable:!0},{title:"Email",key:"customerEmail",align:"start",sortable:!0},{title:"業務",key:"salesPerson.name",align:"start",sortable:!0},{title:"詢問結果",key:"inquiryResult",minWidth:"110px",align:"start",sortable:!0},{title:"最新進度 / 備註",key:"latestProgressNote.content",width:"220px",align:"start",sortable:!0},{title:"操作",key:"actions",minWidth:"100px",align:"center",sortable:!1}],re=k(!1),U=k([]),qe=k(1),$e=k(10),cl=k(0),be=k([{key:"inquiryDate",order:"desc"}]),ee=k(""),ke=k([]),ml=k([]),P=k({company:null,source:null,salesPerson:null,dateRange:null,inquiryPlace:null,inquiryResult:null}),ie=[{text:"Facebook",value:"Facebook"},{text:"Line@",value:"Line@"},{text:"IG",value:"IG"},{text:"非常婚禮",value:"非常婚禮"},{text:"其他",value:"其他"}],Tl=[{text:"成交",value:"成交"},{text:"不成交",value:"不成交"},{text:"其他",value:"其他"}],Ye=k([]),pl=["先生","小姐","其他"],le=k({open:!1,id:"",customerName:""}),D=k({open:!1,id:null,originalResult:null,currentItemId:null,submitted:!1}),ue=k(!1),xe=k({open:!1,id:null}),Ol=[{title:"進度/備註內容",key:"content",align:"start"},{title:"建立時間",key:"createdAt",width:"170px",align:"start"}],ze=k({open:!1}),M=k([]),N=k([]),Ne=k([]),he=k(!1),Je=k(!1),_e=k(null),Re=k({open:!1}),T=k([]),ae=k([]),Ge=k([]),Le=k(!1),Ke=k(!1),we=k(null),m=k({open:!1,type:"all",company:null,dateRange:null,sources:[],companyError:"",dateError:"",sourceError:""}),Qe=k(!1),Me=k(new Set),el=k(new Set),q=k({open:!1,itemId:null,salesPersonId:null,salesPersonName:"",customerName:"",isEditMode:void 0,processedValues:null,isLoading:!1}),te=k(new Map),vl=k([]),de=k([]),ce=k(""),jl=Ra({inquiryDate:La().required("請選擇日期"),source:F().required("請選擇來源"),inquiryPlace:F().required("請選擇地區"),company:F().required("請選擇公司"),salesPerson:F().nullable().transform(t=>t||null),customerName:F().required("請輸入客戶姓名").trim(),customerTitle:F().nullable(),customerPhone:F().nullable(),customerLineId:F().nullable(),customerEmail:F().nullable().email("請輸入正確的 Email 格式"),inquiryContent:F().nullable()}),{handleSubmit:Ul,isSubmitting:Bl,resetForm:gl}=Ma({validationSchema:jl,initialValues:{inquiryDate:new Date,source:"",inquiryPlace:"",company:"",salesPerson:"",customerName:"",customerTitle:null,customerPhone:"",customerLineId:"",customerEmail:"",inquiryContent:""}}),Te=A("inquiryDate"),Oe=A("source"),je=A("inquiryPlace"),K=A("company"),Pe=A("salesPerson"),Ue=A("customerName"),Be=A("customerTitle"),Ae=A("customerPhone"),Fe=A("customerLineId"),Ze=A("customerEmail"),me=A("inquiryContent"),Al=se(()=>Ne.value.map(t=>({...t,disabled:M.value.includes(t._id)}))),Fl=se(()=>Ge.value.map(t=>({...t,disabled:T.value.includes(t._id)}))),fl=se(()=>{const t={};return N.value.forEach(e=>{var l;const o=((l=e.company)==null?void 0:l.name)||"未分類";t[o]||(t[o]=[]),t[o].push({...e,order:typeof e.order=="number"?e.order:9999})}),Object.values(t).forEach(e=>{e.sort((o,l)=>{const i=typeof o.order=="number"?o.order:9999,n=typeof l.order=="number"?l.order:9999;return i!==n?i-n:o.name.localeCompare(l.name)})}),Object.fromEntries(Object.entries(t).sort(([,e],[,o])=>{var n,r,u,f;const l=((r=(n=e[0])==null?void 0:n.company)==null?void 0:r.companyId)||"ZZZZ",i=((f=(u=o[0])==null?void 0:u.company)==null?void 0:f.companyId)||"ZZZZ";return l.localeCompare(i)}))}),Zl=se(()=>{const t={};return ae.value.forEach(e=>{var l;const o=((l=e.company)==null?void 0:l.name)||"未分類";t[o]||(t[o]=[]),t[o].push(e)}),Object.fromEntries(Object.entries(t).sort(([,e],[,o])=>{var n,r,u,f;const l=((r=(n=e[0])==null?void 0:n.company)==null?void 0:r.companyId)||"ZZZZ",i=((f=(u=o[0])==null?void 0:u.company)==null?void 0:f.companyId)||"ZZZZ";return l.localeCompare(i)}))}),Hl=se(()=>{const t=U.value.find(e=>e._id===xe.value.id);return(t==null?void 0:t.progressNotes)||[]}),Xl=async()=>{var t,e;try{const{data:o}=await I.get("/lineCategories/all-second-level");o.success&&(Ye.value=o.result.sort((l,i)=>l.order-i.order).map(l=>l.name))}catch(o){console.error("載入地區選項失敗:",o),h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"載入地區選項失敗",snackbarProps:{color:"red-lighten-1"}})}},Wl=async()=>{var t,e;try{const{data:o}=await I.get("/companies/all");o.success&&(ke.value=o.result.data.sort((l,i)=>l.companyId.localeCompare(i.companyId)),ml.value=[...ke.value])}catch(o){console.error("載入公司列表失敗:",o),h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"載入公司列表失敗",snackbarProps:{color:"red-lighten-1"}})}},ll=async()=>{var t,e;try{const o={showInB2C:!0};P.value.company&&(o.company=P.value.company);const{data:l}=await I.get("/employees/suggestions",{params:o});l.success&&(vl.value=l.result)}catch(o){console.error("載入業務列表失敗:",o),h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"載入業務列表失敗",snackbarProps:{color:"red-lighten-1"}})}},Yl=t=>{P.value.dateRange=t},Jl=()=>{P.value.dateRange=null,z.value&&(z.value=!1)},Gl=async()=>{P.value.company&&await ll()},O=async()=>{var t,e,o,l;try{re.value=!0;const i={page:qe.value,itemsPerPage:$e.value,sortBy:((t=be.value[0])==null?void 0:t.key)||"inquiryDate",sortOrder:((e=be.value[0])==null?void 0:e.order)||"desc",quickSearch:ee.value,source:P.value.source,inquiryPlace:P.value.inquiryPlace,salesPerson:P.value.salesPerson,inquiryResult:P.value.inquiryResult};if(P.value.company&&(i.company=P.value.company),Array.isArray(P.value.dateRange)&&P.value.dateRange.length>0){const r=new Date(P.value.dateRange[0]),u=new Date(P.value.dateRange[P.value.dateRange.length-1]);r.setHours(0,0,0,0),u.setHours(23,59,59,999),i.dateStart=r.toISOString(),i.dateEnd=u.toISOString()}const{data:n}=await I.get("/customerInquiries/all",{params:i});n.success&&(U.value=n.result.data,cl.value=n.result.totalItems)}catch(i){console.error("搜尋失敗:",i),h({text:((l=(o=i==null?void 0:i.response)==null?void 0:o.data)==null?void 0:l.message)||"搜尋失敗",snackbarProps:{color:"red-lighten-1"}})}finally{re.value=!1,Ee.value=!1}},Kl=()=>{P.value={company:null,source:null,salesPerson:null,dateRange:null,inquiryPlace:null,inquiryResult:null},ee.value="",z.value=!1,O()},Ql=async t=>{var e;qe.value=t.page,$e.value=t.itemsPerPage,((e=t.sortBy)==null?void 0:e.length)>0&&(be.value=t.sortBy),await O()},ea=Ea.debounce(()=>{qe.value=1,O()},300);Xe(ee,()=>{Ee.value=!0,ea()});const la=()=>{if(z.value){const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t.getFullYear(),t.getMonth()+1,0);P.value.dateRange=[e,o]}else P.value.dateRange=null;O()},yl=()=>{z.value=!z.value,la()},aa=t=>{le.value={open:!0,id:t._id,customerName:t.customerName||"未提供姓名"}},ta=async()=>{var t,e;try{await I.delete(`/customerInquiries/${le.value.id}`),await O(),le.value.open=!1,h({text:"刪除詢問記錄成功",snackbarProps:{color:"teal-lighten-1"}})}catch(o){h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},al=async t=>{var e,o,l,i,n;D.value.open=!0,D.value.id=(t==null?void 0:t._id)||null,ue.value=!0;try{if(t){if(Te.value.value=t.inquiryDate?new Date(t.inquiryDate):null,Oe.value.value=t.source||"",je.value.value=t.inquiryPlace||"",K.value.value=((e=t.company)==null?void 0:e._id)||"",(o=t.company)!=null&&o._id){const{data:r}=await I.get("/employees/suggestions",{params:{showInB2C:!0,employmentStatus:"在職",company:t.company._id}});r.success&&(de.value=r.result)}Pe.value.value=((l=t.salesPerson)==null?void 0:l._id)||"",Ue.value.value=t.customerName||"",Be.value.value=t.customerTitle||null,Ae.value.value=t.customerPhone||"",Fe.value.value=t.customerLineId||"",Ze.value.value=t.customerEmail||"",me.value.value=t.inquiryContent||""}else gl()}catch(r){console.error("載入詢問資料失敗:",r),h({text:((n=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:n.message)||"載入詢問資料失敗",snackbarProps:{color:"red-lighten-1"}}),Se()}finally{ue.value=!1}},Se=()=>{if(D.value.currentItemId&&!D.value.submitted){const t=U.value.find(e=>e._id===D.value.currentItemId);t&&(t.inquiryResult=D.value.originalResult)}D.value.open=!1,D.value.id=null,D.value.originalResult=null,D.value.currentItemId=null,D.value.submitted=!1,ue.value=!1,gl()},sa=async t=>{if(!(t!=null&&t._id)){console.error("無效的項目ID");return}xe.value={open:!0,id:t._id}},oa=()=>{xe.value={open:!1,id:null},ue.value=!1},na=Ul(async t=>{var e,o,l,i,n,r;try{const u=D.value.id?U.value.find(g=>g._id===D.value.id):null;let f=null;if(t.inquiryDate)if(u&&u.inquiryDate){const g=new Date(u.inquiryDate),C=new Date(t.inquiryDate);g.getFullYear()===C.getFullYear()&&g.getMonth()===C.getMonth()&&g.getDate()===C.getDate()?f=u.inquiryDate:f=new Date(C.getFullYear(),C.getMonth(),C.getDate(),g.getHours(),g.getMinutes(),g.getSeconds(),g.getMilliseconds()).toISOString()}else{const g=new Date(t.inquiryDate),C=new Date;f=new Date(g.getFullYear(),g.getMonth(),g.getDate(),C.getHours(),C.getMinutes(),C.getSeconds()).toISOString()}const v={...t,salesPerson:t.salesPerson||null,inquiryDate:f};if(D.value.id){const g=_=>_?new Date(_).toISOString():null,C={company:v.company,salesPerson:v.salesPerson||null,inquiryDate:g(v.inquiryDate),source:v.source||"",inquiryPlace:v.inquiryPlace||"",inquiryContent:v.inquiryContent||"",customerName:v.customerName||"",customerTitle:v.customerTitle||"",customerPhone:v.customerPhone||"",customerLineId:v.customerLineId||"",customerEmail:v.customerEmail||""},V={company:u.company._id.toString(),salesPerson:((o=(e=u.salesPerson)==null?void 0:e._id)==null?void 0:o.toString())||null,inquiryDate:g(u.inquiryDate),source:u.source||"",inquiryPlace:u.inquiryPlace||"",inquiryContent:u.inquiryContent||"",customerName:u.customerName||"",customerTitle:u.customerTitle||"",customerPhone:u.customerPhone||"",customerLineId:u.customerLineId||"",customerEmail:u.customerEmail||""};if(!(JSON.stringify(C)!==JSON.stringify(V))){h({text:"資料未做任何變更",snackbarProps:{color:"red-lighten-1"}});return}const X=(i=(l=u.salesPerson)==null?void 0:l._id)==null?void 0:i.toString(),B=v.salesPerson||null;if(X!==B&&B){const _=de.value.find(W=>W._id===B);if(_){q.value={open:!0,itemId:D.value.id,salesPersonId:B,salesPersonName:_.nickname||_.name,customerName:v.customerName||"未命名客戶",isEditMode:!0,processedValues:v};return}}await tl(D.value.id,v,!0)}else{if(v.salesPerson){const g=de.value.find(C=>C._id===v.salesPerson);if(g){q.value={open:!0,itemId:null,salesPersonId:v.salesPerson,salesPersonName:g.nickname||g.name,customerName:v.customerName||"未命名客戶",isEditMode:!1,processedValues:v};return}}await tl(null,v,!1)}}catch(u){h({text:((r=(n=u==null?void 0:u.response)==null?void 0:n.data)==null?void 0:r.message)||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}}),tl=async(t,e,o)=>{var l,i;try{if(o){const{data:n}=await I.patch(`/customerInquiries/${t}`,{...e,sendEmailNotification:!!q.value.salesPersonId});if(n.success){D.value.submitted=!0;const r=U.value.find(u=>u._id===t);r&&Object.assign(r,{...r,...e}),await O(),Se(),h({text:q.value.salesPersonId?"詢問資料更新成功，已發送通知給被指派的業務":"詢問資料更新成功",snackbarProps:{color:"teal-lighten-1"}})}}else{const{data:n}=await I.post("/customerInquiries",{...e,sendEmailNotification:!!q.value.salesPersonId});n.success&&(await O(),Se(),h({text:q.value.salesPersonId?"新增詢問成功，已發送通知給被指派的業務":"新增詢問成功",snackbarProps:{color:"teal-lighten-1"}}))}}catch(n){h({text:((i=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:i.message)||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}finally{q.value.isLoading=!1}},ra=()=>{if(!ce.value)return;const t=document.querySelector("textarea"),e=t.selectionStart,o=t.selectionEnd,l=me.value.value,i=l.substring(0,e),n=l.substring(o),r=` <a href="${ce.value}" target="_blank" class="url-button">連結</a>`;me.value.value=i+r+n,ce.value=""},ia=t=>t?t.replace(/<a href="([^"]+)" target="_blank" class="url-button">↗<\/a>/g,(e,o)=>`<a href="${o}" target="_blank" class="url-button">↗</a>`):"",ua=async(t,e)=>{var o,l,i;try{const n=U.value.find(f=>f._id===t);if(((o=n.salesPerson)==null?void 0:o._id)===e){h({text:"資料未做任何變更",snackbarProps:{color:"red-lighten-1"}});return}const u=(te.value.get(n.company._id)||[]).find(f=>f._id===e);if(!u){h({text:"無法選擇其他公司的業務",snackbarProps:{color:"red-lighten-1"}});return}q.value={open:!0,itemId:t,salesPersonId:e,salesPersonName:u.nickname||u.name,customerName:n.customerName||"未命名客戶"}}catch(n){h({text:((i=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:i.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},da=async()=>{var t,e;try{q.value.isLoading=!0;const{itemId:o,salesPersonId:l,isEditMode:i,processedValues:n}=q.value;if(i!==void 0)await tl(o,n,i);else{const r=U.value.find(v=>v._id===o);if(!r){h({text:"找不到該項目",snackbarProps:{color:"red-lighten-1"}});return}Me.value.add(o);const u={salesPerson:l,inquiryResult:r.inquiryResult||null,customerTitle:r.customerTitle||null,customerPhone:r.customerPhone||null,customerLineId:r.customerLineId||null,customerEmail:r.customerEmail||null,sendEmailNotification:!0},{data:f}=await I.patch(`/customerInquiries/${o}`,u);if(f.success){const g=(te.value.get(r.company._id)||[]).find(C=>C._id===l);Object.assign(r,{salesPerson:g,customerTitle:r.customerTitle,customerPhone:r.customerPhone,customerLineId:r.customerLineId,customerEmail:r.customerEmail,inquiryResult:r.inquiryResult}),await O(),h({text:"更新業務成功，已發送通知給被指派的業務",snackbarProps:{color:"teal-lighten-1"}})}}}catch(o){h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}finally{q.value.itemId&&Me.value.delete(q.value.itemId),sl()}},sl=()=>{q.value={open:!1,itemId:null,salesPersonId:null,salesPersonName:"",customerName:"",isEditMode:void 0,processedValues:null,isLoading:!1}},ca=async(t,e)=>{var o,l,i;try{const n=U.value.find(u=>u._id===t);if(n.customerTitle===e){h({text:"資料未做任何變更",snackbarProps:{color:"red-lighten-1"}});return}el.value.add(t);const{data:r}=await I.patch(`/customerInquiries/${t}`,{customerTitle:e,progressAndNote:n.progressAndNote||"",inquiryResult:n.inquiryResult||"",salesPerson:((o=n.salesPerson)==null?void 0:o._id)||null});r.success&&(n.customerTitle=e,await O(),h({text:"更新稱謂成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(n){h({text:((i=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:i.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}finally{el.value.delete(t)}},bl=async()=>{var t,e,o;ze.value.open=!0,he.value=!0,_e.value=null,localStorage.removeItem("b2c_employee_order"),console.log("已清除 localStorage 中的排序資料");try{await kl("");const{data:l}=await I.get("/employees/suggestions",{params:{showInB2C:!0,employmentStatus:"在職"}});if(l.success){let i={};try{const r=localStorage.getItem("b2c_employee_order");r&&(i=JSON.parse(r),console.log("從 localStorage 讀取的排序:",i))}catch(r){console.error("讀取排序失敗:",r)}M.value=[],N.value=[];const n={};for(const r of l.result){const u=((t=r.company)==null?void 0:t.name)||"未分類";n[u]||(n[u]=[]);const f=i[r._id];n[u].push({...r,nickname:r.nickname||"",lineID:r.lineID||"",order:f!==void 0?f:n[u].length})}console.log("分組後的資料（排序前）:");for(const[r,u]of Object.entries(n))console.log(`${r}:`,u.map(f=>`${f.name}(order=${f.order})`));for(const r of Object.values(n))r.sort((u,f)=>u.order-f.order);console.log("排序後的資料:");for(const[r,u]of Object.entries(n))console.log(`${r}:`,u.map(f=>`${f.name}(order=${f.order})`));for(const r of Object.values(n))for(const u of r)M.value.push(u._id);for(const r of Object.values(n))for(const u of r)N.value.push(u)}}catch(l){console.error("載入員工資料失敗:",l),h({text:((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.message)||"載入員工資料失敗",snackbarProps:{color:"red-lighten-1"}})}finally{he.value=!1}},ol=()=>{ze.value.open=!1,M.value=[],Ne.value=[],_e.value=null},kl=async t=>{var e,o;he.value=!0;try{const{data:l}=await I.get("/employees/suggestions",{params:{quickSearch:t||"",employmentStatus:"在職"}});l.success&&(Ne.value=l.result.map(i=>({...i,nickname:i.nickname||"",employeeCode:i.employeeCode||"",company:i.company||{name:"未分類"}})))}catch(l){console.error("載入員工列表失敗:",l),h({text:((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.message)||"載入員工列表失敗",snackbarProps:{color:"red-lighten-1"}})}finally{he.value=!1}},ma=async t=>{if(t&&!M.value.includes(t)){const e=Ne.value.find(o=>o._id===t);if(e){const l=N.value.filter(i=>{var n,r;return(((n=i.company)==null?void 0:n.name)||"未分類")===(((r=e.company)==null?void 0:r.name)||"未分類")}).length;M.value.push(t),N.value.push({...e,nickname:e.nickname||"",lineID:e.lineID||"",order:l})}}_e.value=null},pa=t=>{var i;const e=N.value.find(n=>n._id===t);if(!e)return;const o=((i=e.company)==null?void 0:i.name)||"未分類";M.value=M.value.filter(n=>n!==t),N.value=N.value.filter(n=>n._id!==t);const l=N.value.filter(n=>{var r;return(((r=n.company)==null?void 0:r.name)||"未分類")===o});l.sort((n,r)=>n.order-r.order),l.forEach((n,r)=>{const u=N.value.findIndex(f=>f._id===n._id);u!==-1&&(N.value[u].order=r)})},xl=(t,e,o)=>{console.log(`移動員工: ${t} 第 ${e} 位 ${o==="up"?"向上":"向下"}`);const l=N.value.filter(g=>{var C;return(((C=g.company)==null?void 0:C.name)||"未分類")===t}).sort((g,C)=>g.order-C.order);if(console.log("同公司員工排序前:"),l.forEach((g,C)=>{console.log(`${C}: ${g.name} - order=${g.order}`)}),e<0||e>=l.length){console.log("索引無效");return}const i=o==="up"?e-1:e+1;if(i<0||i>=l.length){console.log("新索引無效");return}const n=l[e],r=l[i];console.log(`要交換的員工: ${n.name} 和 ${r.name}`);const u=[...N.value],f=u.findIndex(g=>g._id===n._id),v=u.findIndex(g=>g._id===r._id);f!==-1&&v!==-1?([l[e],l[i]]=[l[i],l[e]],l.forEach((g,C)=>{const V=u.findIndex(H=>H._id===g._id);V!==-1&&(u[V].order=C)}),console.log("移動並重新排序後:"),l.forEach((g,C)=>{console.log(`${C}: ${g.name} - order=${g.order}`)}),N.value=[...u]):console.log("找不到員工索引")},va=async()=>{var t,e,o,l,i,n;Je.value=!0;try{const{data:r}=await I.get("/employees/suggestions",{params:{showInB2C:!0,employmentStatus:"在職"}});if(!r.success)throw new Error("無法取得原始業務資料");const u=r.result.map(_=>_._id),f=u.filter(_=>!M.value.includes(_)),v=M.value.filter(_=>!u.includes(_)),g=[];for(const[,_]of Object.entries(fl.value))_.forEach((W,He)=>{g.push({id:W._id,order:He})});console.log("最終順序更新:",g);const C={};r.result.forEach(_=>{C[_._id]=_.order});const V=g.some(_=>C[_.id]!==_.order);if(!(f.length>0||v.length>0||V)){h({text:"資料未做任何變更",snackbarProps:{color:"red-lighten-1"}});return}console.log("檢查變更:",{移除的業務:f,新增的業務:v,順序變更:V,最終順序:g});let X=!1;if(f.length>0)try{await I.post("/employees/batch-update-b2c",{employeeIds:f,showInB2C:!1}),console.log("已移除業務:",f)}catch(_){if(((e=(t=_==null?void 0:_.response)==null?void 0:t.data)==null?void 0:e.message)!=="資料未做任何變更")throw X=!0,_}if(v.length>0)try{await I.post("/employees/batch-update-b2c",{employeeIds:v,showInB2C:!0}),console.log("已新增業務:",v)}catch(_){if(((l=(o=_==null?void 0:_.response)==null?void 0:o.data)==null?void 0:l.message)!=="資料未做任何變更")throw X=!0,_}if(g.length>0)try{await I.post("/employees/batch-update-order",{updates:g}),console.log("已更新業務順序:",g)}catch(_){throw console.error("更新順序失敗:",_),X=!0,_}const B={};if(g.forEach(_=>{B[_.id]=_.order}),localStorage.setItem("b2c_employee_order",JSON.stringify(B)),console.log("保存到 localStorage 的排序:",B),!X){h({text:"業務設定更新成功",snackbarProps:{color:"teal-lighten-1"}}),ol(),await ll();const _=new Set;U.value.forEach(W=>{var He;(He=W.company)!=null&&He._id&&_.add(W.company._id)}),te.value.clear();for(const W of _)await Cl(W);await O(),console.log("已重新載入所有資料")}}catch(r){console.error("更新業務設定失敗:",r),h({text:((n=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:n.message)||"更新業務設定失敗",snackbarProps:{color:"red-lighten-1"}})}finally{Je.value=!1}},hl=async()=>{var t,e,o;Re.value.open=!0,Le.value=!0,we.value=null;try{await _l("");const{data:l}=await I.get("/employees/suggestions",{params:{employmentStatus:"在職"}});if(l.success){const i=l.result.filter(r=>r.isB2CSupervisor);T.value=[],ae.value=[];const n={};for(const r of i){const u=((t=r.company)==null?void 0:t.name)||"未分類";n[u]||(n[u]=[]),n[u].push({...r,nickname:r.nickname||""})}for(const r of Object.values(n))for(const u of r)T.value.push(u._id);for(const r of Object.values(n))for(const u of r)ae.value.push(u)}}catch(l){console.error("載入業務主管資料失敗:",l),h({text:((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.message)||"載入業務主管資料失敗",snackbarProps:{color:"red-lighten-1"}})}finally{Le.value=!1}},nl=()=>{Re.value.open=!1,T.value=[],ae.value=[],we.value=null},_l=async t=>{var e,o;try{const{data:l}=await I.get("/employees/suggestions",{params:{search:t,employmentStatus:"在職"}});l.success&&(Ge.value=l.result.filter(i=>!i.isB2CSupervisor))}catch(l){console.error("載入業務主管列表失敗:",l),h({text:((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.message)||"載入業務主管列表失敗",snackbarProps:{color:"red-lighten-1"}})}finally{Le.value=!1}},ga=async t=>{if(t&&!T.value.includes(t)){const e=Ge.value.find(o=>o._id===t);e&&(T.value.push(t),ae.value.push({...e,nickname:e.nickname||""}))}we.value=null},fa=t=>{T.value=T.value.filter(e=>e!==t),ae.value=ae.value.filter(e=>e._id!==t)},ya=async()=>{var t,e;Ke.value=!0;try{const{data:o}=await I.get("/employees/suggestions",{params:{employmentStatus:"在職"}});if(!o.success)throw new Error("無法取得原始業務主管資料");const i=o.result.filter(v=>v.isB2CSupervisor).map(v=>v._id),n=i.filter(v=>!T.value.includes(v)),r=T.value.filter(v=>!i.includes(v));if(!(n.length>0||r.length>0)){h({text:"資料未做任何變更",snackbarProps:{color:"red-lighten-1"}});return}console.log("檢查變更:",{移除的業務主管:n,新增的業務主管:r});let f=!1;if(n.length>0)try{for(const v of n)await I.patch(`/employees/${v}`,{isB2CSupervisor:!1});console.log("已移除業務主管:",n)}catch(v){throw f=!0,v}if(r.length>0)try{for(const v of r)await I.patch(`/employees/${v}`,{isB2CSupervisor:!0});console.log("已新增業務主管:",r)}catch(v){throw f=!0,v}f||(h({text:"業務主管設定更新成功",snackbarProps:{color:"teal-lighten-1"}}),nl())}catch(o){console.error("更新業務主管設定失敗:",o),h({text:((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"更新業務主管設定失敗",snackbarProps:{color:"red-lighten-1"}})}finally{Ke.value=!1}},wl=()=>{m.value={open:!0,type:"all",company:null,dateRange:null,sources:[],companyError:"",dateError:"",sourceError:""}},rl=()=>{m.value.open=!1},ba=()=>{m.value.sourceError="",m.value.sources.length===ie.length?m.value.sources=[]:m.value.sources=ie.map(t=>t.value)},ka=async()=>(window.XLSX||await new Promise((t,e)=>{const o=document.createElement("script");o.src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js",o.onload=t,o.onerror=e,document.head.appendChild(o)}),window.XLSX),Ce=t=>{if(!t)return"";const e=new Date(t),o=e.getFullYear(),l=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${o}/${l}/${i}`},xa=async()=>{var t,e;try{let o=!1;if(m.value.companyError="",m.value.dateError="",m.value.sourceError="",m.value.type==="company"&&!m.value.company&&(m.value.companyError="請選擇公司",o=!0),(!m.value.dateRange||!Array.isArray(m.value.dateRange)||m.value.dateRange.length===0)&&(m.value.dateError="請選擇日期區間",o=!0),(!m.value.sources||m.value.sources.length===0)&&(m.value.sourceError="請選擇至少一個來源",o=!0),o)return;Qe.value=!0;const l={};if(m.value.dateRange&&Array.isArray(m.value.dateRange)&&m.value.dateRange.length>0){const n=new Date(m.value.dateRange[0]),r=new Date(m.value.dateRange[m.value.dateRange.length-1]);n.setHours(0,0,0,0),r.setHours(23,59,59,999),l.dateStart=n.toISOString(),l.dateEnd=r.toISOString()}m.value.sources.length>0&&(l.sources=m.value.sources.join(",")),m.value.type==="company"&&(l.companies=m.value.company);const{data:i}=await I.get("/customerInquiries/export",{params:l});if(i.success){const n=await ka(),r=i.result.map(V=>{var X,B;let H=V.inquiryContent||"";return H=H.replace(/<a[^>]*href="([^"]*)"[^>]*>點擊<\/a>/g,"$1"),{公司:((X=V.company)==null?void 0:X.name)||"",日期:Ce(V.inquiryDate),來源:V.source||"",地區:V.inquiryPlace||"",詢問內容:H,客戶姓名:V.customerName||"",稱謂:V.customerTitle||"",電話:V.customerPhone||"","Line ID":V.customerLineId||"",Email:V.customerEmail||"",業務:V.salesPerson?V.salesPerson.nickname||V.salesPerson.name:"",詢問結果:V.inquiryResult||"","最新進度 / 備註":((B=V.progressNotes)==null?void 0:B.length)>0?V.progressNotes[V.progressNotes.length-1].content:""}}),u=n.utils.json_to_sheet(r),f={公司:15,日期:12,來源:12,地區:12,詢問內容:50,客戶姓名:15,稱謂:10,電話:15,"Line ID":15,Email:30,業務:12,詢問結果:12,"最新進度 / 備註":50};u["!cols"]=Object.values(f).map(V=>({wch:V}));const v=n.utils.book_new();n.utils.book_append_sheet(v,u,"直客詢問統計表");let g="";if(m.value.type==="company"){const V=ke.value.find(H=>H._id===m.value.company);g=V?V.name:""}const C=m.value.type==="all"?`直客詢問統計表_${Ce(m.value.dateRange[0])}_${Ce(m.value.dateRange[m.value.dateRange.length-1])}.xlsx`:`直客詢問統計表_${g}_${Ce(m.value.dateRange[0])}_${Ce(m.value.dateRange[m.value.dateRange.length-1])}.xlsx`;n.writeFile(v,C),rl(),h({text:"Excel 匯出成功",snackbarProps:{color:"teal-lighten-1"}})}}catch(o){console.error("Error:",o);const l=((e=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:e.message)||"操作失敗";h({text:l,snackbarProps:{color:"red-lighten-1"}})}finally{Qe.value=!1}},ha=t=>{if(!t)return"";try{const e=new Date(t);return isNaN(e.getTime())?"":e.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})}catch(e){return console.error("Error formatting date part:",e),""}},_a=t=>{if(!t)return"";try{const e=new Date(t);return isNaN(e.getTime())?"":e.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch(e){return console.error("Error formatting time part:",e),""}},Pl=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`},wa=t=>{switch(t){case"小姐":return"pink-lighten-1";case"先生":return"blue-darken-1";case"其他":return"grey-darken-2";default:return"grey"}},Sl=t=>{var i;if(!t||t.isB2CSupervisor)return"";const e=((i=t.company)==null?void 0:i._id)||t.company;if(!e)return typeof t.order=="number"?`${t.order+1}.`:"";const l=(te.value.get(e)||[]).findIndex(n=>n._id===t._id);return l!==-1?`${l+1}.`:typeof t.order=="number"?`${t.order+1}.`:""},Pa=async t=>{try{await navigator.clipboard.writeText(t),h({text:"Line連結已複製",snackbarProps:{color:"teal-lighten-1"}})}catch(e){console.error("複製失敗:",e),h({text:"複製失敗",snackbarProps:{color:"red-lighten-1"}})}},Sa=async t=>{try{await navigator.clipboard.writeText(t),h({text:"Line ID 已複製",snackbarProps:{color:"teal-lighten-1"}})}catch(e){console.error("複製失敗:",e),h({text:"複製失敗",snackbarProps:{color:"red-lighten-1"}})}},Cl=async t=>{try{const{data:e}=await I.get("/employees/suggestions",{params:{showInB2C:!0,company:t}});if(e.success){const o=e.result.sort((l,i)=>{const n=typeof l.order=="number"?l.order:9999,r=typeof i.order=="number"?i.order:9999;return n!==r?n-r:l.name.localeCompare(i.name)});te.value.set(t,o)}}catch(e){console.error("載入業務列表失敗:",e),te.value.set(t,[])}};Xe(()=>U.value,async t=>{if(!t)return;const e=new Set(t.map(o=>o.company._id));for(const o of e)await Cl(o)},{immediate:!0}),Xe(()=>K.value.value,async t=>{var e,o;if(Pe.value.value=null,t)try{const{data:l}=await I.get("/employees/suggestions",{params:{showInB2C:!0,employmentStatus:"在職",company:t}});l.success&&(de.value=l.result)}catch(l){console.error("載入業務列表失敗:",l),h({text:((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.message)||"載入業務列表失敗",snackbarProps:{color:"red-lighten-1"}})}else de.value=[]}),Xe(()=>P.value.dateRange,t=>{if(t&&z.value){const e=new Date,o=new Date(e.getFullYear(),e.getMonth(),1),l=new Date(e.getFullYear(),e.getMonth()+1,0);t.length===2&&new Date(t[0]).getTime()===o.getTime()&&new Date(t[1]).getTime()===l.getTime()||(z.value=!1)}else!t&&z.value&&(z.value=!1)}),Va(async()=>{try{re.value=!0,await Promise.all([Wl(),ll(),Xl()]),await O()}catch(t){console.error("初始化失敗:",t),h({text:"初始化失敗",snackbarProps:{color:"red-lighten-1"}})}finally{re.value=!1}});const Ca=t=>{switch(t){case"成交":return"teal-lighten-1";case"不成交":return"red-lighten-1";case"其他":return"grey-darken-1";default:return"grey-lighten-2"}};return(t,e)=>{const o=Ia("v-date-input");return x(),$(Oa,{"max-width":"2400"},{default:s(()=>[a(R,{class:"pt-md-5 px-0 px-md-2 px-xxl-4"},{default:s(()=>[a(p,{cols:"12"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"12"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"12",class:"px-lg-6 px-xl-4"},{default:s(()=>[a(Y,{class:"elevation-4 rounded-lg py-2 py-sm-7 px-0"},{default:s(()=>[d("div",Za,[e[40]||(e[40]=d("h3",{class:"me-4"}," 直客詢問管理 ",-1)),a(Z),a(b,{to:"/B2CStatisticsSales",variant:"plain",ripple:!1,class:"px-0",color:"blue-grey-darken-2"},{default:s(()=>e[39]||(e[39]=[c(" 業務頁面 > ")])),_:1})]),a(J,{class:"mt-2 mt-sm-5 mb-2 mb-sm-6"}),a(G,{class:"pt-4 px-6 px-sm-10 pb-1 pb-sm-4"},{default:s(()=>[a(R,{class:"mb-2"},{default:s(()=>[a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Ha,[e[41]||(e[41]=c(" 公司 : ")),a(Q,{modelValue:P.value.company,"onUpdate:modelValue":[e[0]||(e[0]=l=>P.value.company=l),Gl],items:ml.value,"item-title":l=>l?`${l.name} (${l.companyId})`:"","item-value":"_id",variant:"outlined",density:"compact",placeholder:"請選擇公司","hide-details":"",clearable:"",class:"ms-4"},null,8,["modelValue","items","item-title"])])]),_:1}),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Xa,[e[42]||(e[42]=d("span",{class:"text-label"},"來源 :",-1)),a(Q,{modelValue:P.value.source,"onUpdate:modelValue":e[1]||(e[1]=l=>P.value.source=l),items:ie,"item-title":"text","item-value":"value",variant:"outlined",density:"compact",placeholder:"請選擇來源","hide-details":"",clearable:"",class:"ms-4"},null,8,["modelValue"])])]),_:1}),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Wa,[e[43]||(e[43]=d("span",{class:"text-label"},"業務 :",-1)),a(ge,{modelValue:P.value.salesPerson,"onUpdate:modelValue":e[2]||(e[2]=l=>P.value.salesPerson=l),class:"ms-4",items:vl.value,"item-title":l=>l?`${l.name} (${l.nickname?l.nickname+" ":""}${l.employeeCode})`:"","item-value":"_id",variant:"outlined",density:"compact",placeholder:P.value.company?"請選擇業務":"請先選擇公司","hide-details":"",clearable:"",disabled:!P.value.company},null,8,["modelValue","items","item-title","placeholder","disabled"])])]),_:1}),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Ya,[e[44]||(e[44]=d("span",{class:"text-label"},"日期 :",-1)),a(o,{modelValue:P.value.dateRange,"onUpdate:modelValue":[e[3]||(e[3]=l=>P.value.dateRange=l),Yl],class:"ms-4",variant:"outlined",density:"compact","prepend-icon":"","hide-details":"",clearable:"",placeholder:"請選擇日期",multiple:"range","cancel-text":"取消","ok-text":"確認","onClick:clear":Jl},null,8,["modelValue"])])]),_:1}),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Ja,[e[45]||(e[45]=d("span",{class:"text-label"},"地區 :",-1)),a(ge,{modelValue:P.value.inquiryPlace,"onUpdate:modelValue":e[4]||(e[4]=l=>P.value.inquiryPlace=l),class:"ms-4",items:Ye.value,variant:"outlined",density:"compact",clearable:"",placeholder:"請選擇地區","hide-details":""},null,8,["modelValue","items"])])]),_:1}),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[d("div",Ga,[e[46]||(e[46]=d("span",{class:"text-label"},"結果 :",-1)),a(Q,{modelValue:P.value.inquiryResult,"onUpdate:modelValue":e[5]||(e[5]=l=>P.value.inquiryResult=l),class:"ms-4",items:Tl,"item-title":"text","item-value":"value",variant:"outlined",density:"compact",clearable:"",placeholder:"請選擇結果","hide-details":""},null,8,["modelValue"])])]),_:1}),y(ul)?(x(),$(p,{key:0})):j("",!0),a(p,{cols:"12",sm:"6",md:"4",lg:"2"},{default:s(()=>[a(R,{class:"d-flex justify-end"},{default:s(()=>[a(p,{cols:"9"},{default:s(()=>[a(b,{color:"cyan-darken-2","prepend-icon":"mdi-magnify",loading:re.value,block:"",onClick:O},{default:s(()=>e[47]||(e[47]=[c(" 搜尋 ")])),_:1},8,["loading"])]),_:1}),a(p,{cols:"3",class:"ps-0"},{default:s(()=>[a(b,{color:"grey",block:"",onClick:Kl},{default:s(()=>[a(S,null,{default:s(()=>e[48]||(e[48]=[c("mdi-refresh")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(J,{class:"my-2"}),a(R,{class:"mt-1 bg-white px-4 px-sm-9"},{default:s(()=>[a(p,{cols:"12",class:"px-4 pb-sm-4"},{default:s(()=>[a(R,null,{default:s(()=>[y(dl)?j("",!0):(x(),$(p,{key:0,class:"d-flex justify-space-between align-center"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"6",sm:"4",md:"3"},{default:s(()=>[a(b,{"prepend-icon":"mdi-microsoft-excel",color:"teal-darken-2",size:L.value,block:"",onClick:wl},{default:s(()=>e[49]||(e[49]=[c(" 匯出 EXCEL ")])),_:1},8,["size"])]),_:1}),a(p,{cols:"6",sm:"4",md:"3"},{default:s(()=>[a(b,{"prepend-icon":"mdi-account-cog",variant:"outlined",color:"blue-grey-darken-2",size:L.value,block:"",onClick:bl},{default:s(()=>e[50]||(e[50]=[c(" 業務管理 ")])),_:1},8,["size"])]),_:1}),a(p,{cols:"6",sm:"4",md:"3"},{default:s(()=>[a(b,{"prepend-icon":"mdi-account-tie",variant:"outlined",color:"blue-grey-darken-2",size:L.value,block:"",onClick:hl},{default:s(()=>e[51]||(e[51]=[c(" 業務主管 ")])),_:1},8,["size"])]),_:1}),a(p,{cols:"6",sm:"4",md:"3"},{default:s(()=>[a(b,{"prepend-icon":"mdi-plus",variant:"outlined",color:"blue-grey-darken-2",size:L.value,block:"",onClick:e[6]||(e[6]=l=>al(null))},{default:s(()=>e[52]||(e[52]=[c(" 新增詢問 ")])),_:1},8,["size"])]),_:1}),a(p,{cols:"1",class:"d-flex align-center justify-center pe-0"},{default:s(()=>[pe((x(),$(b,{icon:"",color:z.value?"orange-darken-2":"cyan-darken-2",variant:"text",size:"34",onClick:yl},{default:s(()=>[a(S,{size:"20",style:{"padding-top":"2px"}},{default:s(()=>[c(w(z.value?"mdi-calendar-remove":"mdi-calendar-month"),1)]),_:1})]),_:1},8,["color"])),[[fe,z.value?"取消本月篩選":"查看本月"]])]),_:1}),a(p,{cols:"11",sm:"7",md:"11",class:"d-flex align-center"},{default:s(()=>[pe(a(S,{icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-2"},null,512),[[fe,"可搜尋客戶姓名、電話、Email、Line ID、詢問內容、進度 / 備註","start"]]),a(ne,{modelValue:ee.value,"onUpdate:modelValue":e[7]||(e[7]=l=>ee.value=l),loading:Ee.value,density:"compact",variant:"outlined",label:"快速搜尋","append-inner-icon":"mdi-magnify","hide-details":"",clearable:""},null,8,["modelValue","loading"])]),_:1})]),_:1})]),_:1})),y(dl)?(x(),$(R,{key:1,class:"my-3 px-3"},{default:s(()=>[a(p,{cols:"9",xxl:"10"},{default:s(()=>[a(b,{"prepend-icon":"mdi-microsoft-excel",color:"teal-darken-2",class:"me-4",onClick:wl},{default:s(()=>e[53]||(e[53]=[c(" 匯出 EXCEL ")])),_:1}),a(b,{"prepend-icon":"mdi-account-cog",variant:"outlined",color:"blue-grey-darken-2",class:"me-4",onClick:bl},{default:s(()=>e[54]||(e[54]=[c(" 業務管理 ")])),_:1}),a(b,{"prepend-icon":"mdi-account-tie",variant:"outlined",color:"blue-grey-darken-2",class:"me-4",onClick:hl},{default:s(()=>e[55]||(e[55]=[c(" 業務主管 ")])),_:1}),a(b,{"prepend-icon":"mdi-plus",variant:"outlined",color:"blue-grey-darken-2",class:"me-4",onClick:e[8]||(e[8]=l=>al(null))},{default:s(()=>e[56]||(e[56]=[c(" 新增詢問 ")])),_:1}),pe((x(),$(b,{icon:"",color:z.value?"orange-darken-2":"cyan-darken-2",variant:"text",size:"34",onClick:yl},{default:s(()=>[a(S,{size:"20",style:{"padding-top":"2px"}},{default:s(()=>[c(w(z.value?"mdi-calendar-remove":"mdi-calendar-month"),1)]),_:1})]),_:1},8,["color"])),[[fe,z.value?"取消本月篩選":"查看本月"]])]),_:1}),a(p,{cols:"3",xxl:"2",class:"d-flex align-center"},{default:s(()=>[pe(a(S,{icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-2"},null,512),[[fe,"可搜尋客戶姓名、電話、Email、Line ID、詢問內容、進度 / 備註","start"]]),a(ne,{modelValue:ee.value,"onUpdate:modelValue":e[9]||(e[9]=l=>ee.value=l),loading:Ee.value,density:"compact",variant:"outlined",label:"快速搜尋","append-inner-icon":"mdi-magnify","hide-details":"",clearable:""},null,8,["modelValue","loading"])]),_:1})]),_:1})):j("",!0)]),_:1})]),_:1}),a(p,{cols:"12"},{default:s(()=>[a(ja,{"items-per-page":$e.value,"onUpdate:itemsPerPage":e[10]||(e[10]=l=>$e.value=l),"sort-by":be.value,"onUpdate:sortBy":e[11]||(e[11]=l=>be.value=l),"items-per-page-options":[10,20,50,100],items:U.value,headers:Ml,loading:re.value,"items-length":cl.value,page:qe.value,hover:"",density:"compact",class:"rounded-ts-lg rounded-te-lg","onUpdate:options":Ql},{item:s(({item:l,index:i})=>{var n,r;return[d("tr",{class:We({"odd-row":i%2===0,"even-row":i%2!==0})},[d("td",null,w((n=l.company)==null?void 0:n.name),1),d("td",null,[l.inquiryDate?(x(),E("div",Ka,[d("div",null,w(ha(l.inquiryDate)),1),d("div",Qa,[a(S,{size:"14",style:{"padding-bottom":"2px"}},{default:s(()=>e[57]||(e[57]=[c(" mdi-clock-outline ")])),_:1}),c(" "+w(_a(l.inquiryDate)),1)])])):j("",!0)]),d("td",null,w(l.source),1),d("td",null,w(l.inquiryPlace),1),d("td",null,[d("div",{class:"white-space-pre-wrap",innerHTML:ia(l.inquiryContent)},null,8,et)]),d("td",null,w(l.customerName),1),d("td",null,[a(Il,null,{activator:s(({props:u})=>[a(b,Ve(u,{color:wa(l.customerTitle),variant:"outlined",class:"px-2",size:"small",loading:el.value.has(l._id)}),{default:s(()=>[c(w(l.customerTitle||"選擇稱謂"),1)]),_:2},1040,["color","loading"])]),default:s(()=>[a(Dl,null,{default:s(()=>[(x(),E(oe,null,ve(pl,u=>a(Ie,{key:u,onClick:f=>ca(l._id,u)},{default:s(()=>[a(El,null,{default:s(()=>[c(w(u),1)]),_:2},1024)]),_:2},1032,["onClick"])),64))]),_:2},1024)]),_:2},1024)]),d("td",null,w(l.customerPhone),1),d("td",null,w(l.customerLineId),1),d("td",null,w(l.customerEmail),1),d("td",null,[a(Il,{"max-height":"320"},{activator:s(({props:u})=>[l.salesPerson?(x(),$(b,Ve({key:0},u,{color:"blue-darken-1",variant:"outlined",class:"px-2",size:"small",loading:Me.value.has(l._id)}),{default:s(()=>[c(w(Sl(l.salesPerson))+" "+w(l.salesPerson.nickname||l.salesPerson.name),1)]),_:2},1040,["loading"])):(x(),$(b,Ve({key:1},u,{color:"grey",variant:"outlined",class:"px-2",size:"small",loading:Me.value.has(l._id)}),{default:s(()=>e[58]||(e[58]=[c(" 選擇業務 ")])),_:2},1040,["loading"]))]),default:s(()=>[a(Dl,null,{default:s(()=>[(x(!0),E(oe,null,ve(te.value.get(l.company._id)||[],u=>(x(),$(Ie,{key:u._id,onClick:f=>ua(l._id,u._id)},{default:s(()=>[a(El,null,{default:s(()=>[c(w(Sl(u))+" "+w(u.nickname||u.name)+" ("+w(u.employeeCode)+")",1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)]),d("td",null,[l.inquiryResult?(x(),E("div",{key:0,class:We(["inquiry-result-text",Ca(l.inquiryResult)])},w(l.inquiryResult),3)):(x(),E("div",lt," 尚未選擇 "))]),d("td",null,[d("div",at,[d("div",tt,[(r=l.latestProgressNote)!=null&&r.content?(x(),E(oe,{key:0},[c(w(l.latestProgressNote.content)+" ",1),l.latestProgressNote?(x(),E("div",st,[a(S,{size:"14",style:{"padding-bottom":"2px"}},{default:s(()=>e[59]||(e[59]=[c(" mdi-clock-outline ")])),_:1}),e[60]||(e[60]=c()),d("span",null,w(Pl(l.latestProgressNote.createdAt)),1)])):j("",!0)],64)):(x(),E("div",ot," 【 尚未新增紀錄 】 "))]),pe((x(),$(b,{icon:"",color:"grey-darken-2",variant:"plain",size:"15",class:"ms-2",ripple:!1,onClick:u=>sa(l)},{default:s(()=>[a(S,null,{default:s(()=>e[61]||(e[61]=[c("mdi-history")])),_:1})]),_:2},1032,["onClick"])),[[fe,"查看紀錄","top"]])])]),d("td",nt,[a(b,{icon:"",color:"light-blue-darken-4",variant:"plain",size:"15",class:"mx-2",ripple:!1,onClick:u=>al(l)},{default:s(()=>[a(S,null,{default:s(()=>e[62]||(e[62]=[c("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),a(b,{icon:"",color:"red-lighten-1",variant:"plain",size:"15",class:"mx-2",ripple:!1,onClick:u=>aa(l)},{default:s(()=>[a(S,null,{default:s(()=>e[63]||(e[63]=[c("mdi-delete")])),_:1})]),_:2},1032,["onClick"])])],2)]}),_:1},8,["items-per-page","sort-by","items","loading","items-length","page"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(p,{cols:"12",class:"ps-lg-8 pe-lg-8 mb-6"})]),_:1}),a(ye,{modelValue:D.value.open,"onUpdate:modelValue":e[25]||(e[25]=l=>D.value.open=l),persistent:"",width:Ll.value},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[d("div",rt,[a(S,{size:"20",color:"white",class:"me-2"},{default:s(()=>e[64]||(e[64]=[c(" mdi-pencil ")])),_:1}),c(" "+w(D.value.id?"編輯詢問資料":"新增詢問")+" ",1),a(Z),a(b,{icon:"",color:"white",variant:"plain",class:"opacity-100",ripple:!1,size:"20",onClick:Se},{default:s(()=>[a(S,null,{default:s(()=>e[65]||(e[65]=[c("mdi-close")])),_:1})]),_:1})]),a(G,{class:"mt-6 mb-2 px-6"},{default:s(()=>[ue.value?(x(),E("div",it,[a(ql,{indeterminate:"",color:"deep-purple-darken-2",size:"64",width:"8"})])):(x(),$($l,{key:1,onSubmit:il(y(na),["prevent"])},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"12",class:"sub-title text-blue-grey-darken-2 d-flex align-center justify-center"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1}),a(p,{cols:"6",sm:"4",md:"2",class:"d-flex align-center justify-center"},{default:s(()=>[a(S,{size:"18",class:"me-2"},{default:s(()=>e[66]||(e[66]=[c(" mdi-account-details ")])),_:1}),e[67]||(e[67]=c(" 客戶資料 "))]),_:1}),a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1})]),_:1})]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(ne,{modelValue:y(Ue).value.value,"onUpdate:modelValue":e[12]||(e[12]=l=>y(Ue).value.value=l),"error-messages":y(Ue).errorMessage.value,label:"*客戶姓名",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(Q,{modelValue:y(Be).value.value,"onUpdate:modelValue":e[13]||(e[13]=l=>y(Be).value.value=l),"error-messages":y(Be).errorMessage.value,items:pl,label:"稱謂",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(ne,{modelValue:y(Ae).value.value,"onUpdate:modelValue":e[14]||(e[14]=l=>y(Ae).value.value=l),"error-messages":y(Ae).errorMessage.value,label:"客戶電話",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"6"},{default:s(()=>[a(ne,{modelValue:y(Fe).value.value,"onUpdate:modelValue":e[15]||(e[15]=l=>y(Fe).value.value=l),"error-messages":y(Fe).errorMessage.value,label:"Line ID",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"6"},{default:s(()=>[a(ne,{modelValue:y(Ze).value.value,"onUpdate:modelValue":e[16]||(e[16]=l=>y(Ze).value.value=l),"error-messages":y(Ze).errorMessage.value,label:"Email",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",class:"sub-title text-blue-grey-darken-2 d-flex align-center justify-center"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1}),a(p,{cols:"6",sm:"4",md:"2",class:"d-flex align-center justify-center"},{default:s(()=>[a(S,{size:"18",class:"me-2"},{default:s(()=>e[68]||(e[68]=[c(" mdi-card-account-details-outline ")])),_:1}),e[69]||(e[69]=c(" 基本資料 "))]),_:1}),a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1})]),_:1})]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(o,{modelValue:y(Te).value.value,"onUpdate:modelValue":e[17]||(e[17]=l=>y(Te).value.value=l),"error-messages":y(Te).errorMessage.value,label:"*日期",variant:"outlined",density:"compact",clearable:"","prepend-icon":"","ok-text":"確認","cancel-text":"取消"},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(Q,{modelValue:y(Oe).value.value,"onUpdate:modelValue":e[18]||(e[18]=l=>y(Oe).value.value=l),"error-messages":y(Oe).errorMessage.value,items:ie,label:"*來源","item-title":"text","item-value":"value",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(ge,{modelValue:y(je).value.value,"onUpdate:modelValue":e[19]||(e[19]=l=>y(je).value.value=l),"error-messages":y(je).errorMessage.value,items:Ye.value,label:"*地區",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages","items"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(Q,{modelValue:y(K).value.value,"onUpdate:modelValue":e[20]||(e[20]=l=>y(K).value.value=l),"error-messages":y(K).errorMessage.value,items:ke.value,"item-title":l=>l?`${l.name} (${l.companyId})`:"","item-value":"_id",label:"*公司",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages","items","item-title"])]),_:1}),a(p,{cols:"12",sm:"4"},{default:s(()=>[a(ge,{modelValue:y(Pe).value.value,"onUpdate:modelValue":e[21]||(e[21]=l=>y(Pe).value.value=l),"error-messages":y(Pe).errorMessage.value,items:de.value,"item-title":l=>l?`${l.name} (${l.nickname?l.nickname+" ":""}${l.employeeCode})`:"","item-value":"_id",label:"業務",variant:"outlined",density:"compact",clearable:"",disabled:!y(K).value.value,"hide-details":!!y(K).value.value,messages:y(K).value.value?[]:["請先選擇公司"]},null,8,["modelValue","error-messages","items","item-title","disabled","hide-details","messages"])]),_:1}),a(p,{cols:"12",class:"sub-title text-blue-grey-darken-2 d-flex align-center justify-center"},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1}),a(p,{cols:"6",sm:"4",md:"2",class:"d-flex align-center justify-center"},{default:s(()=>[a(S,{size:"18",class:"me-2"},{default:s(()=>e[70]||(e[70]=[c(" mdi-text-box ")])),_:1}),e[71]||(e[71]=c(" 詢問相關 "))]),_:1}),a(p,{cols:"3",sm:"4",md:"5",class:"d-flex align-center justify-center"},{default:s(()=>[a(J,{class:"border-opacity-25",color:"blue-grey-darken-2"})]),_:1})]),_:1})]),_:1}),a(p,{cols:"12"},{default:s(()=>[a(Ua,{modelValue:y(me).value.value,"onUpdate:modelValue":e[22]||(e[22]=l=>y(me).value.value=l),"error-messages":y(me).errorMessage.value,label:"詢問內容",variant:"outlined",density:"compact","auto-grow":"","hide-details":"",rows:"8"},null,8,["modelValue","error-messages"]),d("div",ut,[a(ne,{modelValue:ce.value,"onUpdate:modelValue":e[23]||(e[23]=l=>ce.value=l),label:"請輸入欲插入的網址",variant:"underlined",density:"compact",class:"me-2 mt-2","hide-details":"",clearable:"",onKeydown:e[24]||(e[24]=Da(il(()=>{},["prevent"]),["enter"]))},null,8,["modelValue"]),a(b,{color:"success",variant:"outlined",size:"small",disabled:!ce.value,onClick:ra},{default:s(()=>e[72]||(e[72]=[c(" 確認 ")])),_:1},8,["disabled"])])]),_:1})]),_:1}),a(De,{class:"px-0 mt-4"},{default:s(()=>[a(Z),a(b,{color:"grey-darken-1",variant:"outlined",class:"me-1",size:L.value,onClick:Se},{default:s(()=>e[73]||(e[73]=[c(" 取消 ")])),_:1},8,["size"]),a(b,{color:"teal-darken-1",variant:"outlined",type:"submit",class:"ms-1",size:L.value,loading:y(Bl)},{default:s(()=>[c(w(D.value.id?"修改":"新增"),1)]),_:1},8,["size","loading"])]),_:1})]),_:1},8,["onSubmit"]))]),_:1})]),_:1})]),_:1},8,["modelValue","width"]),a(ye,{modelValue:xe.value.open,"onUpdate:modelValue":e[26]||(e[26]=l=>xe.value.open=l),persistent:"","max-width":"720"},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[a(Ba,{class:"d-flex align-center px-6 py-1 mb-2 bg-blue-grey-darken-2"},{default:s(()=>[a(S,{size:"20",class:"me-2"},{default:s(()=>e[74]||(e[74]=[c(" mdi-history ")])),_:1}),e[76]||(e[76]=d("span",{class:"card-title text-white"},"進度 / 備註 - 歷史紀錄",-1)),a(Z),a(b,{icon:"",variant:"text",color:"white",onClick:oa},{default:s(()=>[a(S,{size:"20"},{default:s(()=>e[75]||(e[75]=[c(" mdi-close ")])),_:1})]),_:1})]),_:1}),a(G,{class:"px-6 py-7"},{default:s(()=>[ue.value?(x(),E("div",dt,[a(ql,{indeterminate:"",color:"deep-purple-darken-2",size:"64",width:"8"})])):(x(),E("div",ct,[a(Aa,{headers:Ol,items:Hl.value,class:"elevation-0 rounded-sm progress-notes-table",density:"compact","sort-by":[{key:"createdAt",order:"desc"}]},{item:s(({item:l,index:i})=>[d("tr",{class:We({"odd-row":i%2===0,"even-row":i%2!==0})},[d("td",null,w(l.content),1),d("td",null,w(Pl(l.createdAt)),1)],2)]),_:1},8,["items"])]))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Na,{modelValue:le.value.open,"onUpdate:modelValue":e[27]||(e[27]=l=>le.value.open=l),title:"確認刪除詢問",message:`確定要刪除客戶「<span class='text-pink-lighten-1' style='font-weight: 800;'>${le.value.customerName}</span>」的詢問記錄嗎？此操作無法復原。`,"expected-name":le.value.customerName,"input-label":"客戶姓名",onConfirm:ta},null,8,["modelValue","message","expected-name"]),a(ye,{modelValue:ze.value.open,"onUpdate:modelValue":e[29]||(e[29]=l=>ze.value.open=l),persistent:"","max-width":"1374"},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[d("div",mt,[a(S,{size:"20",color:"white",class:"me-2"},{default:s(()=>e[77]||(e[77]=[c(" mdi-account-cog ")])),_:1}),e[79]||(e[79]=c(" 業務管理 ")),a(Z),a(b,{icon:"",color:"white",variant:"plain",class:"opacity-100",ripple:!1,size:"20",onClick:ol},{default:s(()=>[a(S,null,{default:s(()=>e[78]||(e[78]=[c("mdi-close")])),_:1})]),_:1})]),a(G,{class:"mt-6 mb-4 px-6"},{default:s(()=>[d("div",null,[a(ge,{modelValue:_e.value,"onUpdate:modelValue":[e[28]||(e[28]=l=>_e.value=l),ma],items:Al.value,"item-title":l=>{var i;return l?`${l.name} (${l.nickname?l.nickname+" ":""}${l.employeeCode||""}) - ${((i=l.company)==null?void 0:i.name)||""}`:""},"item-value":"_id",label:"選擇業務",variant:"outlined",density:"compact","hide-details":"",loading:he.value,clearable:"","onUpdate:search":kl},{item:s(({item:l,props:i})=>[a(Ie,Ve(i,{disabled:M.value.includes(l.value)}),{prepend:s(()=>[M.value.includes(l.value)?(x(),$(S,{key:0,color:"teal-lighten-1",icon:"mdi-check-circle"})):j("",!0)]),_:2},1040,["disabled"])]),_:1},8,["modelValue","items","item-title","loading"])]),d("div",pt,[e[86]||(e[86]=d("div",{class:"sub-title mb-5"}," 已選擇的業務： ",-1)),(x(!0),E(oe,null,ve(fl.value,(l,i)=>(x(),E("div",{key:i,class:"mb-6"},[d("div",vt," 【 "+w(i)+" 】 ",1),d("div",gt,[(x(!0),E(oe,null,ve(l,(n,r)=>(x(),$(Y,{key:n._id,class:"mb-2 me-3 sales-person-card",elevation:"0",width:"252"},{default:s(()=>[a(G,{class:"pa-2"},{default:s(()=>[d("div",ft,[d("div",null,[d("div",yt,[d("div",bt,w(r+1),1),c(" "+w(n.name)+" ( ",1),d("span",{class:We(["px-1",n.nickname?"text-deep-purple-darken-2":"text-grey-darken-1"])},w(n.nickname||"無"),3),e[80]||(e[80]=c(" ) "))]),d("div",kt,[a(S,{icon:"mdi-chat-processing-outline",size:"14",class:"me-1"}),e[82]||(e[82]=c(" Line： ")),n.lineID?(x(),E("span",{key:0,class:"line-id-text",onClick:u=>Sa(n.lineID)},w(n.lineID),9,xt)):(x(),E("span",ht,"尚未填寫")),n.lineLink?pe((x(),$(b,{key:2,icon:"",variant:"text",color:"teal-darken-1",size:"18",class:"ms-2",ripple:!1,onClick:u=>Pa(n.lineLink)},{default:s(()=>[a(S,{size:"14"},{default:s(()=>e[81]||(e[81]=[c(" mdi-content-copy ")])),_:1})]),_:2},1032,["onClick"])),[[fe,"複製 Line 連結"]]):j("",!0)])]),d("div",_t,[d("div",wt,[r>0?(x(),$(b,{key:0,icon:"",variant:"text",color:"grey-darken-1",size:"18",ripple:!1,onClick:u=>xl(i,r,"up")},{default:s(()=>[a(S,{size:"18"},{default:s(()=>e[83]||(e[83]=[c(" mdi-chevron-up ")])),_:1})]),_:2},1032,["onClick"])):j("",!0),r<l.length-1?(x(),$(b,{key:1,icon:"",variant:"text",color:"grey-darken-1",size:"18",ripple:!1,onClick:u=>xl(i,r,"down")},{default:s(()=>[a(S,{size:"18"},{default:s(()=>e[84]||(e[84]=[c(" mdi-chevron-down ")])),_:1})]),_:2},1032,["onClick"])):j("",!0)]),a(b,{icon:"",variant:"text",color:"red-lighten-1",size:"20",onClick:u=>pa(n._id)},{default:s(()=>[a(S,{size:"18"},{default:s(()=>e[85]||(e[85]=[c(" mdi-close ")])),_:1})]),_:2},1032,["onClick"])])])]),_:2},1024)]),_:2},1024))),128))])]))),128))])]),_:1}),a(De,{class:"px-7 mb-4"},{default:s(()=>[a(Z),a(b,{color:"grey-darken-1",variant:"outlined",class:"me-1",size:L.value,onClick:ol},{default:s(()=>e[87]||(e[87]=[c(" 取消 ")])),_:1},8,["size"]),a(b,{color:"teal-darken-1",variant:"outlined",class:"ms-1",size:L.value,loading:Je.value,onClick:va},{default:s(()=>e[88]||(e[88]=[c(" 儲存 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ye,{modelValue:Re.value.open,"onUpdate:modelValue":e[31]||(e[31]=l=>Re.value.open=l),persistent:"","max-width":"1374"},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[d("div",Pt,[a(S,{size:"20",color:"white",class:"me-2"},{default:s(()=>e[89]||(e[89]=[c(" mdi-account-tie ")])),_:1}),e[91]||(e[91]=c(" 業務主管管理 ")),a(Z),a(b,{icon:"",color:"white",variant:"plain",class:"opacity-100",ripple:!1,size:"20",onClick:nl},{default:s(()=>[a(S,null,{default:s(()=>e[90]||(e[90]=[c("mdi-close")])),_:1})]),_:1})]),a(G,{class:"mt-6 mb-4 px-6"},{default:s(()=>[d("div",null,[a(ge,{modelValue:we.value,"onUpdate:modelValue":[e[30]||(e[30]=l=>we.value=l),ga],items:Fl.value,"item-title":l=>{var i;return l?`${l.name} (${l.nickname?l.nickname+" ":""}${l.employeeCode||""}) - ${((i=l.company)==null?void 0:i.name)||""}`:""},"item-value":"_id",label:"選擇業務主管",variant:"outlined",density:"compact","hide-details":"",loading:Le.value,clearable:"","onUpdate:search":_l},{item:s(({item:l,props:i})=>[a(Ie,Ve(i,{disabled:T.value.includes(l.value)}),{prepend:s(()=>[T.value.includes(l.value)?(x(),$(S,{key:0,color:"teal-lighten-1",icon:"mdi-check-circle"})):j("",!0)]),_:2},1040,["disabled"])]),_:1},8,["modelValue","items","item-title","loading"])]),d("div",St,[e[94]||(e[94]=d("div",{class:"sub-title mb-5 ps-1"}," 已選擇的業務主管： ",-1)),(x(!0),E(oe,null,ve(Zl.value,(l,i)=>(x(),E("div",{key:i,class:"mb-6"},[d("div",Ct," 【 "+w(i)+" 】 ",1),d("div",Vt,[(x(!0),E(oe,null,ve(l,n=>(x(),$(Y,{key:n._id,class:"mb-2 me-3 sales-person-card",elevation:"0",width:"252"},{default:s(()=>[a(G,{class:"pa-2"},{default:s(()=>[d("div",It,[d("div",null,[d("div",Dt,[a(S,{icon:"mdi-account-tie",size:"16",class:"me-2",color:"deep-purple-darken-2"}),c(" "+w(n.name)+" ( ",1),d("span",Et,w(n.employeeCode),1),e[92]||(e[92]=c(" ) "))])]),a(b,{icon:"",size:"small",color:"red-lighten-1",variant:"text",onClick:r=>fa(n._id)},{default:s(()=>[a(S,null,{default:s(()=>e[93]||(e[93]=[c("mdi-close")])),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))),128))])]))),128))])]),_:1}),a(De,{class:"px-7 mb-4"},{default:s(()=>[a(Z),a(b,{color:"grey-darken-1",variant:"outlined",class:"me-1",size:L.value,onClick:nl},{default:s(()=>e[95]||(e[95]=[c(" 取消 ")])),_:1},8,["size"]),a(b,{color:"teal-darken-1",variant:"outlined",class:"ms-1",size:L.value,loading:Ke.value,onClick:ya},{default:s(()=>e[96]||(e[96]=[c(" 儲存 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ye,{modelValue:m.value.open,"onUpdate:modelValue":e[37]||(e[37]=l=>m.value.open=l),persistent:"","max-width":"340"},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[d("div",qt,[d("div",null,[a(S,{size:"20",class:"me-2"},{default:s(()=>e[97]||(e[97]=[c(" mdi-microsoft-excel ")])),_:1}),e[98]||(e[98]=c("匯出 Excel "))]),a(b,{icon:"",variant:"plain",size:"36",class:"opacity-100",ripple:!1,onClick:rl},{default:s(()=>[a(S,{size:"20"},{default:s(()=>e[99]||(e[99]=[c(" mdi-close ")])),_:1})]),_:1})]),a(G,{class:"px-6 py-3"},{default:s(()=>[a($l,{onSubmit:il(xa,["prevent"])},{default:s(()=>[a(R,null,{default:s(()=>[a(p,{cols:"12",class:"pb-0 px-1"},{default:s(()=>[a(Fa,{modelValue:m.value.type,"onUpdate:modelValue":e[32]||(e[32]=l=>m.value.type=l),"hide-details":"",class:"mb-3"},{default:s(()=>[a(zl,{label:"所有公司資料",value:"all",color:"teal-darken-1"}),a(zl,{label:"單一公司資料",value:"company",color:"teal-darken-1"})]),_:1},8,["modelValue"])]),_:1}),m.value.type==="company"?(x(),$(p,{key:0,cols:"12",class:"px-3 pb-0"},{default:s(()=>[a(Q,{modelValue:m.value.company,"onUpdate:modelValue":e[33]||(e[33]=l=>m.value.company=l),items:ke.value,"item-title":l=>l?`${l.name} (${l.companyId})`:"","item-value":"_id",label:"公司",variant:"outlined",density:"compact","error-messages":m.value.companyError,clearable:""},null,8,["modelValue","items","item-title","error-messages"])]),_:1})):j("",!0),a(p,{cols:"12",class:"px-3 pb-0"},{default:s(()=>[a(o,{modelValue:m.value.dateRange,"onUpdate:modelValue":[e[34]||(e[34]=l=>m.value.dateRange=l),e[35]||(e[35]=l=>{m.value.dateError="",m.value.dateRange=l})],label:"日期區間",variant:"outlined",density:"compact","prepend-icon":"","error-messages":m.value.dateError,clearable:"",multiple:"range","cancel-text":"取消","ok-text":"確認"},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",class:"px-3 pb-0"},{default:s(()=>[a(Q,{modelValue:m.value.sources,"onUpdate:modelValue":e[36]||(e[36]=l=>m.value.sources=l),items:ie,"item-title":"text","item-value":"value",label:"來源",variant:"outlined",density:"compact","error-messages":m.value.sourceError,clearable:"",multiple:""},{"prepend-item":s(()=>[a(Ie,{title:"全選",color:"deep-purple-darken-2","prepend-icon":"mdi-checkbox-multiple-marked",active:m.value.sources.length===ie.length,onClick:ba},null,8,["active"]),a(J,{class:"mt-2"})]),selection:s(({item:l,index:i})=>[i===0?(x(),E("span",$t,w(l.raw.text),1)):i===1?(x(),E("span",zt,"...")):j("",!0)]),_:1},8,["modelValue","error-messages"])]),_:1})]),_:1}),a(De,{class:"px-0 pt-4 pb-0 pb-sm-2 mb-2"},{default:s(()=>[a(Z),a(b,{color:"grey",variant:"outlined",class:"me-1",size:L.value,onClick:rl},{default:s(()=>e[100]||(e[100]=[c(" 取消 ")])),_:1},8,["size"]),a(b,{color:"teal-darken-1",variant:"outlined",type:"submit",size:L.value,loading:Qe.value},{default:s(()=>e[101]||(e[101]=[c(" 匯出 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ye,{modelValue:q.value.open,"onUpdate:modelValue":e[38]||(e[38]=l=>q.value.open=l),persistent:"","max-width":"340"},{default:s(()=>[a(Y,{class:"rounded-lg"},{default:s(()=>[d("div",Nt,[d("div",null,[a(S,{size:"20",class:"me-2"},{default:s(()=>e[102]||(e[102]=[c(" mdi-check-circle ")])),_:1}),e[103]||(e[103]=c("確認業務指派 "))]),a(b,{icon:"",variant:"text",size:"40",onClick:sl},{default:s(()=>[a(S,{size:"20"},{default:s(()=>e[104]||(e[104]=[c(" mdi-close ")])),_:1})]),_:1})]),a(G,{class:"px-6 py-3"},{default:s(()=>[d("div",Rt,[d("div",null,[d("div",Lt," 被指派的業務："+w(q.value.salesPersonName),1),e[105]||(e[105]=d("div",{class:"text-grey-darken-2"}," 請確認指派業務是否正確，確認後會發送Email給被指派的業務。 ",-1))])])]),_:1}),a(De,{class:"px-6 py-4 mb-2"},{default:s(()=>[a(Z),a(b,{color:"grey",variant:"outlined",class:"me-1",disabled:q.value.isLoading,onClick:sl},{default:s(()=>e[106]||(e[106]=[c(" 取消 ")])),_:1},8,["disabled"]),a(b,{color:"teal-darken-1",variant:"outlined",loading:q.value.isLoading,disabled:q.value.isLoading,onClick:da},{default:s(()=>e[107]||(e[107]=[c(" 確認 ")])),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}};typeof Vl=="function"&&Vl(Nl);const cs=qa(Nl,[["__scopeId","data-v-2de8a4a8"]]);export{cs as default};

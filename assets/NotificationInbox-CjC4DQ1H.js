import{r as M,f as g,w as H,k as G,aV as f,Z as q,bH as i,a8 as r,aG as J,a7 as m,bf as w,a0 as d,_ as V,$ as v,F as O,b0 as W,aH as Z,bM as I}from"./@vue-Cr_z6yfx.js";import{u as K}from"./vue-router-CS4OewbW.js";import{d as Q}from"./pinia-DBRIaiZ_.js";import{b as X,_ as Y}from"./index-ZcDhEpUM.js";import{q as ee,g as b,I as te,r as N,a as ae,b as se,F as oe,A as L,c as ne,J as re,e as ie,f as le,C as ce}from"./vuetify-CbddcmEc.js";const de=Q("notification",()=>{const n=M([]),c=M(0),k=M(!1),{apiAuth:l}=X(),j=async(a={})=>{try{k.value=!0;const{data:s}=await l.get("/notifications",{params:a});if(s.success)return n.value=s.data.notifications,c.value=s.data.unreadCount,s.data}catch(s){throw console.error("取得通知失敗:",s),s}finally{k.value=!1}},y=async()=>{try{const{data:a}=await l.get("/notifications/unread-count");if(a.success)return c.value=a.data.unreadCount,a.data.unreadCount}catch(a){throw console.error("取得未讀數量失敗:",a),a}},R=async a=>{try{const{data:s}=await l.put(`/notifications/${a}/read`);if(s.success){const u=n.value.find(_=>_._id===a);return u&&(u.isRead=!0,u.readAt=new Date,c.value=Math.max(0,c.value-1)),s.data}}catch(s){throw console.error("標記通知為已讀失敗:",s),s}},h=async()=>{try{const{data:a}=await l.put("/notifications/mark-all-read");if(a.success)return n.value.forEach(s=>{s.isRead=!0,s.readAt=new Date}),c.value=0,a}catch(a){throw console.error("標記所有通知為已讀失敗:",a),a}},p=async a=>{try{const{data:s}=await l.delete(`/notifications/${a}`);if(s.success){const u=n.value.findIndex(_=>_._id===a);if(u>-1){const _=n.value[u];n.value.splice(u,1),_.isRead||(c.value=Math.max(0,c.value-1))}return s}}catch(s){throw console.error("刪除通知失敗:",s),s}},C=a=>{n.value.unshift(a),a.isRead||c.value++},A=(a,s)=>{const u=n.value.find(_=>_._id===a);u&&Object.assign(u,s)},T=()=>{n.value=[],c.value=0},z=g(()=>n.value.filter(a=>!a.isRead)),S=g(()=>n.value.filter(a=>a.isRead)),$=g(()=>{const a={};return n.value.forEach(s=>{a[s.type]||(a[s.type]=[]),a[s.type].push(s)}),a});return{notifications:n,unreadCount:c,isLoading:k,unreadNotifications:z,readNotifications:S,notificationsByType:$,fetchNotifications:j,fetchUnreadCount:y,markAsRead:R,markAllAsRead:h,deleteNotification:p,addNotification:C,updateNotification:A,clearNotifications:T}}),ue={class:"d-flex align-center"},fe={class:"d-flex align-center"},me={key:0,class:"pa-4 text-center"},pe={key:1,class:"pa-4 text-center text-grey"},_e={key:2,class:"notification-list"},ke=["onClick"],ve={class:"d-flex align-start pa-3"},ge={class:"notification-icon me-3"},ye={class:"notification-content flex-grow-1"},he={class:"notification-title mb-3"},xe=["onClick"],we={key:1,class:"project-name"},Ce={key:2,class:"project-name"},be={class:"notification-text text-grey-darken-1 mb-3"},Ne={class:"d-flex align-center justify-space-between"},Re={class:"d-flex align-center"},Ve={class:"text-caption text-grey"},Ae={class:"notification-actions d-flex align-center"},Me={__name:"NotificationInbox",props:{filterType:{type:String,default:null,validator:n=>n===null||n==="task"||n==="non-task"},buttonColor:{type:String,default:"white"},outlineIcon:{type:Boolean,default:!1}},setup(n){const c=n,k=K(),l=de(),{smAndUp:j}=ee(),y=M(!1),R=["task_due_reminder","task_mention","task_assignment","task_unassignment","task_collaborator_added","task_collaborator_removed","task_completion","task_reopen"],h=g(()=>l.notifications),p=g(()=>c.filterType?c.filterType==="task"?h.value.filter(e=>{if(!e||!e.type)return!1;const t=String(e.type).trim();return R.includes(t)}):c.filterType==="non-task"?h.value.filter(e=>{if(!e||!e.type)return!1;const t=String(e.type).trim();return!R.includes(t)}):h.value:h.value),C=g(()=>p.value.length>0||h.value.length>0?p.value.filter(e=>!e.isRead).length:l.unreadCount),A=g(()=>l.isLoading),T=g(()=>j.value?"default":"small"),z=e=>({task_due_reminder:"mdi-clock-alert",task_mention:"mdi-at",task_assignment:"mdi-account-plus",task_unassignment:"mdi-account-minus",task_collaborator_added:"mdi-account-multiple-plus",task_collaborator_removed:"mdi-account-multiple-minus",task_completion:"mdi-check-circle",task_reopen:"mdi-restart",sales_person_assignment:"mdi-account-arrow-right",marketing_design_request:"mdi-palette",marketing_design_request_assignment:"mdi-palette-outline"})[e]||"mdi-bell",S=e=>({task_due_reminder:"orange-darken-1",task_mention:"blue",task_assignment:"teal-darken-1",task_unassignment:"red",task_collaborator_added:"teal-darken-1",task_collaborator_removed:"red-darken-1",task_completion:"teal-darken-1",task_reopen:"blue-darken-1",sales_person_assignment:"orange-darken-2",marketing_design_request:"purple-darken-2",marketing_design_request_assignment:"blue-darken-2"})[e]||"grey",$=e=>{const t=new Date(e),x=new Date-t,D=Math.floor(x/6e4),B=Math.floor(x/36e5),P=Math.floor(x/864e5);return D<1?"剛剛":D<60?`${D} 分鐘前`:B<24?`${B} 小時前`:P<7?`${P} 天前`:t.toLocaleDateString("zh-TW")},a=async e=>{e.isRead||await u(e._id),e.task||e.project?k.push(`/projectAndTaskManagement/projects/${e.project._id}`):e.customerInquiry?k.push("/B2CStatisticsManagement"):e.designRequest&&k.push("/marketingDesignRequestManagement"),y.value=!1},s=e=>{k.push(`/projectAndTaskManagement/projects/${e._id}`),y.value=!1},u=async e=>{try{await l.markAsRead(e)}catch(t){console.error("標記通知為已讀失敗:",t)}},_=async()=>{try{const t=p.value.filter(o=>!o.isRead).map(o=>l.markAsRead(o._id));await Promise.all(t)}catch(e){console.error("標記所有通知為已讀失敗:",e)}},U=async e=>{try{await l.deleteNotification(e)}catch(t){console.error("刪除通知失敗:",t)}},E=async()=>{try{const e=p.value.map(t=>l.deleteNotification(t._id));await Promise.all(e)}catch(e){console.error("全部刪除通知失敗:",e)}},F=async()=>{try{await l.fetchNotifications()}catch(e){console.error("重新整理通知失敗:",e)}};return H(y,async e=>{if(e)try{await l.fetchNotifications()}catch(t){console.error("載入通知失敗:",t)}}),G(async()=>{try{await l.fetchUnreadCount();const e={};c.filterType==="task"?e.types=R.join(","):c.filterType,await l.fetchNotifications(e)}catch(e){console.error("載入通知失敗:",e)}}),(e,t)=>(f(),q(ce,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=o=>y.value=o),"close-on-content-click":!1,location:"bottom end",offset:"8",width:"400"},{activator:i(({props:o})=>[r(b,J(o,{icon:"",color:n.buttonColor,size:T.value,class:"me-4 me-sm-2",ripple:!1,flat:""}),{default:i(()=>[r(te,{content:C.value,"model-value":C.value>0,color:"red-lighten-1",max:99,class:"notification-badge"},{default:i(()=>[r(N,null,{default:i(()=>[m(w(n.outlineIcon?"mdi-email-outline":"mdi-email"),1)]),_:1})]),_:1},8,["content","model-value"])]),_:2},1040,["color","size"])]),default:i(()=>[r(ae,null,{default:i(()=>[r(se,{class:"d-flex align-center justify-space-between px-4 py-3"},{default:i(()=>[d("div",ue,[r(N,{class:"me-2",size:"24",color:"grey-darken-3"},{default:i(()=>t[1]||(t[1]=[m(" mdi-email ")])),_:1}),t[2]||(t[2]=d("span",{class:"card-title text-grey-darken-3"},"收件匣",-1)),C.value>0?(f(),q(oe,{key:0,color:"red",size:"small",class:"ms-2"},{default:i(()=>[m(w(C.value)+" 未讀 ",1)]),_:1})):V("",!0)]),d("div",fe,[r(b,{icon:"mdi-refresh",size:"small",color:"grey-darken-3",variant:"text",loading:A.value,onClick:F},null,8,["loading"])])]),_:1}),r(L),r(ne,{class:"pa-0"},{default:i(()=>[A.value&&p.value.length===0?(f(),v("div",me,[r(re,{indeterminate:""}),t[3]||(t[3]=d("div",{class:"mt-2"}," 載入中... ",-1))])):p.value.length===0?(f(),v("div",pe,[r(N,{size:"48",class:"mb-2"},{default:i(()=>t[4]||(t[4]=[m(" mdi-email-outline ")])),_:1}),t[5]||(t[5]=d("div",null,"目前沒有通知",-1))])):(f(),v("div",_e,[(f(!0),v(O,null,W(p.value,o=>(f(),v("div",{key:o._id,class:Z(["notification-item",{unread:!o.isRead,read:o.isRead}]),onClick:x=>a(o)},[d("div",ve,[d("div",ge,[r(N,{color:S(o.type),size:"20"},{default:i(()=>[m(w(z(o.type)),1)]),_:2},1032,["color"])]),d("div",ye,[d("div",he,[m(w(o.title)+" ",1),o.project?(f(),v("div",{key:0,class:"project-name",onClick:I(x=>s(o.project),["stop"])},w(o.project.name),9,xe)):V("",!0),o.customerInquiry?(f(),v("div",we," 直客詢問 ")):V("",!0),o.designRequest?(f(),v("div",Ce," 行銷美編需求申請 ")):V("",!0)]),d("div",be,w(o.content),1),d("div",Ne,[d("div",Re,[d("span",Ve,w($(o.createdAt)),1)]),d("div",Ae,[r(b,{icon:"",color:"red-lighten-1",class:"me-1",size:"24",variant:"text",onClick:I(x=>U(o._id),["stop"])},{default:i(()=>[r(N,{size:"18"},{default:i(()=>t[6]||(t[6]=[m(" mdi-trash-can-outline ")])),_:1})]),_:2},1032,["onClick"]),o.isRead?V("",!0):(f(),q(b,{key:0,icon:"",color:"teal-lighten-1",size:"24",variant:"text",onClick:I(x=>u(o._id),["stop"])},{default:i(()=>[r(N,{size:"18"},{default:i(()=>t[7]||(t[7]=[m(" mdi-check ")])),_:1})]),_:2},1032,["onClick"]))])])])])],10,ke))),128))]))]),_:1}),r(L),r(ie,{class:"px-3"},{default:i(()=>[r(b,{variant:"text",size:"small",color:"red-lighten-1",onClick:E},{default:i(()=>t[8]||(t[8]=[m(" 全部刪除 ")])),_:1}),r(le),r(b,{variant:"text",color:"grey-darken-2",size:"small",onClick:_},{default:i(()=>t[9]||(t[9]=[m(" 全部已讀 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},De=Y(Me,[["__scopeId","data-v-9c184a9b"]]);export{De as N};

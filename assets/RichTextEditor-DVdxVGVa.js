import{Q as W}from"./quill-CgyjECRE.js";import{_ as $,b as G}from"./index-mGnb0KKF.js";import{i as j}from"./vuetify-use-dialog-C5oZ13xz.js";import{r as Q,f as U,w as H,k as z,aS as K,aV as J,$ as X,a0 as Y,aJ as Z,n as I}from"./@vue-Cr_z6yfx.js";const h="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",ee={__name:"RichTextEditor",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:"請輸入內容..."},readonly:{type:Boolean,default:!1},height:{type:[Number,String],default:150}},emits:["update:modelValue"],setup(M,{expose:C,emit:_}){const{apiAuth:V}=G(),S=j(),b=M,L=_,A=Q(null);let e=null,w=null,x=null,E=null;const B=U(()=>{const r=b.height;return typeof r=="number"?`${r}px`:r}),D={theme:"snow",placeholder:b.placeholder,readOnly:b.readonly,modules:{toolbar:{container:[[{header:[1,2,3,!1]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],["link","image"],["clean"]],handlers:{image:F}}}};function T(){return`placeholder-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function R(r,t){if(!e)return!1;try{const i=e.root.querySelectorAll("img");for(let a=0;a<i.length;a++){const o=i[a];if(o.dataset.placeholderId===r){o.src=t,delete o.dataset.placeholderId,delete o.dataset.uploading;const l=e.root.innerHTML;return L("update:modelValue",l),!0}}for(let a=0;a<i.length;a++){const o=i[a];if(o.src===h&&(o.dataset.uploading==="true"||!o.dataset.placeholderId)){o.src=t,delete o.dataset.placeholderId,delete o.dataset.uploading;const l=e.root.innerHTML;return L("update:modelValue",l),!0}}return!1}catch(n){return console.error("替換佔位符失敗:",n),!1}}function q(r){var t;if(!e)return!1;try{const i=e.root.querySelectorAll("img");for(let a=0;a<i.length;a++){const o=i[a];if((o.dataset.placeholderId===r||o.dataset.uploading==="true")&&o.src===h){(t=o.parentNode)==null||t.removeChild(o);const l=e.root.innerHTML;return L("update:modelValue",l),!0}}return!1}catch(n){return console.error("移除佔位符失敗:",n),!1}}async function P(r,t){var a,o,l,c;if(!e)return;const n=5*1024*1024;if(r.size>n){S({text:"圖片檔案太大，請選擇小於 5MB 的圖片",snackbarProps:{color:"error"}}),q(t);return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type)){S({text:"圖片格式錯誤，僅支援 JPG、PNG、GIF、WEBP 格式",snackbarProps:{color:"error"}}),q(t);return}try{const d=new FormData;d.append("image",r);const{data:s}=await V.post("/tasks/description-image",d,{headers:{"Content-Type":"multipart/form-data"}});if(s.success&&((a=s.data)!=null&&a.url)){let g=s.data.url;if(g.startsWith("/")&&(g=`https://eip.ystravel.com.tw/TEST-Backend/api/${g}`),!R(t,g)){const f=e.root.querySelectorAll("img");for(let u=f.length-1;u>=0;u--){const m=f[u];if(m.dataset.placeholderId===t||m.src===h&&m.dataset.uploading==="true"){const k=e.getSelection(),y=k?k.index:e.getLength();e.insertEmbed(y,"image",g),e.setSelection(y+1),(o=m.parentNode)==null||o.removeChild(m);const O=e.root.innerHTML;L("update:modelValue",O);break}}}}else q(t),S({text:s.message||"圖片上傳失敗",snackbarProps:{color:"error"}})}catch(d){console.error("圖片上傳失敗:",d),q(t),S({text:((c=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:c.message)||"圖片上傳失敗",snackbarProps:{color:"error"}})}}function F(){if(!e){console.error("Quill 編輯器尚未初始化");return}const r=document.createElement("input");r.setAttribute("type","file"),r.setAttribute("accept","image/*"),r.click(),r.onchange=async()=>{const t=r.files[0];if(!t)return;const n=e.getSelection(),i=n?n.index:e.getLength(),a=T();e.insertEmbed(i,"image",h),e.setSelection(i+1),await I(),await new Promise(o=>{requestAnimationFrame(()=>{const c=e.root.querySelectorAll("img");for(let d=c.length-1;d>=0;d--){const s=c[d];if(s.src===h&&!s.dataset.placeholderId){s.dataset.placeholderId=a,s.dataset.uploading="true";break}}o()})}),await P(t,a)}}const N=async()=>{if(await I(),A.value&&!e){e=new W(A.value,D),b.modelValue&&(e.root.innerHTML=b.modelValue),e.on("text-change",()=>{const t=e.root.innerHTML;L("update:modelValue",t)});const r=()=>{const t=e.root,n=e.getText().trim(),i=t.innerHTML.trim();return n!==""||i!==""&&i!=="<p><br></p>"&&i!=="<p></p>"};e.root.addEventListener("focus",()=>{const t=e.root;t.classList.contains("ql-blank")&&t.classList.remove("ql-blank")}),e.root.addEventListener("blur",()=>{const t=e.root;r()||t.classList.add("ql-blank")}),e.root.addEventListener("compositionstart",()=>{const t=e.root;t.classList.contains("ql-blank")&&t.classList.remove("ql-blank")}),e.root.addEventListener("compositionend",()=>{const t=e.root;r()||t.classList.add("ql-blank")}),e.root.addEventListener("keydown",t=>{if(t.key.length===1&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const n=e.root;n.classList.contains("ql-blank")&&n.classList.remove("ql-blank")}}),e.on("text-change",()=>{const t=e.root;r()?t.classList.contains("ql-blank")&&t.classList.remove("ql-blank"):t.classList.contains("ql-blank")||t.classList.add("ql-blank")}),E=async t=>{const n=t.clipboardData||window.clipboardData;if(!n)return;const i=n.items;if(!i)return;let a=!1;const o=[];for(let l=0;l<i.length;l++){const c=i[l];c.type.indexOf("image")!==-1&&(a=!0,o.push(c))}if(a){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const l=e.root.querySelectorAll("img").length;for(let c=0;c<o.length;c++){const s=o[c].getAsFile();if(!s)continue;const g=e.getSelection(),v=g?g.index:e.getLength(),p=T();e.insertEmbed(v,"image",h),e.setSelection(v+1),await I(),await new Promise(f=>{requestAnimationFrame(()=>{const m=e.root.querySelectorAll("img");for(let k=m.length-1;k>=0;k--){const y=m[k];if(y.src===h&&!y.dataset.placeholderId){y.dataset.placeholderId=p,y.dataset.uploading="true";break}}f()})}),await P(s,p)}await I(),await new Promise(c=>{setTimeout(()=>{var p;const s=e.root.querySelectorAll("img"),g=s.length,v=l+o.length;if(g>v){for(let u=s.length-1;u>=0;u--){const m=s[u];m.src===h||m.dataset.placeholderId||m.dataset.uploading||(m.src.startsWith("data:")||m.src.startsWith("blob:"))&&((p=m.parentNode)==null||p.removeChild(m))}const f=e.root.innerHTML;L("update:modelValue",f)}c()},100)})}},A.value&&A.value.addEventListener("paste",E,!0),w=async t=>{var a;const n=(a=t.dataTransfer)==null?void 0:a.files;if(!n||n.length===0)return;const i=Array.from(n).filter(o=>o.type.startsWith("image/"));if(i.length>0){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(let o=0;o<i.length;o++){const l=i[o],c=e.getSelection(),d=c?c.index:e.getLength(),s=T();e.insertEmbed(d,"image",h),e.setSelection(d+1),await I(),await new Promise(g=>{requestAnimationFrame(()=>{const p=e.root.querySelectorAll("img");for(let f=p.length-1;f>=0;f--){const u=p[f];if(u.src===h&&!u.dataset.placeholderId){u.dataset.placeholderId=s,u.dataset.uploading="true";break}}g()})}),await P(l,s)}}},e.root.addEventListener("drop",w,!0),x=t=>{var i;const n=(i=t.dataTransfer)==null?void 0:i.items;if(n){for(let a=0;a<n.length;a++)if(n[a].type.startsWith("image/")){t.preventDefault(),t.stopPropagation();return}}},e.root.addEventListener("dragover",x,!0)}};return H(()=>b.modelValue,r=>{e&&e.root.innerHTML!==r&&(e.root.innerHTML=r||"")}),H(()=>b.readonly,r=>{e&&e.enable(!r)}),z(()=>{N()}),K(()=>{e&&(w&&(e.root.removeEventListener("drop",w,!0),w=null),x&&(e.root.removeEventListener("dragover",x,!0),x=null),e=null),E&&A.value&&(A.value.removeEventListener("paste",E,!0),E=null)}),C({getContent:()=>e?e.root.innerHTML:"",setContent:r=>{e&&(e.root.innerHTML=r||"")},focus:()=>{e&&e.focus()}}),(r,t)=>(J(),X("div",{class:"rich-text-editor",style:Z({"--editor-height":B.value})},[Y("div",{ref_key:"editorContainer",ref:A,class:"editor-container"},null,512)],4))}},ne=$(ee,[["__scopeId","data-v-546714e5"]]);export{ne as R};

import{r as p,f as ke,w as we,k as Ge,aS as Pe,aV as n,$ as f,a8 as r,Z as E,aJ as qe,bH as o,F as le,b0 as ge,aH as pe,a7 as _,bf as V,_ as C,T as Lt,n as Ie,a0 as l,bM as _e,bK as $e,b2 as Et,aI as Ft,ao as At,u as Re,aG as Ne}from"./@vue-Cr_z6yfx.js";import{u as Pt}from"./vue-router-CS4OewbW.js";import{_ as Se,u as Tt,b as Bt}from"./index-mGnb0KKF.js";import{i as jt}from"./vuetify-use-dialog-C5oZ13xz.js";import{_ as ce}from"./UserAvatar-CwvpGxzs.js";import{R as Rt}from"./RichTextEditor-DVdxVGVa.js";import{a1 as Nt,a as Me,D as We,x as Ae,y as He,a2 as Je,r as L,g as X,V as Wt,d as Ht,F as Ke,P as Kt,Y as Ot,J as Fe,K as Oe,s as Gt,c as qt,C as Jt}from"./vuetify-CbddcmEc.js";import{_ as Qt}from"./ConfirmDeleteDialog-CuZPFffe.js";const Xt={class:"mention-textarea-container"},Yt={__name:"MentionTextarea",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:"è¼¸å…¥è©•è«–..."},variant:{type:String,default:"outlined"},density:{type:String,default:"compact"},rows:{type:[Number,String],default:3},hideDetails:{type:Boolean,default:!1},autoGrow:{type:Boolean,default:!1},availableUsers:{type:Array,default:()=>[]}},emits:["update:modelValue","mention-added"],setup(d,{expose:ne,emit:i}){const x=d,O=i,z=p(null),k=p(x.modelValue),j=p(!1),b=p(0),F=p({left:0,top:0}),M=p(-1),A=p(""),R=p([]),v=ke(()=>{if(!x.availableUsers||x.availableUsers.length===0)return[];if(!A.value||A.value.trim()==="")return x.availableUsers;const g=A.value.toLowerCase();return x.availableUsers.filter(I=>I.name.toLowerCase().includes(g)||I.email.toLowerCase().includes(g))});we(()=>x.modelValue,g=>{k.value=g});let c=!1;we(k,g=>{if(c){c=!1;return}O("update:modelValue",g)});const $=g=>{const I=g.target.value,D=g.target.selectionStart;I.length>0?G(I,D):h()},S=()=>{},G=(g,I)=>{const D=g.substring(0,I),P=D.lastIndexOf("@");if(P===-1){h();return}const W=D.substring(P+1);if(W.includes(" ")||W.includes(`
`)){h();return}const H=P>0?D[P-1]:" ";if(H!==" "&&H!==`
`&&P!==0){h();return}M.value=P,A.value=W,b.value=0,x.availableUsers&&x.availableUsers.length>0?Ie(()=>{y(),j.value=!0}):h()},y=()=>{if(!z.value)return;const g=z.value.$el.querySelector("textarea");if(!g)return;const I=g.getBoundingClientRect(),D=window.getComputedStyle(g),P=parseFloat(D.fontSize)||14,W=parseFloat(D.lineHeight)||P*1.2,H=parseFloat(D.paddingLeft)||12,K=parseFloat(D.paddingTop)||8,J=k.value.substring(0,M.value).split(`
`),Z=J.length-1,oe=J[Z]||"",Q=P*.6,te=oe.length*Q,ae=v.value.length,ye=ae===0?76:Math.min(ae*58+16,210),Ue=I.left+H+te,Le=I.top+K+Z*W-ye,Ce=window.innerWidth||document.documentElement.clientWidth,xe=Math.min(Ue,Math.max(0,Ce-260-8)),ee=Math.max(8,Le);F.value={left:xe,top:ee}},h=()=>{j.value=!1,M.value=-1,A.value="",b.value=0},U=g=>{if(M.value===-1)return;const I=M.value,D=A.value,P=k.value.substring(0,I),W=k.value.substring(I+1+D.length),H=`@${g.name} `,K=P+H+W,me=I+H.length;k.value=K;const J={user:g._id,name:g.name,start:I,end:I+H.length-1};R.value.push(J),O("mention-added",J),c=!0,O("update:modelValue",K),h(),Ie(()=>{if(z.value){const Z=z.value.$el.querySelector("textarea");Z&&(Z.setSelectionRange(me,me),Z.focus())}})},N=g=>{if(j.value)switch(g.key){case"ArrowDown":g.preventDefault(),b.value=Math.min(b.value+1,v.value.length-1);break;case"ArrowUp":g.preventDefault(),b.value=Math.max(b.value-1,0);break;case"Enter":v.value.length>0&&(g.preventDefault(),U(v.value[b.value]));break;case"Escape":g.preventDefault(),h();break}},T=()=>R.value.map(g=>({user:g.user,name:g.name})),Y=()=>{R.value=[]},q=g=>{j.value&&!g.target.closest(".mention-textarea-container")&&h()};return Ge(()=>{document.addEventListener("click",q)}),Pe(()=>{document.removeEventListener("click",q)}),ne({getMentions:T,clearMentions:Y,focus:()=>{if(z.value){const g=z.value.$el.querySelector("textarea");g&&g.focus()}}}),(g,I)=>(n(),f("div",Xt,[r(Nt,{ref_key:"textareaRef",ref:z,modelValue:k.value,"onUpdate:modelValue":I[0]||(I[0]=D=>k.value=D),placeholder:d.placeholder,variant:d.variant,density:d.density,rows:d.rows,"hide-details":d.hideDetails,"auto-grow":d.autoGrow,class:"mention-textarea",onKeydown:N,onInput:$,onClick:S},null,8,["modelValue","placeholder","variant","density","rows","hide-details","auto-grow"]),(n(),E(Lt,{to:"body"},[j.value?(n(),f("div",{key:0,class:"mention-suggestions",style:qe({position:"fixed",top:F.value.top+"px",left:F.value.left+"px",zIndex:9999})},[v.value.length>0?(n(),E(Me,{key:0,"max-height":"200","min-width":"250",class:"mention-card"},{default:o(()=>[r(We,{density:"compact"},{default:o(()=>[(n(!0),f(le,null,ge(v.value,(D,P)=>(n(),E(Ae,{key:D._id,class:pe({"v-list-item--active":P===b.value}),onClick:W=>U(D),onMouseenter:W=>b.value=P},{prepend:o(()=>[r(ce,{user:D,size:"24",class:"me-2"},null,8,["user"])]),default:o(()=>[r(He,null,{default:o(()=>[_(V(D.name),1)]),_:2},1024),r(Je,null,{default:o(()=>[_(V(D.email),1)]),_:2},1024)]),_:2},1032,["class","onClick","onMouseenter"]))),128))]),_:1})]),_:1})):A.value.length>0?(n(),E(Me,{key:1,"max-height":"200","min-width":"250",class:"mention-card"},{default:o(()=>[r(We,null,{default:o(()=>[r(Ae,null,{default:o(()=>[r(He,{class:"text-medium-emphasis"},{default:o(()=>I[1]||(I[1]=[_(" ç„¡ç¬¦åˆçš„æˆå“¡ ")])),_:1})]),_:1})]),_:1})]),_:1})):C("",!0)],4)):C("",!0)]))]))}},Zt=Se(Yt,[["__scopeId","data-v-001845f8"]]),ea={class:"comment-image-upload"},ta={key:0,class:"image-preview-container mb-3"},aa={class:"image-preview-grid"},sa={class:"position-relative"},la=["src","alt"],na={class:"image-info"},oa={class:"text-caption text-truncate"},ia={class:"text-caption text-medium-emphasis"},ra={class:"upload-content"},ua={key:1,class:"text-caption text-red mt-2"},da={__name:"CommentImageUpload",props:{modelValue:{type:Array,default:()=>[]},maxFiles:{type:Number,default:3},maxFileSize:{type:Number,default:2*1024*1024}},emits:["update:modelValue","files-selected"],setup(d,{expose:ne,emit:i}){const x=d,O=i,z=p(null),k=p([]),j=p(!1),b=p(""),F=ke(()=>k.value.length<x.maxFiles),M=()=>{var y;if(!F.value){b.value=`æœ€å¤šåªèƒ½ä¸Šå‚³ ${x.maxFiles} å¼µåœ–ç‰‡`;return}(y=z.value)==null||y.click()},A=y=>{const h=Array.from(y.target.files);v(h),y.target.value=""},R=y=>{j.value=!1;const h=Array.from(y.dataTransfer.files);v(h)},v=y=>{b.value="";const h=y.filter(T=>{const Y=T.type.startsWith("image/"),q=["image/jpeg","image/png","image/webp"].includes(T.type);return Y&&q});if(h.length!==y.length){b.value="åªèƒ½ä¸Šå‚³ JPGã€PNGã€WEBP æ ¼å¼çš„åœ–ç‰‡";return}if(k.value.length+h.length>x.maxFiles){b.value=`æœ€å¤šåªèƒ½ä¸Šå‚³ ${x.maxFiles} å¼µåœ–ç‰‡`;return}if(h.filter(T=>T.size>x.maxFileSize).length>0){b.value=`åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é ${S(x.maxFileSize)}`;return}h.forEach(T=>{const Y=new FileReader;Y.onload=q=>{const g={file:T,preview:q.target.result,id:Date.now()+Math.random()};k.value.push(g),$()},Y.readAsDataURL(T)})},c=y=>{k.value.splice(y,1),$(),b.value=""},$=()=>{const y=k.value.map(h=>h.file);O("update:modelValue",y),O("files-selected",y)},S=y=>{if(y===0)return"0 Bytes";const h=1024,U=["Bytes","KB","MB","GB"],N=Math.floor(Math.log(y)/Math.log(h));return parseFloat((y/Math.pow(h,N)).toFixed(2))+" "+U[N]};return ne({clearImages:()=>{k.value=[],$(),b.value=""}}),(y,h)=>(n(),f("div",ea,[l("input",{ref_key:"fileInputRef",ref:z,type:"file",accept:"image/jpeg,image/png,image/webp",multiple:"",style:{display:"none"},onChange:A},null,544),k.value.length>0?(n(),f("div",ta,[l("div",aa,[(n(!0),f(le,null,ge(k.value,(U,N)=>(n(),f("div",{key:N,class:"image-preview-item"},[l("div",sa,[l("img",{src:U.preview,alt:U.file.name,class:"preview-image"},null,8,la),r(X,{icon:"",size:"24",class:"remove-image-btn",onClick:T=>c(N)},{default:o(()=>[r(L,{size:"14",color:"blue-grey-darken-2"},{default:o(()=>h[2]||(h[2]=[_(" mdi-close ")])),_:1})]),_:2},1032,["onClick"]),l("div",na,[l("div",oa,V(U.file.name),1),l("div",ia,V(S(U.file.size)),1)])])]))),128))])])):C("",!0),l("div",{class:pe(["upload-area",{"drag-over":j.value}]),onClick:M,onDrop:_e(R,["prevent"]),onDragover:h[0]||(h[0]=_e(U=>j.value=!0,["prevent"])),onDragleave:h[1]||(h[1]=_e(U=>j.value=!1,["prevent"]))},[l("div",ra,[r(L,{size:"24",color:"grey-darken-1",class:"mb-2"},{default:o(()=>h[3]||(h[3]=[_(" mdi-camera-plus ")])),_:1}),h[4]||(h[4]=l("div",{class:"text-body-2 text-medium-emphasis mb-1"}," é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³åœ–ç‰‡ ",-1)),h[5]||(h[5]=l("div",{class:"text-caption text-medium-emphasis"}," æ”¯æ´ JPGã€PNGã€WEBPï¼Œæœ€å¤§ 2MBï¼Œæœ€å¤š 3 å¼µ ",-1))])],34),b.value?(n(),f("div",ua,V(b.value),1)):C("",!0)]))}},ca=Se(da,[["__scopeId","data-v-d3b2c4c6"]]),ma={class:"comment-image-preview"},va={key:0,class:"single-image"},fa=["src","alt"],ga=["onClick"],pa=["src","alt"],ha={key:0,class:"more-overlay"},ka={class:"more-text"},ya=["src","alt"],xa={__name:"CommentImagePreview",props:{images:{type:Array,required:!0,default:()=>[]}},setup(d){const ne=d,i=p(!1),x=p(0),O=ke(()=>ne.images[x.value]),z=v=>{if(v.preview)return v.preview;if(v.path){const c=v.path.replace(/\\/g,"/"),$=c.includes("/uploads/")?c.split("/uploads/")[1]:`comments/${v.filename}`,S=`https://eip.ystravel.com.tw/TEST-Backend/api//uploads/${$}`;return console.log("åœ–ç‰‡ URL ç”Ÿæˆ:",{image:v,cleanPath:c,relativePath:$,finalUrl:S,apiUrl:"https://eip.ystravel.com.tw/TEST-Backend/api/"}),S}if(v.filename){const c=`https://eip.ystravel.com.tw/TEST-Backend/api//uploads/comments/${v.filename}`;return console.log("ä½¿ç”¨å‚™ç”¨åœ–ç‰‡ URL:",{image:v,backupUrl:c,apiUrl:"https://eip.ystravel.com.tw/TEST-Backend/api/"}),c}return console.log("ç„¡æ³•ç”Ÿæˆåœ–ç‰‡ URL:",v),""},k=v=>{x.value=v,i.value=!0},j=()=>{x.value>0&&x.value--},b=()=>{x.value<ne.images.length-1&&x.value++},F=v=>{console.error("åœ–ç‰‡è¼‰å…¥å¤±æ•—:",v.target.src),v.target.style.display="none"},M=v=>{v.target===v.currentTarget&&(i.value=!1)},A=v=>{if(i.value)switch(v.key){case"ArrowLeft":v.preventDefault(),j();break;case"ArrowRight":v.preventDefault(),b();break;case"Escape":v.preventDefault(),i.value=!1;break}};Ge(()=>{document.addEventListener("keydown",A)}),Pe(()=>{document.removeEventListener("keydown",A)});const R=async v=>{if(v)try{const c=z(v),$=await fetch(c);if($.ok){const S=await $.blob(),G=window.URL.createObjectURL(S),y=document.createElement("a");y.href=G,y.download=v.originalName||v.filename||"image",document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(G)}}catch(c){console.error("ä¸‹è¼‰åœ–ç‰‡å¤±æ•—:",c)}};return(v,c)=>(n(),f("div",ma,[d.images.length===1?(n(),f("div",va,[l("img",{src:z(d.images[0]),alt:d.images[0].originalName,class:"preview-image clickable",onClick:c[0]||(c[0]=$=>k(0)),onError:F},null,40,fa)])):d.images.length>1?(n(),f("div",{key:1,class:pe(["image-grid",`grid-${Math.min(d.images.length,4)}`])},[(n(!0),f(le,null,ge(d.images.slice(0,4),($,S)=>(n(),f("div",{key:$.filename||S,class:pe(["grid-item",{"has-more":S===3&&d.images.length>4}]),onClick:G=>k(S)},[l("img",{src:z($),alt:$.originalName,class:"grid-image",onError:F},null,40,pa),S===3&&d.images.length>4?(n(),f("div",ha,[l("span",ka,"+"+V(d.images.length-4),1)])):C("",!0)],10,ga))),128))],2)):C("",!0),r(Wt,{modelValue:i.value,"onUpdate:modelValue":c[4]||(c[4]=$=>i.value=$),height:"100vh",fullscreen:"",transition:"fade-transition",onKeydown:c[5]||(c[5]=$e($=>i.value=!1,["esc"]))},{default:o(()=>[r(Me,{class:"lightbox-card",color:"rgba(0,0,0,0.8)"},{default:o(()=>[r(X,{icon:"",class:"lightbox-download-btn me-2",style:{position:"absolute",top:"24px",right:"90px","z-index":"1001",background:"rgba(0,0,0,0.5)"},size:"large",onClick:c[1]||(c[1]=$=>R(O.value))},{default:o(()=>[r(L,{size:"28",color:"white"},{default:o(()=>c[6]||(c[6]=[_(" mdi-download ")])),_:1})]),_:1}),r(X,{icon:"",class:"lightbox-close-btn",style:{position:"absolute",top:"24px",right:"32px","z-index":"1001",background:"rgba(0,0,0,0.5)"},color:"white",size:"large",onClick:c[2]||(c[2]=$=>i.value=!1)},{default:o(()=>[r(L,{size:"32",color:"white"},{default:o(()=>c[7]||(c[7]=[_(" mdi-close ")])),_:1})]),_:1}),l("div",{class:"lightbox-content",onClick:M},[d.images.length>1?(n(),E(X,{key:0,icon:"mdi-chevron-left",size:"large",color:"white",class:"lightbox-nav-btn lightbox-prev",disabled:x.value===0,onClick:j},{default:o(()=>[r(L,{size:"32",color:"white"},{default:o(()=>c[8]||(c[8]=[_(" mdi-chevron-left ")])),_:1})]),_:1},8,["disabled"])):C("",!0),O.value?(n(),f("img",{key:1,src:z(O.value),class:"lightbox-image",alt:O.value.originalName||"åœ–ç‰‡é è¦½",onError:F,onClick:c[3]||(c[3]=_e(()=>{},["stop"]))},null,40,ya)):C("",!0),d.images.length>1?(n(),E(X,{key:2,icon:"mdi-chevron-right",size:"large",color:"white",class:"lightbox-nav-btn lightbox-next",disabled:x.value===d.images.length-1,onClick:b},{default:o(()=>[r(L,{size:"32",color:"white"},{default:o(()=>c[9]||(c[9]=[_(" mdi-chevron-right ")])),_:1})]),_:1},8,["disabled"])):C("",!0)]),c[10]||(c[10]=l("div",{class:"text-center mt-2",style:{color:"#fff",opacity:"0.7"}}," é»æ“ŠèƒŒæ™¯å€åŸŸã€å³ä¸Šè§’é—œé–‰ï¼Œæˆ–æŒ‰ ESC é›¢é–‹é è¦½ ",-1))]),_:1})]),_:1},8,["modelValue"])]))}},ba=Se(xa,[["__scopeId","data-v-f23725a3"]]),wa={class:"task-sidebar-content"},_a={class:"sidebar-header"},Ca={class:"d-flex align-center justify-space-between"},Da={key:0,class:"edit-mode d-flex align-center flex-grow-1 me-2"},Va={key:1,class:"display-mode d-flex align-center flex-grow-1"},za={class:"block-title font-weight-bold"},$a={class:"d-flex align-center"},Ia={key:0,class:"sidebar-body"},Ma={class:"editable-fields"},Sa={class:"field-section"},Ua={class:"field-content"},La={key:0,class:"edit-mode d-flex align-center"},Ea={class:"d-flex align-center"},Fa={key:1,class:"display-mode d-flex align-center justify-space-between"},Aa={class:"d-flex align-center"},Pa={key:1,class:"text-body-2"},Ta={key:2,class:"text-body-2 text-medium-emphasis"},Ba={class:"field-section"},ja={class:"field-content"},Ra={key:0,class:"edit-mode d-flex align-center"},Na={key:1,class:"display-mode d-flex align-center justify-space-between"},Wa={class:"d-flex align-center"},Ha={key:2,class:"text-body-2 text-medium-emphasis"},Ka={class:"field-section"},Oa={class:"field-content"},Ga={class:"display-mode d-flex align-center"},qa={key:1,class:"text-body-2 text-medium-emphasis"},Ja={class:"field-section full-width"},Qa={class:"d-flex align-center justify-space-between mb-3"},Xa={key:0,class:"mb-3 d-flex"},Ya={class:"d-flex flex-wrap align-center",style:{gap:"4px"}},Za={key:1,class:"text-overline text-grey-darken-3 ms-1"},es={key:1,class:"d-flex justify-center align-center py-6"},ts={key:2,class:"attachment-list"},as={class:"text-caption text-grey mb-2"},ss=["title"],ls={class:"field-section full-width"},ns={key:0,class:"description-loading d-flex justify-center align-center"},os={key:1},is={class:"comments-header d-flex align-center justify-space-between"},rs={key:0,class:"d-flex justify-center align-center py-6"},us={class:"comment-header"},ds={class:"comment-author"},cs={class:"text-body-2 font-weight-medium"},ms={class:"text-caption text-medium-emphasis ms-2"},vs={class:"comment-content"},fs=["innerHTML"],gs={key:2,class:"no-comments"},ps={class:"add-comment"},hs={class:"d-flex align-start mb-3"},ks={class:"flex-grow-1"},ys={key:0,class:"mt-3"},xs={class:"comment-toolbar"},bs={class:"d-flex align-center"},ws={class:"collaborators-section mt-0"},_s={class:"d-flex align-center"},Cs={key:1,class:"text-body-2 text-medium-emphasis"},Ds={class:"d-flex align-center"},Vs={class:"sub-title"},zs={class:"text-body-2 text-medium-emphasis"},$s={key:0,class:"text-caption text-medium-emphasis"},Is={__name:"TaskSidebar",props:{modelValue:{type:Boolean,default:!1},task:{type:Object,default:null},project:{type:Object,default:null}},emits:["update:modelValue","task-updated","task-deleted"],setup(d,{emit:ne}){const i=d,x=ne,O=Pt(),{apiAuth:z}=Bt(),k=jt(),j=Tt(),b=p(""),F=p(""),M=p(null),A=p(null),R=p(null),v=p(null),c=p([]),$=p(!1),S=p(null),G=p(null),y=p(null),h=p([]),U=p([]),N=p(!1),T=p(!1),Y=p(0),q=p(!0),g=p([]),I=p(!1),D=p(!1),P=p(!1),W=p(null),H=p(!1),K=p(null),me=p({x:0,y:0}),J=p(!1),Z=p(null),oe=p(!1),Q=p(""),te=p(null),ae=ke({get:()=>i.modelValue,set:e=>x("update:modelValue",e)}),ie=ke(()=>{var s;const e=((s=i.task)==null?void 0:s.collaborators)||[],t=new Set;return e.filter(a=>!a||!a._id||t.has(a._id)?!1:(t.add(a._id),!0))}),Te=ke(()=>{var t;const e=new Map;return c.value&&c.value.length>0&&c.value.forEach(s=>{s&&s._id&&e.set(s._id,s)}),(t=i.task)!=null&&t.comments&&i.task.comments.forEach(s=>{s.mentions&&s.mentions.forEach(a=>{if(a.user&&a.name){const u=typeof a.user=="string"?a.user:a.user._id||a.user.id,w=typeof a.name=="string"?a.name:a.name.name||a.name;u&&w&&(e.get(u)||e.set(u,{_id:u,name:w,email:a.email||"æœªçŸ¥",role:a.role||"æœªçŸ¥"}))}})}),Array.from(e.values())}),ye=()=>{S.value&&q.value&&Ie(()=>{setTimeout(()=>{S.value&&(S.value.scrollTop=S.value.scrollHeight)},100)})},Ue=e=>{if(!e||!e.comments)return Y.value=0,!1;const t=e.comments.length,s=t>Y.value;return Y.value=t,s},Le=()=>{De(),ae.value=!1},Ce=async()=>{var e,t,s,a;if(!(!ae.value||!i.task||!i.task._id)&&!J.value&&Z.value!==i.task._id)try{J.value=!0,oe.value=!0;const{data:u}=await z.get(`/tasks/${i.task._id}`);if(u.success&&u.data){if(console.log("ğŸ“¦ fetchTaskDetails æˆåŠŸè¼‰å…¥",{taskId:u.data._id,hasAttachments:((e=u.data.attachments)==null?void 0:e.length)||0,hasComments:((t=u.data.comments)==null?void 0:t.length)||0}),Z.value=i.task._id,!ee.value){const w=u.data.description||"";(F.value||"")!==w&&(F.value=w,Q.value=w,te.value=i.task._id)}x("task-updated",u.data)}}catch(u){console.error("è¼‰å…¥ä»»å‹™è©³æƒ…å¤±æ•—:",u),k({text:((a=(s=u==null?void 0:u.response)==null?void 0:s.data)==null?void 0:a.message)||"è¼‰å…¥ä»»å‹™è©³æƒ…å¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}finally{J.value=!1,setTimeout(()=>{oe.value=!1},200)}};let se=null,xe=p(!1);const ee=p(!1),De=async()=>{var e,t,s,a;if(!(!i.task||!i.task._id)&&!ee.value){if(se&&(clearTimeout(se),se=null),te.value!==i.task._id){console.log("â­ï¸ flushDescriptionSave è·³éï¼šä»»å‹™IDä¸åŒ¹é…",{currentTaskId:te.value,propsTaskId:i.task._id});return}if(F.value===Q.value){console.log("â­ï¸ flushDescriptionSave è·³éï¼šæè¿°æœªè®ŠåŒ–");return}console.log("ğŸ’¾ flushDescriptionSave é–‹å§‹ä¿å­˜",{taskId:i.task._id,taskName:(e=i.task)==null?void 0:e.name,descriptionLength:((t=F.value)==null?void 0:t.length)||0});try{ee.value=!0;const{data:u}=await z.put(`/tasks/${i.task._id}`,{description:F.value});u.success&&(console.log("âœ… flushDescriptionSave ä¿å­˜æˆåŠŸ"),Q.value=F.value,te.value=i.task._id,x("task-updated",u.data))}catch(u){console.error("ä¿å­˜æè¿°å¤±æ•—:",u),k({text:((a=(s=u==null?void 0:u.response)==null?void 0:s.data)==null?void 0:a.message)||"ä¿å­˜æè¿°å¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}finally{ee.value=!1}}},Qe=()=>{De()},Xe=async e=>{!i.task||!i.task._id||xe.value||oe.value||e!==Q.value&&(se&&clearTimeout(se),se=setTimeout(async()=>{var t,s;try{ee.value=!0;const{data:a}=await z.put(`/tasks/${i.task._id}`,{description:e});a.success&&(Q.value=e,te.value=i.task._id,x("task-updated",a.data))}catch(a){console.error("æ›´æ–°æè¿°å¤±æ•—:",a),k({text:((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"æ›´æ–°æè¿°å¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}finally{ee.value=!1}},1e3))},Ye=async()=>{var e,t;if(!(!b.value.trim()&&U.value.length===0||!i.task||$.value))try{$.value=!0;const s=G.value?G.value.getMentions():[],a=new FormData;a.append("content",b.value.trim()),a.append("mentions",JSON.stringify(s)),U.value.forEach(w=>{a.append("images",w)}),console.log("ç™¼é€è©•è«–è«‹æ±‚:",{content:b.value.trim(),mentionsCount:s.length,imagesCount:U.value.length});const{data:u}=await z.post(`/tasks/${i.task._id}/comments`,a,{headers:{"Content-Type":"multipart/form-data"}});u.success&&(x("task-updated",u.data),b.value="",U.value=[],N.value=!1,h.value=[],G.value&&G.value.clearMentions(),y.value&&y.value.clearImages(),q.value=!0,ye(),k({text:"è©•è«–æ–°å¢æˆåŠŸ",snackbarProps:{color:"teal-lighten-1"}}))}catch(s){console.error("æ–°å¢è©•è«–å¤±æ•—:",s),k({text:((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.message)||"æ–°å¢è©•è«–å¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}finally{$.value=!1}},Ze=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Ye())},et=()=>!ie.value||ie.value.length<=3?"":ie.value.slice(3).map(t=>t.name).join("ã€"),tt=e=>{h.value.push(e)},at=e=>{U.value=e,console.log("é¸æ“‡äº†åœ–ç‰‡:",e.length,"å¼µ")},st=()=>{N.value=!N.value,N.value||(U.value=[],y.value&&y.value.clearImages())},lt=()=>{T.value=!T.value},nt=()=>{if(!S.value)return;const e=S.value,t=e.scrollTop+e.clientHeight>=e.scrollHeight-10;q.value=t},ot=()=>{D.value=!D.value},it=e=>{console.log("é¸æ“‡äº†æª”æ¡ˆ:",(e==null?void 0:e.length)||0,"å€‹")},rt=async()=>{var e,t,s;if(!(!g.value||g.value.length===0)&&(e=i.task)!=null&&e._id){I.value=!0;try{const a=new FormData;g.value.forEach(w=>{a.append("attachments",w)});const{data:u}=await z.post(`/tasks/${i.task._id}/attachments`,a,{headers:{"Content-Type":"multipart/form-data"}});u.success&&(k({text:`æˆåŠŸä¸Šå‚³ ${g.value.length} å€‹é™„ä»¶`,snackbarProps:{color:"success"}}),g.value=[],D.value=!1,x("task-updated",u.data))}catch(a){console.error("ä¸Šå‚³é™„ä»¶å¤±æ•—:",a),k({text:((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"ä¸Šå‚³é™„ä»¶å¤±æ•—",snackbarProps:{color:"error"}})}finally{I.value=!1}}},ut=e=>{try{const t=`https://eip.ystravel.com.tw/TEST-Backend/api//uploads/tasks/${e.filename}`,s=document.createElement("a");s.href=t,s.download=e.originalName,s.target="_blank",document.body.appendChild(s),s.click(),document.body.removeChild(s),console.log("é–‹å§‹ä¸‹è¼‰é™„ä»¶:",e.originalName)}catch(t){console.error("ä¸‹è¼‰é™„ä»¶å¤±æ•—:",t),k({text:"ä¸‹è¼‰é™„ä»¶å¤±æ•—",snackbarProps:{color:"error"}})}},dt=e=>{W.value=e,P.value=!0},ct=async()=>{var e,t;try{const s=W.value;if(!s)return;const{data:a}=await z.delete(`/tasks/${i.task._id}/attachments/${s._id}`);a.success&&(k({text:"é™„ä»¶åˆªé™¤æˆåŠŸ",snackbarProps:{color:"success"}}),x("task-updated",a.data))}catch(s){console.error("åˆªé™¤é™„ä»¶å¤±æ•—:",s),k({text:((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.message)||"åˆªé™¤é™„ä»¶å¤±æ•—",snackbarProps:{color:"error"}})}finally{W.value=null,P.value=!1}},mt=()=>!0;let re=null;const vt=async e=>{re&&(clearTimeout(re),re=null);const t=e.target;if(t.classList.contains("mention-tag")){const s=t.getAttribute("data-user-id"),a=t.getAttribute("data-user-name");if(s&&a){c.value.length===0&&await Ee();let u=Te.value.find(ze=>ze._id===s);u||(u={_id:s,name:a,email:"æœªçŸ¥",role:"æœªçŸ¥"}),K.value=u;const w=t.getBoundingClientRect(),ve=80,ue=280;let de=w.left+w.width/2-ue/2;const be=window.innerWidth;de<10&&(de=10),de+ue>be-10&&(de=be-ue-10);let he=w.top-ve-10;he<10&&(he=w.bottom+10),me.value={x:de,y:he},H.value=!0}}},ft=e=>{const t=e.relatedTarget;t&&t.closest(".user-hover-card")||(re=setTimeout(()=>{H.value=!1,K.value=null},50))},gt=()=>{re&&(clearTimeout(re),re=null)},pt=()=>{re=setTimeout(()=>{H.value=!1,K.value=null},50)},ht=e=>e.startsWith("image/")?"mdi-file-image":e.includes("pdf")?"mdi-file-pdf-box":e.includes("word")||e.includes("document")?"mdi-file-word":e.includes("excel")||e.includes("spreadsheet")?"mdi-file-excel":e.includes("powerpoint")||e.includes("presentation")?"mdi-file-powerpoint":e.includes("zip")||e.includes("rar")||e.includes("7z")?"mdi-folder-zip":e.includes("text")?"mdi-file-document":"mdi-file",kt=e=>e.startsWith("image/")?"green":e.includes("pdf")?"red":e.includes("word")||e.includes("document")?"blue":e.includes("excel")||e.includes("spreadsheet")?"green":e.includes("powerpoint")||e.includes("presentation")?"orange":e.includes("zip")||e.includes("rar")||e.includes("7z")?"purple":"grey",yt=(e,t=15)=>e.length<=t?e:e.substring(0,t)+"...",xt=()=>{var e;M.value="title",A.value=((e=i.task)==null?void 0:e.name)||""},bt=async()=>{var e,t;M.value="assignee",R.value=((t=(e=i.task)==null?void 0:e.assignee)==null?void 0:t._id)||null,c.value.length===0&&await Ee()},wt=()=>{var e;M.value="dueDate",v.value=((e=i.task)==null?void 0:e.dueDate)||null},_t=e=>{const t=e?e instanceof Date?e.toISOString():e:null;v.value=t,Be()},Ct=()=>{v.value=null,Be()},Dt=async()=>{var e,t,s;if((e=i.task)!=null&&e._id)try{const{data:a}=await z.put(`/tasks/${i.task._id}`,{name:A.value});a.success&&(x("task-updated",a.data),M.value=null,k({text:"æ¨™é¡Œæ›´æ–°æˆåŠŸ",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){console.error("æ›´æ–°æ¨™é¡Œå¤±æ•—:",a),k({text:((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"æ›´æ–°æ¨™é¡Œå¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}},Vt=async()=>{var e,t,s;if((e=i.task)!=null&&e._id)try{const{data:a}=await z.put(`/tasks/${i.task._id}`,{assignee:R.value});a.success&&(x("task-updated",a.data),M.value=null,k({text:"æŒ‡æ´¾å°è±¡æ›´æ–°æˆåŠŸ",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){console.error("æ›´æ–°æŒ‡æ´¾å°è±¡å¤±æ•—:",a),k({text:((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"æ›´æ–°æŒ‡æ´¾å°è±¡å¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}},Be=async()=>{var e,t,s;if((e=i.task)!=null&&e._id)try{const{data:a}=await z.put(`/tasks/${i.task._id}`,{dueDate:v.value});a.success&&(x("task-updated",a.data),M.value=null,k({text:"æˆªæ­¢æ—¥æœŸæ›´æ–°æˆåŠŸ",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){console.error("æ›´æ–°æˆªæ­¢æ—¥æœŸå¤±æ•—:",a),k({text:((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"æ›´æ–°æˆªæ­¢æ—¥æœŸå¤±æ•—",snackbarProps:{color:"red-lighten-1"}})}},Ee=async()=>{var e,t;try{(t=(e=i.project)==null?void 0:e.team)!=null&&t.members?c.value=i.project.team.members:c.value=[]}catch(s){console.error("å–å¾—ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:",s),c.value=[]}},zt=e=>e?new Date(e).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}):"",$t=e=>e?new Date(e).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",It=e=>({"in-progress":"é€²è¡Œä¸­",in_progress:"é€²è¡Œä¸­",completed:"å·²å®Œæˆ",pending:"å¾…è™•ç†",cancelled:"å·²å–æ¶ˆ"})[e]||e,Mt=e=>({"in-progress":"blue",in_progress:"blue",completed:"green",pending:"orange",cancelled:"red"})[e]||"grey",je=e=>{var w;if(!e||((w=i.task)==null?void 0:w.status)==="completed")return"text-medium-emphasis";const t=new Date,a=new Date(e)-t,u=Math.ceil(a/(1e3*60*60*24));return u<0?"text-red-darken-1":u<=3?"text-purple-darken-1":u<=10?"text-light-blue-accent-4":"text-medium-emphasis"},St=e=>{if(!e||!e.content)return"";let t=e.content;return e.mentions&&e.mentions.length>0&&e.mentions.forEach(s=>{const a=typeof s.user=="string"?s.user:s.user._id||s.user.id,u=typeof s.name=="string"?s.name:s.name.name||s.name;if(a&&u){const w=`@${u}`,ve=w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),ue=new RegExp(ve,"g");t=t.replace(ue,`<span class="mention-tag" data-user-id="${a}" data-user-name="${u}">${w}</span>`)}}),t=t.replace(/\n/g,"<br>"),t};we(ae,e=>{e?(q.value=!0,setTimeout(()=>{ye()},50),Ce()):(M.value=null,A.value=null,R.value=null,v.value=null,b.value="",U.value=[],N.value=!1,T.value=!1,y.value&&y.value.clearImages(),De(),oe.value=!1)});const Ut=()=>{var e;(e=i.project)!=null&&e._id&&O.push(`/projectAndTaskManagement/projects/${i.project._id}`)},Ve=()=>{M.value=null,R.value=null,v.value=null};return we(()=>i.task,(e,t)=>{var s,a;if(e){if(M.value=null,A.value=null,R.value=null,v.value=null,(!t||e._id!==t._id)&&(xe.value=!0,oe.value=!0),!t||e._id!==t._id){if(console.log("ğŸ“ watch props.task: ä»»å‹™åˆ‡æ›",{oldTaskId:t==null?void 0:t._id,newTaskId:e._id,newTaskName:e.name}),!ee.value){const w=e.description||"";F.value=w,Q.value=w,te.value=e._id,console.log("ğŸ“ å·²æ›´æ–°æè¿°å’ŒIDè¿½è¹¤",{descLength:w.length,taskId:e._id})}}else if(!ee.value&&Q.value!==e.description){console.log("ğŸ“ watch props.task: åŒä¸€ä»»å‹™ï¼Œæ›´æ–°æè¿°",{taskId:e._id,oldDescLength:((s=Q.value)==null?void 0:s.length)||0,newDescLength:((a=e.description)==null?void 0:a.length)||0});const w=e.description||"";Q.value=w,te.value=e._id}const u=Ue(e);(!t||u)&&(q.value=!0,ye()),(!t||e._id!==t._id)&&Ie(()=>{setTimeout(()=>{xe.value=!1,oe.value=!1},200)}),ae.value&&(!t||e._id!==t._id)&&(Z.value=null,Ce())}},{immediate:!0}),we(()=>i.project,e=>{e&&Ee()},{immediate:!0}),Pe(()=>{se&&clearTimeout(se),De()}),(e,t)=>{var a;const s=Et("v-date-input");return n(),f(le,null,[r(Gt,{modelValue:ae.value,"onUpdate:modelValue":t[7]||(t[7]=u=>ae.value=u),location:"right",width:"640",temporary:"",class:"task-sidebar"},{default:o(()=>{var u,w,ve,ue,de,be,he,ze;return[l("div",wa,[l("div",_a,[l("div",Ca,[M.value==="title"?(n(),f("div",Da,[r(Ht,{modelValue:A.value,"onUpdate:modelValue":t[0]||(t[0]=m=>A.value=m),placeholder:"è¼¸å…¥ä»»å‹™æ¨™é¡Œ",variant:"outlined",density:"compact","hide-details":"",class:"flex-grow-1",onKeydown:[$e(Dt,["enter"]),$e(Ve,["escape"])]},null,8,["modelValue"]),r(L,{size:"16",color:"grey",class:"edit-icon ms-2",onClick:Ve},{default:o(()=>t[10]||(t[10]=[_(" mdi-close ")])),_:1})])):(n(),f("div",Va,[l("div",za,V(((u=d.task)==null?void 0:u.name)||"ä»»å‹™è©³æƒ…"),1),r(L,{size:"16",color:"grey",class:"edit-icon ms-4",onClick:xt},{default:o(()=>t[11]||(t[11]=[_(" mdi-pencil ")])),_:1})])),l("div",$a,[(w=d.task)!=null&&w.status?(n(),E(Ke,{key:0,color:Mt(d.task.status),label:"",size:"small",class:"me-2"},{default:o(()=>[_(V(It(d.task.status)),1)]),_:1},8,["color"])):C("",!0),r(X,{icon:"",variant:"plain",size:"small",onClick:Le},{default:o(()=>[r(L,null,{default:o(()=>t[12]||(t[12]=[_("mdi-close")])),_:1})]),_:1})])])]),d.task?(n(),f("div",Ia,[l("div",Ma,[l("div",Sa,[t[15]||(t[15]=l("label",{class:"field-label"},"æŒ‡æ´¾å°è±¡",-1)),l("div",Ua,[M.value==="assignee"?(n(),f("div",La,[r(Kt,{modelValue:R.value,"onUpdate:modelValue":[t[1]||(t[1]=m=>R.value=m),Vt],items:c.value,"item-title":"name","item-value":"_id",placeholder:"é¸æ“‡æŒ‡æ´¾å°è±¡",variant:"outlined",density:"compact","hide-details":"",clearable:"",class:"flex-grow-1 me-2"},{item:o(({props:m,item:B})=>[r(Ae,Ft(At(m)),{prepend:o(()=>[B.raw&&typeof B.raw=="object"?(n(),E(ce,{key:0,user:B.raw,size:"24"},null,8,["user"])):C("",!0)]),default:o(()=>[r(Je,null,{default:o(()=>{var fe;return[_(V(((fe=B.raw)==null?void 0:fe.email)||""),1)]}),_:2},1024)]),_:2},1040)]),selection:o(({item:m})=>{var B;return[l("div",Ea,[m.raw&&typeof m.raw=="object"?(n(),E(ce,{key:0,user:m.raw,size:"24",class:"me-2"},null,8,["user"])):C("",!0),_(" "+V(((B=m.raw)==null?void 0:B.name)||""),1)])]}),_:1},8,["modelValue","items"]),r(L,{size:"16",color:"grey",class:"edit-icon",onClick:Ve},{default:o(()=>t[13]||(t[13]=[_(" mdi-close ")])),_:1})])):(n(),f("div",Fa,[l("div",Aa,[d.task.assignee?(n(),E(ce,{key:0,user:d.task.assignee,size:"24",class:"me-2"},null,8,["user"])):C("",!0),d.task.assignee?(n(),f("span",Pa,V(d.task.assignee.name),1)):(n(),f("span",Ta," ç„¡æŒ‡æ´¾å°è±¡ "))]),r(L,{size:"16",color:"grey",class:"edit-icon",onClick:bt},{default:o(()=>t[14]||(t[14]=[_(" mdi-pencil ")])),_:1})]))])]),l("div",Ba,[t[19]||(t[19]=l("label",{class:"field-label"},"æˆªæ­¢æ—¥æœŸ",-1)),l("div",ja,[M.value==="dueDate"?(n(),f("div",Ra,[r(s,{"model-value":v.value?new Date(v.value):null,placeholder:"é¸æ“‡æˆªæ­¢æ—¥æœŸ",variant:"outlined",density:"compact","hide-details":"",clearable:"","prepend-icon":"","ok-text":"ç¢ºèª","cancel-text":"å–æ¶ˆ",class:"flex-grow-1 me-2","onUpdate:modelValue":_t,"onClick:clear":Ct,onClick:t[2]||(t[2]=_e(()=>{},["stop"]))},null,8,["model-value"]),r(L,{size:"16",color:"grey",class:"edit-icon",onClick:Ve},{default:o(()=>t[16]||(t[16]=[_(" mdi-close ")])),_:1})])):(n(),f("div",Na,[l("div",Wa,[d.task.dueDate?(n(),E(L,{key:0,size:"16",class:"me-2",color:je(d.task.dueDate)},{default:o(()=>t[17]||(t[17]=[_(" mdi-calendar ")])),_:1},8,["color"])):C("",!0),d.task.dueDate?(n(),f("span",{key:1,class:pe(["text-body-2",je(d.task.dueDate)])},V(zt(d.task.dueDate)),3)):(n(),f("span",Ha," ç„¡æˆªæ­¢æ—¥æœŸ "))]),r(L,{size:"16",color:"grey",class:"edit-icon",onClick:wt},{default:o(()=>t[18]||(t[18]=[_(" mdi-pencil ")])),_:1})]))])]),l("div",Ka,[t[21]||(t[21]=l("label",{class:"field-label"},"å°ˆæ¡ˆ",-1)),l("div",Oa,[l("div",Ga,[r(L,{size:"18",class:"me-2",color:((ve=d.project)==null?void 0:ve.iconColor)==="white"?"grey-lighten-1":(ue=d.project)==null?void 0:ue.iconColor},{default:o(()=>t[20]||(t[20]=[_(" mdi-square-rounded ")])),_:1},8,["color"]),(de=d.project)!=null&&de.name?(n(),f("span",{key:0,class:"text-body-2 project-name-link",onClick:Ut},V(d.project.name),1)):(n(),f("span",qa," ç„¡å°ˆæ¡ˆ "))])])])]),l("div",Ja,[l("div",Qa,[t[22]||(t[22]=l("label",{class:"attachment-label"},"é™„ä»¶",-1)),r(L,{size:"16",color:"grey",class:"me-2 edit-icon",onClick:ot},{default:o(()=>[_(V(D.value?"mdi-minus":"mdi-plus"),1)]),_:1})]),D.value?(n(),f("div",Xa,[r(Ot,{ref:"fileInputRef",modelValue:g.value,"onUpdate:modelValue":[t[3]||(t[3]=m=>g.value=m),it],label:"é¸æ“‡æª”æ¡ˆ",variant:"outlined",density:"compact",multiple:"","prepend-icon":"mdi-paperclip",chips:"",counter:"",rules:[m=>!m||m.length<=10||"æœ€å¤šåªèƒ½ä¸Šå‚³ 10 å€‹æª”æ¡ˆ"]},{selection:o(({fileNames:m})=>[l("div",Ya,[(n(!0),f(le,null,ge(m,(B,fe)=>(n(),f(le,{key:B},[fe<3?(n(),E(Ke,{key:0,color:"blue-darken-1",size:"small",label:"",class:"mb-1"},{default:o(()=>[_(V(yt(B,15)),1)]),_:2},1024)):C("",!0),fe===3?(n(),f("span",Za," +"+V(m.length-3)+" å€‹æª”æ¡ˆ ",1)):C("",!0)],64))),128))])]),_:1},8,["modelValue","rules"]),g.value&&g.value.length>0?(n(),E(X,{key:0,color:"teal-darken-1",size:"small",class:"ms-3 mt-2",variant:"outlined",loading:I.value,onClick:rt},{default:o(()=>t[23]||(t[23]=[_(" ä¸Šå‚³ ")])),_:1},8,["loading"])):C("",!0)])):C("",!0),J.value?(n(),f("div",es,[r(Fe,{indeterminate:"",color:"blue-grey",size:"32",width:"3"}),t[24]||(t[24]=l("span",{class:"text-caption text-grey ms-3"},"è¼‰å…¥é™„ä»¶ä¸­...",-1))])):(be=d.task)!=null&&be.attachments&&d.task.attachments.length>0?(n(),f("div",ts,[l("div",as," å·²ä¸Šå‚³çš„é™„ä»¶ ("+V(d.task.attachments.length)+") ",1),(n(!0),f(le,null,ge(d.task.attachments,m=>(n(),f("div",{key:m._id,class:"attachment-item d-flex align-center mb-2"},[r(L,{color:kt(m.mimeType),size:"20",class:"me-2"},{default:o(()=>[_(V(ht(m.mimeType)),1)]),_:2},1032,["color"]),l("span",{class:"attachment-name flex-grow-1 text-body-2",title:m.originalName},V(m.originalName),9,ss),r(X,{icon:"",size:"x-small",color:"blue-grey-lighten-1",variant:"text",title:"ä¸‹è¼‰ "+m.originalName,onClick:B=>ut(m)},{default:o(()=>[r(L,{size:"16"},{default:o(()=>t[25]||(t[25]=[_(" mdi-download ")])),_:1})]),_:2},1032,["title","onClick"]),mt()?(n(),E(X,{key:0,icon:"",size:"x-small",color:"red-lighten-1",variant:"text",title:"åˆªé™¤ "+m.originalName,onClick:B=>dt(m)},{default:o(()=>[r(L,{size:"16"},{default:o(()=>t[26]||(t[26]=[_(" mdi-delete ")])),_:1})]),_:2},1032,["title","onClick"])):C("",!0)]))),128))])):C("",!0)]),l("div",ls,[t[28]||(t[28]=l("label",{class:"field-label"},"æè¿°",-1)),J.value?(n(),f("div",ns,[r(Fe,{indeterminate:"",color:"blue-grey",size:"32",width:"3"}),t[27]||(t[27]=l("span",{class:"text-caption text-grey ms-3"},"è¼‰å…¥æè¿°ä¸­...",-1))])):(n(),f("div",os,[r(Rt,{modelValue:F.value,"onUpdate:modelValue":[t[4]||(t[4]=m=>F.value=m),Xe],placeholder:"è¼¸å…¥ä»»å‹™æè¿°...",height:200,onBlur:Qe},null,8,["modelValue"])]))])])):C("",!0),l("div",{class:pe(["comments-section",{expanded:T.value}])},[l("div",is,[t[29]||(t[29]=l("h3",{class:"text-h6"}," è©•è«– ",-1)),(he=d.task)!=null&&he.comments&&d.task.comments.length>0?(n(),E(X,{key:0,icon:"",variant:"plain",size:"32",color:"grey-darken-1",title:T.value?"æ”¶ç¸®è©•è«–åˆ—è¡¨":"å±•é–‹è©•è«–åˆ—è¡¨",onClick:lt},{default:o(()=>[r(L,{size:"22"},{default:o(()=>[_(V(T.value?"mdi-chevron-down":"mdi-chevron-up"),1)]),_:1})]),_:1},8,["title"])):C("",!0)]),J.value?(n(),f("div",rs,[r(Fe,{indeterminate:"",color:"blue-grey",size:"32",width:"3"}),t[30]||(t[30]=l("span",{class:"text-caption text-grey ms-3"},"è¼‰å…¥è©•è«–ä¸­...",-1))])):(ze=d.task)!=null&&ze.comments&&d.task.comments.length>0?(n(),f("div",{key:1,ref_key:"commentsListRef",ref:S,class:pe(["comments-list",{"comments-expanded":T.value}]),onScroll:nt},[(n(!0),f(le,null,ge(d.task.comments,m=>{var B;return n(),f("div",{key:m._id,class:"comment-item"},[l("div",us,[l("div",ds,[m.author?(n(),E(ce,{key:0,user:m.author,size:"24",class:"me-2"},null,8,["user"])):C("",!0),l("span",cs,V(((B=m.author)==null?void 0:B.name)||"æœªçŸ¥ç”¨æˆ¶"),1),l("span",ms,V($t(m.createdAt)),1)])]),l("div",vs,[l("div",{class:"text-body-2 comment-text",onMouseover:vt,onMouseout:ft,innerHTML:St(m)},null,40,fs),m.attachments&&m.attachments.length>0?(n(),E(ba,{key:0,images:m.attachments},null,8,["images"])):C("",!0)])])}),128))],34)):(n(),f("div",gs,[r(L,{size:"36",color:"grey-lighten-1",class:"mb-2"},{default:o(()=>t[31]||(t[31]=[_(" mdi-comment-outline ")])),_:1}),t[32]||(t[32]=l("p",{style:{"font-size":"14px"},class:"text-grey"}," å°šç„¡è©•è«– ",-1))])),l("div",ps,[l("div",hs,[Re(j).user?(n(),E(ce,{key:0,user:Re(j).user,size:"32",class:"me-3"},null,8,["user"])):C("",!0),l("div",ks,[r(Zt,{ref_key:"mentionTextareaRef",ref:G,modelValue:b.value,"onUpdate:modelValue":t[5]||(t[5]=m=>b.value=m),placeholder:"æ–°å¢è©•è«–...",variant:"outlined",density:"compact",rows:"3","hide-details":"","auto-grow":"","available-users":c.value,onKeydown:$e(Ze,["enter"]),onMentionAdded:tt},null,8,["modelValue","available-users"]),N.value?(n(),f("div",ys,[r(ca,{ref_key:"commentImageUploadRef",ref:y,modelValue:U.value,"onUpdate:modelValue":t[6]||(t[6]=m=>U.value=m),onFilesSelected:at},null,8,["modelValue"])])):C("",!0)])]),l("div",xs,[l("div",bs,[r(X,{icon:"",variant:"plain",size:"24",color:"grey-darken-1",ripple:!1,onClick:st},{default:o(()=>[r(L,{size:"20"},{default:o(()=>t[33]||(t[33]=[_(" mdi-camera ")])),_:1})]),_:1}),t[34]||(t[34]=l("span",{class:"hint-text flex-grow-1 ms-2"}," æŒ‰ Enter ç™¼é€è©•è«–ï¼ŒæŒ‰ Shift + Enter æ›è¡Œ ",-1))])]),l("div",ws,[t[35]||(t[35]=l("div",{class:"text-body-2 text-medium-emphasis mb-2"}," å”ä½œè€… ",-1)),l("div",_s,[(n(!0),f(le,null,ge(ie.value.slice(0,3),(m,B)=>(n(),E(Oe,{key:m._id,text:m.name,location:"top"},{activator:o(({props:fe})=>[r(ce,Ne({ref_for:!0},fe,{user:m,size:"24",class:"collaborator-avatar",style:{marginLeft:B>0?"-8px":"0",zIndex:10-B}}),null,16,["user","style"])]),_:2},1032,["text"]))),128)),ie.value.length>3?(n(),E(Oe,{key:0,text:et(),location:"top"},{activator:o(({props:m})=>[l("span",Ne(m,{class:"text-caption ms-1"})," +"+V(ie.value.length-3),17)]),_:1},8,["text"])):C("",!0),ie.value.length?C("",!0):(n(),f("span",Cs," ç„¡å”ä½œè€… "))])])])],2)])]}),_:1},8,["modelValue"]),r(Qt,{modelValue:P.value,"onUpdate:modelValue":t[8]||(t[8]=u=>P.value=u),title:"åˆªé™¤é™„ä»¶",message:`ç¢ºå®šè¦åˆªé™¤é™„ä»¶ã€Œ${((a=W.value)==null?void 0:a.originalName)||""}ã€å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚`,onConfirm:ct},null,8,["modelValue","message"]),r(Jt,{modelValue:H.value,"onUpdate:modelValue":t[9]||(t[9]=u=>H.value=u),location:"top","close-on-content-click":!1,offset:15,transition:"fade-transition","open-delay":0,"close-delay":0,style:qe({position:"fixed",left:me.value.x+"px",top:me.value.y+"px",zIndex:9999})},{default:o(()=>[K.value?(n(),E(Me,{key:0,class:"user-hover-card","max-width":"280",onMouseenter:gt,onMouseleave:pt},{default:o(()=>[r(qt,{class:"pa-3"},{default:o(()=>[l("div",Ds,[r(ce,{user:K.value,size:"40",class:"me-3"},null,8,["user"]),l("div",null,[l("div",Vs,V(K.value.name),1),l("div",zs,V(K.value.email),1),K.value.role?(n(),f("div",$s,V(K.value.role),1)):C("",!0)])])]),_:1})]),_:1})):C("",!0)]),_:1},8,["modelValue","style"])],64)}}},Ts=Se(Is,[["__scopeId","data-v-92963cb6"]]);export{Ts as T};

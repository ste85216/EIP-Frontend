import{f as L,r as d,w as De,k as ze,aV as v,Z as k,bH as s,a8 as t,a0 as m,a7 as y,u as n,bJ as Me,_ as C,bf as x,$ as ae,aG as me,bM as ce,aH as Le}from"./@vue-Cr_z6yfx.js";import{l as Te}from"./lodash-CiJWSuVn.js";import{c as S,a as qe,b as Be}from"./yup-WHNMwcW8.js";import{u as Ee}from"./vue-router-CS4OewbW.js";import{u as Fe,a as _}from"./vee-validate-BXV9nMa7.js";import{_ as He,u as Ne,U as Re,b as We}from"./index-ZcDhEpUM.js";import{i as Oe}from"./vuetify-use-dialog-C5oZ13xz.js";import{C as Qe}from"./ConfirmDeleteDialogWithTextField-DtpfDroW.js";import{_ as Ge}from"./ConfirmDeleteDialog-CuZPFffe.js";import{q as Je,Q as Ke,w as p,v as T,g as $,r as q,d as P,R as Ze,C as je,F as Xe,a as pe,c as ve,S as Ye,U as ea,e as aa,W as la,f as ta,V as sa,T as oa}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";import"./core-js-D2hAHviU.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-DzadwsAs.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./jspdf-DacfHTdZ.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";const na={key:0},ra={key:1},ia={class:"d-flex align-center px-3 py-2 bg-teal-lighten-1 text-white"},ua={class:"d-flex align-center px-3 py-2 bg-teal-lighten-3 text-white"},da={class:"d-flex align-center px-3 py-2 bg-teal-lighten-2 text-white"},ma={key:1,class:"text-grey"},ca={class:"card-title px-4 py-3"},pa={__name:"admin",setup(va){const{apiAuth:I}=We(),fe=Ne(),f=Oe(),{smAndUp:le,mdAndUp:J,lgAndUp:K}=Je(),B=L(()=>le.value?"default":"small"),c=d(!1),V=d(null),E=d(!1),ge={class:"header-bg"},ye=L(()=>{const a={email:S().required("請輸入 email").email("請輸入正確的 email 格式"),name:S().required("請輸入姓名"),note:S().nullable()};return c.value&&(a.adminId=S().required("請輸入管理者編號")),c.value||(a.password=S().required("請輸入密碼").min(8,"密碼長度至少需要8個字元"),a.confirmPassword=S().required("請再次輸入密碼").oneOf([qe("password")],"密碼不一致")),Be(a)}),{handleSubmit:be,isSubmitting:Z,resetForm:te}=Fe({validationSchema:ye,initialValues:{email:"",name:"",note:""}}),A=_("email"),D=_("name"),z=_("note"),F=_("password"),H=_("confirmPassword"),M=_("adminId"),N=d(10),R=d([{key:"adminId",order:"asc"}]),U=d(1),b=d([]),ke=d(0),j=[{title:"管理者編號",align:"left",sortable:!0,key:"adminId"},{title:"姓名",align:"left",sortable:!0,key:"name"},{title:"Email",align:"left",sortable:!0,key:"email"},{title:"員工關聯",align:"left",sortable:!1,key:"employeeLink"},{title:"備註",align:"left",sortable:!0,key:"note"},{title:"操作",align:"left",sortable:!1,key:"action"},{title:"帳號狀態",align:"left",sortable:!0,key:"isActive"}],w=d(!0),X=d(0),xe=d(""),W=d(""),g=d({open:!1,id:""}),Ve=L(()=>J.value?"900":le.value?"600":"100%"),we=L(()=>K.value?j:J.value?j.filter(a=>a.key!=="employeeLink"):j.filter(a=>!["email","employeeLink","note"].includes(a.key))),h=async a=>{a&&(U.value=1),await se()},se=async()=>{var a,e,o,u,l;w.value=!0;try{const r={page:U.value,itemsPerPage:N.value,sortBy:((a=R.value[0])==null?void 0:a.key)||"adminId",sortOrder:((e=R.value[0])==null?void 0:e.order)||"asc",quickSearch:W.value},{data:i}=await I.get("/users/search/admins",{params:r});i.success&&(b.value=i.result.data,X.value=i.result.totalItems)}catch(r){const i=((u=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:u.message)||"搜索失敗";((l=r==null?void 0:r.response)==null?void 0:l.status)===401?(await fe.logout(),Se.push("/login"),f({text:"登入已過期，請重新登入",snackbarProps:{color:"red-lighten-1"}})):f({text:i,snackbarProps:{color:"red-lighten-1"}})}finally{w.value=!1}},he=be(async a=>{var e,o;try{const u={...a,isAdmin:!0,role:Re.ADMIN};if(c.value){const{data:l}=await I.patch(`/users/${g.value.id}`,u),r=b.value.findIndex(i=>i._id===g.value.id);r!==-1&&(b.value[r]=l.result)}else await I.post("/users",u),await h(!0);f({text:c.value?"管理者資料更新成功":"管理者新增成功",snackbarProps:{color:"teal-lighten-1"}}),Y()}catch(u){const l=((o=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:o.message)||"操作失敗";f({text:l,snackbarProps:{color:"red-lighten-1"}})}}),oe=async a=>{g.value.open=!0,a?(c.value=!0,g.value.id=a._id,A.value.value=a.email,D.value.value=a.name,z.value.value=a.note,M.value.value=a.adminId,F.value.value="",H.value.value="",V.value={email:a.email,name:a.name,note:a.note,adminId:a.adminId}):(c.value=!1,g.value.id="",V.value=null,te())},Y=()=>{g.value.open=!1,V.value=null,te()},Ce=async()=>{var a,e;try{w.value=!0,await I.delete(`/users/${g.value.id}`),Y(),await h(!0),f({text:"管理者刪除成功",snackbarProps:{color:"teal-lighten-1"}})}catch(o){console.error("Delete user error:",o),f({text:((e=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}finally{w.value=!1,E.value=!1}},Pe=L(()=>c.value?V.value?["email","name","note","adminId"].some(a=>{const e=a==="email"?A.value.value:a==="name"?D.value.value:a==="note"?z.value.value:a==="adminId"?M.value.value:null;return V.value[a]!==e}):!1:!0),Ie=Te.debounce(()=>{U.value=1,w.value=!0,se().finally(()=>{w.value=!1})},300);De(W,a=>{Ie(a)}),ze(async()=>{try{await h(!0)}catch(a){console.error("初始化加載失敗:",a)}});const Ue=a=>{a<1&&(a=1);const e=Math.ceil(X.value/N.value);a>e&&(a=e),U.value!==a&&(U.value=a,localStorage.removeItem("adminTablePage"),h(!1))},Se=Ee(),O=d(!1),Q=d(!1),G=d(!1),ee=d(null),_e=a=>{a.isActive?(ee.value=a,G.value=!0):ne(a,!0)},$e=async()=>{ee.value&&(await ne(ee.value,!1),G.value=!1)},ne=async(a,e)=>{var o,u;try{if((await I.patch(`/users/${a._id}`,{isActive:e})).data.success){const r=b.value.findIndex(i=>i._id===a._id);r!==-1&&(b.value[r].isActive=e),f({text:`帳號已${e?"啟用":"停用"}`,snackbarProps:{color:e?"teal-lighten-1":"warning"}})}}catch(l){console.error("更新用戶狀態失敗:",l),f({text:((u=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:u.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}});const r=b.value.findIndex(i=>i._id===a._id);r!==-1&&(b.value[r].isActive=!e)}},Ae=async()=>{var a,e;try{const{data:o}=await I.post("/users/check-admin-employee-links");if(o.success){await h(!1);let u=`管理者檢查完成！成功關聯 ${o.result.linked} 個管理者`;o.result.errors.length>0&&(u+=`，${o.result.errors.length} 個無法關聯`),f({text:u,snackbarProps:{color:"teal-lighten-1"}}),o.result.errors.length>0&&console.log("無法關聯的管理者:",o.result.errors)}}catch(o){console.error("檢查管理者員工關聯失敗:",o),f({text:((e=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:e.message)||"檢查失敗",snackbarProps:{color:"red-lighten-1"}})}};return(a,e)=>(v(),k(Ke,{"max-width":"1920"},{default:s(()=>{var o,u;return[t(T,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-4 mb-4 bg-white"},{default:s(()=>[t(p,{cols:"12",class:"ps-3 pb-6"},{default:s(()=>e[18]||(e[18]=[m("h3",null,"管理者管理",-1)])),_:1}),t(p,{cols:"12"},{default:s(()=>[t(T,null,{default:s(()=>[t(p,null,{default:s(()=>[t(T,null,{default:s(()=>[t(p,null,{default:s(()=>[t($,{"prepend-icon":"mdi-account-plus",variant:"outlined",color:"blue-grey-darken-1",onClick:e[0]||(e[0]=l=>oe(null))},{default:s(()=>e[19]||(e[19]=[y(" 新增管理者 ")])),_:1}),t($,{"prepend-icon":"mdi-account-search",variant:"outlined",color:"teal-darken-1",class:"ms-4",onClick:Ae},{default:s(()=>e[20]||(e[20]=[y(" 檢查 ")])),_:1})]),_:1}),t(p,{sm:"4",lg:"3",xl:"2"},{default:s(()=>[t(T,{class:"d-flex align-center"},{default:s(()=>[t(p,{class:"d-flex align-center"},{default:s(()=>[n(J)?Me((v(),k(q,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[oa,"可搜尋管理者編號、姓名、Email、備註","start"]]):C("",!0),t(P,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=l=>W.value=l),label:"快速搜尋","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(p,{cols:"12"},{default:s(()=>[(v(),k(Ze,{key:ke.value,"items-per-page":N.value,"onUpdate:itemsPerPage":[e[2]||(e[2]=l=>N.value=l),e[4]||(e[4]=l=>h(!1))],"sort-by":R.value,"onUpdate:sortBy":[e[3]||(e[3]=l=>R.value=l),e[5]||(e[5]=l=>h(!1))],page:U.value,density:"compact",class:"rounded-ts-lg rounded-te-lg py-3","items-per-page-options":[10,20,50],items:b.value,headers:we.value,"header-props":ge,loading:w.value,"items-length":X.value,search:xe.value,hover:"","onUpdate:page":Ue},{item:s(({item:l,index:r})=>[m("tr",{class:Le({"odd-row":r%2===0,"even-row":r%2!==0})},[m("td",null,x(l.adminId),1),m("td",null,x(l.name),1),n(K)?(v(),ae("td",na,x(l.email),1)):C("",!0),n(K)?(v(),ae("td",ra,[l.employeeLink?(v(),k(je,{key:0,location:"end",transition:"fade-transition","open-on-hover":"","close-delay":"30","open-delay":"30",class:"pa-0"},{activator:s(({props:i})=>[m("div",me(i,{class:"d-flex align-center"}),[t(Xe,{size:"small",color:"teal-lighten-1","prepend-icon":"mdi-account-check"},{default:s(()=>e[21]||(e[21]=[y(" 已關聯 ")])),_:1})],16)]),default:s(()=>[t(pe,{"min-width":"200",class:"rounded-lg pa-0 status-card",elevation:"3"},{default:s(()=>[t(ve,{class:"pa-0"},{default:s(()=>{var i,re,ie,ue,de;return[m("div",ia,[t(q,{size:"16",class:"me-2",color:"white"},{default:s(()=>e[22]||(e[22]=[y(" mdi-office-building ")])),_:1}),m("span",null,"公司："+x(((re=(i=l.employeeLink)==null?void 0:i.company)==null?void 0:re.name)||"無"),1)]),m("div",ua,[t(q,{size:"16",class:"me-2",color:"white"},{default:s(()=>e[23]||(e[23]=[y(" mdi-domain ")])),_:1}),m("span",null,"部門："+x(((ue=(ie=l.employeeLink)==null?void 0:ie.department)==null?void 0:ue.name)||"無"),1)]),m("div",da,[t(q,{size:"16",class:"me-2",color:"white"},{default:s(()=>e[24]||(e[24]=[y(" mdi-identifier ")])),_:1}),m("span",null,"科威編號："+x(((de=l.employeeLink)==null?void 0:de.employeeCode)||"無"),1)])]}),_:2},1024)]),_:2},1024)]),_:2},1024)):(v(),ae("span",ma,"無關聯"))])):C("",!0),m("td",null,x(l.note),1),m("td",null,[t($,{icon:"",color:"light-blue-darken-4",variant:"plain",width:"28",size:B.value,ripple:!1,onClick:i=>oe(l)},{default:s(()=>[t(q,null,{default:s(()=>e[25]||(e[25]=[y("mdi-pencil")])),_:1})]),_:2},1032,["size","onClick"])]),m("td",null,[t(Ye,{modelValue:l.isActive,"onUpdate:modelValue":i=>l.isActive=i,color:l.isActive?"teal-darken-1":"grey-darken-4",label:l.isActive?"啟用":"停用","hide-details":"",onClick:ce(i=>_e(l),["prevent"])},null,8,["modelValue","onUpdate:modelValue","color","label","onClick"])])],2)]),_:1},8,["items-per-page","sort-by","page","items","headers","loading","items-length","search"]))]),_:1})]),_:1})]),_:1})]),_:1}),t(sa,{modelValue:g.value.open,"onUpdate:modelValue":e[15]||(e[15]=l=>g.value.open=l),persistent:"",width:Ve.value},{default:s(()=>[t(ea,{disabled:n(Z),onSubmit:ce(n(he),["prevent"])},{default:s(()=>[t(pe,{class:"rounded-lg px-4 py-6"},{default:s(()=>[m("div",ca,x(g.value.id?"管理者資料編輯":"新增管理者"),1),t(ve,{class:"mt-3 pa-3"},{default:s(()=>[t(T,null,{default:s(()=>[c.value?(v(),k(p,{key:0,cols:"12",sm:"6",md:"4"},{default:s(()=>[t(P,{modelValue:n(M).value.value,"onUpdate:modelValue":e[6]||(e[6]=l=>n(M).value.value=l),"error-messages":n(M).errorMessage.value,label:"*管理者編號",type:"text",variant:"outlined",density:"compact",disabled:!c.value},null,8,["modelValue","error-messages","disabled"])]),_:1})):C("",!0),t(p,{cols:"12",sm:"6",md:"4"},{default:s(()=>[t(P,{modelValue:n(D).value.value,"onUpdate:modelValue":e[7]||(e[7]=l=>n(D).value.value=l),"error-messages":n(D).errorMessage.value,label:"*姓名",type:"text",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),t(p,{cols:"12",sm:"6",md:"4"},{default:s(()=>[t(P,{modelValue:n(A).value.value,"onUpdate:modelValue":e[8]||(e[8]=l=>n(A).value.value=l),"error-messages":n(A).errorMessage.value,label:"*Email",type:"email",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),c.value?C("",!0):(v(),k(p,{key:1,cols:"12",sm:"6",md:"4"},{default:s(()=>[t(P,{modelValue:n(F).value.value,"onUpdate:modelValue":e[9]||(e[9]=l=>n(F).value.value=l),"error-messages":n(F).errorMessage.value,type:O.value?"text":"password","append-inner-icon":O.value?"mdi-eye-off":"mdi-eye",label:"*密碼",variant:"outlined",density:"compact","onClick:appendInner":e[10]||(e[10]=l=>O.value=!O.value)},null,8,["modelValue","error-messages","type","append-inner-icon"])]),_:1})),c.value?C("",!0):(v(),k(p,{key:2,cols:"12",sm:"6",md:"4"},{default:s(()=>[t(P,{modelValue:n(H).value.value,"onUpdate:modelValue":e[11]||(e[11]=l=>n(H).value.value=l),"error-messages":n(H).errorMessage.value,type:Q.value?"text":"password","append-inner-icon":Q.value?"mdi-eye-off":"mdi-eye",label:"*確認密碼",variant:"outlined",density:"compact","onClick:appendInner":e[12]||(e[12]=l=>Q.value=!Q.value)},null,8,["modelValue","error-messages","type","append-inner-icon"])]),_:1})),t(p,{cols:"12"},{default:s(()=>[t(P,{modelValue:n(z).value.value,"onUpdate:modelValue":e[13]||(e[13]=l=>n(z).value.value=l),"error-messages":n(z).errorMessage.value,label:"備註",type:"text",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1})]),_:1}),t(aa,{class:"px-3 mt-4"},{default:s(()=>[t(la,null,{default:s(({isHovering:l,props:r})=>[c.value?(v(),k($,me({key:0},r,{color:l?"red-lighten-1":"grey",variant:"outlined","prepend-icon":"mdi-delete",size:B.value,onClick:e[14]||(e[14]=i=>E.value=!0)}),{default:s(()=>e[26]||(e[26]=[y(" 永久刪除 ")])),_:2},1040,["color","size"])):C("",!0)]),_:1}),t(ta),t($,{color:"grey-darken-1",variant:"outlined",size:B.value,loading:n(Z),onClick:Y},{default:s(()=>e[27]||(e[27]=[y(" 取消 ")])),_:1},8,["size","loading"]),t($,{color:"teal-darken-1",variant:"outlined",type:"submit",class:"ms-1",size:B.value,loading:n(Z),disabled:c.value&&!Pe.value},{default:s(()=>e[28]||(e[28]=[y(" 送出 ")])),_:1},8,["size","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue","width"]),t(Qe,{modelValue:E.value,"onUpdate:modelValue":e[16]||(e[16]=l=>E.value=l),title:"確認刪除管理者",message:`確定要刪除管理者「<span class='text-pink-lighten-1' style='font-weight: 800;'>${((o=V.value)==null?void 0:o.name)||""}</span>」嗎？ 此操作無法復原。`,"expected-name":((u=V.value)==null?void 0:u.name)||"","input-label":"管理者",onConfirm:Ce},null,8,["modelValue","message","expected-name"]),t(Ge,{modelValue:G.value,"onUpdate:modelValue":e[17]||(e[17]=l=>G.value=l),width:300,title:"確認停用帳號",message:"確定要停用此帳號嗎？停用後該管理者將無法登入系統。","confirm-button-text":"停用","cancel-button-text":"取消","confirm-button-color":"red-darken-1",onConfirm:$e},null,8,["modelValue"])]}),_:1}))}},Na=He(pa,[["__scopeId","data-v-89b5e152"]]);export{Na as default};

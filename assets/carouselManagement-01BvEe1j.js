import{r as u,w as oe,k as Pe,aV as $,Z as q,bH as s,a8 as l,a0 as n,a7 as d,bJ as Ue,_ as Oe,bf as m,aH as Ie,u as o,bM as Me}from"./@vue-Cr_z6yfx.js";import{i as $e}from"./vuetify-use-dialog-C5oZ13xz.js";import{l as qe}from"./lodash-CiJWSuVn.js";import{_ as Fe,b as Ee}from"./index-n6mFz3XI.js";import{d as Le}from"./vuedraggable-6ak-rXVU.js";import{_ as Be}from"./ConfirmDeleteDialog-CuZPFffe.js";import{u as Ne,a as k}from"./vee-validate-BXV9nMa7.js";import{b as Re,c as F,f as He,d as Qe}from"./yup-WHNMwcW8.js";import{q as We,Q as Je,w as c,v as E,g as v,P as Ye,r as y,d as I,R as Ze,F as G,E as je,p as Ge,a as re,b as ne,f as H,c as ie,U as Ke,Y as Xe,a1 as ea,S as aa,e as ue,V as de,x as ta,y as la,T as sa}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";import"./core-js-D2hAHviU.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./vue-router-BFBClpR6.js";import"./jspdf-DsdNZwtm.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";import"./vue-lrpUOyH4.js";import"./sortablejs-CtLrRV7F.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-DzadwsAs.js";const oa={class:"text-center"},ra={class:"text-truncate",style:{"max-width":"200px"}},na={class:"text-truncate",style:{"max-width":"200px"}},ia={class:"d-flex flex-column"},ua={class:"text-caption text-medium-emphasis"},da={class:"d-flex flex-column"},ca={class:"text-caption text-medium-emphasis"},ma={class:"d-flex align-center gap-1"},pa={class:"card-title text-white"},va={class:"drag-handle cursor-move me-2"},fa={__name:"carouselManagement",setup(ga){const g=$e(),{apiAuth:x}=Ee(),{smAndUp:b}=We(),L=u([]),V=u(!1),B=u(10),C=u(1),K=u(0),f=u({isActive:null,quickSearch:""}),ce=[{title:"全部",value:null},{title:"啟用",value:!0},{title:"停用",value:!1},{title:"已過期",value:"expired"}],me=[{title:"排序",key:"order",sortable:!1,align:"center",width:"80px"},{title:"圖片",key:"image",sortable:!1,width:"80px"},{title:"標題",key:"title",sortable:!0},{title:"描述",key:"description",sortable:!1},{title:"狀態",key:"isActive",sortable:!0},{title:"開始時間",key:"startDate",sortable:!0,width:"120px"},{title:"結束時間",key:"endDate",sortable:!0,width:"120px"},{title:"操作",key:"actions",sortable:!1,width:"120px",align:"center"}],M=u(!1),S=u(!1),N=u(!1),pe=Re({title:F().required("請輸入標題"),description:F().max(200,"描述不能超過200字"),link:F().transform(t=>t===""?null:t).url("請輸入有效的網址").nullable(),order:He().min(1,"排序必須大於0").required("請輸入排序"),image:Qe().when("$isEditing",{is:!1,then:t=>t.required("請上傳輪播圖片"),otherwise:t=>t.nullable()}),startDateTime:F().transform(t=>t===""?null:t).nullable(),endDateTime:F().transform(t=>t===""?null:t).nullable()}),{handleSubmit:ve,resetForm:X}=Ne({validationSchema:pe,validateOnMount:!1,initialValues:{title:"",description:"",link:"",order:1,image:null,isActive:!0,startDateTime:"",endDateTime:""}}),z=k("title"),T=k("description"),A=k("link"),P=k("image"),D=k("order"),U=k("isActive"),w=k("startDateTime"),h=k("endDateTime"),Q=u({_id:null}),O=u(!1),W=u(!1),ee=u(!1),J=u(!1),R=u([]),Y=u(null),fe=u(null),_=async()=>{var t,e;try{V.value=!0;const r={page:C.value,itemsPerPage:B.value};f.value.isActive!==null&&(f.value.isActive==="expired"?r.expired=!0:r.isActive=f.value.isActive),f.value.quickSearch&&(r.quickSearch=f.value.quickSearch);const a=await x.get("/carousels",{params:r});L.value=a.data.result.data,K.value=a.data.result.totalItems}catch(r){console.error("載入輪播圖錯誤:",r),g({text:((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.message)||r.message||"載入輪播圖失敗",snackbarProps:{color:"red-lighten-1"}})}finally{V.value=!1}},ae=async()=>{C.value=1,await _()},ge=qe.debounce(()=>{C.value=1,V.value=!0,ae().finally(()=>{V.value=!1})},300),be=t=>{t.page!==void 0&&(C.value=t.page),t.itemsPerPage!==void 0&&(B.value=t.itemsPerPage),_()},ye=async()=>{await xe(),M.value=!0},xe=async()=>{O.value=!1,X();try{const p=(await x.get("/carousels/max-order")).data.result||0;D.value.value=p+1}catch(i){console.error("取得最大排序值錯誤:",i);const p=L.value.length>0?Math.max(...L.value.map(Ae=>Ae.order||0)):0;D.value.value=p+1}z.value.value="",T.value.value="",A.value.value="",P.value.value=null,U.value.value=!0;const t=new Date,e=t.getTimezoneOffset()*6e4,a=new Date(t.getTime()-e).toISOString().slice(0,16);w.value.value=a,h.value.value=""},ke=t=>{O.value=!0;let e="";if(t.startDate){const a=new Date(t.startDate),i=a.getTimezoneOffset()*6e4;e=new Date(a.getTime()-i).toISOString().slice(0,16)}let r="";if(t.endDate){const a=new Date(t.endDate),i=a.getTimezoneOffset()*6e4;r=new Date(a.getTime()-i).toISOString().slice(0,16)}z.value.value=t.title,T.value.value=t.description||"",A.value.value=t.link||"",P.value.value=null,D.value.value=t.order,U.value.value=t.isActive,w.value.value=e,h.value.value=r,Q.value={_id:t._id},M.value=!0},te=ve(async t=>{var e,r;try{W.value=!0;const a=new FormData;a.append("title",t.title),a.append("description",t.description||""),a.append("link",t.link||""),a.append("order",t.order),a.append("isActive",U.value.value),t.startDateTime?a.append("startDate",new Date(t.startDateTime).toISOString()):a.append("startDate",""),t.endDateTime?a.append("endDate",new Date(t.endDateTime).toISOString()):a.append("endDate",""),t.image&&a.append("image",t.image);let i;if(O.value){const p=Q.value._id;i=await x.patch(`/carousels/${p}`,a,{headers:{"Content-Type":"multipart/form-data"}})}else i=await x.post("/carousels",a,{headers:{"Content-Type":"multipart/form-data"}});g({text:i.data.message,snackbarProps:{color:"teal-lighten-1"}}),Z(),_()}catch(a){console.error("提交錯誤:",a),g({text:((r=(e=a.response)==null?void 0:e.data)==null?void 0:r.message)||a.message||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}finally{W.value=!1}}),Ve=async t=>{var e,r;try{const a=await x.patch(`/carousels/${t._id}/toggle`);g({text:a.data.message,snackbarProps:{color:"teal-lighten-1"}}),_()}catch(a){console.error("切換狀態錯誤:",a),g({text:((r=(e=a.response)==null?void 0:e.data)==null?void 0:r.message)||a.message||"切換狀態失敗",snackbarProps:{color:"red-lighten-1"}})}},De=t=>{Y.value=t,N.value=!0},we=async()=>{var t,e;try{ee.value=!0;const r=await x.delete(`/carousels/${Y.value._id}`);g({text:r.data.message,snackbarProps:{color:"teal-lighten-1"}}),N.value=!1,_()}catch(r){console.error("刪除錯誤:",r),g({text:((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.message)||r.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}finally{ee.value=!1}},Z=()=>{M.value=!1,O.value=!1,X(),U.value.value=!0,w.value.value="",h.value.value="",Q.value={_id:null}},he=async()=>{var t,e;try{const r={page:1,itemsPerPage:9999};return(await x.get("/carousels",{params:r})).data.result.data||[]}catch(r){return console.error("載入輪播圖錯誤:",r),g({text:((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.message)||r.message||"載入輪播圖失敗",snackbarProps:{color:"red-lighten-1"}}),[]}},_e=async()=>{const t=await he();R.value=[...t].sort((e,r)=>e.order-r.order),S.value=!0},Ce=async()=>{var t,e;try{J.value=!0;const r=R.value.map((i,p)=>({id:i._id,order:p+1})),a=await x.patch("/carousels/order/update",{carousels:r});g({text:a.data.message,snackbarProps:{color:"teal-lighten-1"}}),S.value=!1,_()}catch(r){console.error("更新順序錯誤:",r),g({text:((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.message)||r.message||"更新順序失敗",snackbarProps:{color:"red-lighten-1"}})}finally{J.value=!1}},Se=t=>{t.target.src="/image/placeholder.png"},j=t=>{if(!t.endDate)return!1;const e=new Date;return new Date(t.endDate)<e},ze=t=>j(t)?"已過期":t.isActive?"啟用":"停用",Te=t=>j(t)?"orange-darken-1":t.isActive?"green-darken-1":"grey-darken-1",le=t=>t?new Date(t).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}):"",se=t=>t?new Date(t).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!1}):"";return oe(()=>f.value.quickSearch,t=>{ge(t)}),oe(()=>f.value.isActive,()=>{C.value=1,V.value=!0,ae().finally(()=>{V.value=!1})}),Pe(()=>{_()}),(t,e)=>($(),q(Je,{"max-width":"1600"},{default:s(()=>{var r;return[l(E,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-4 mb-4 bg-white"},{default:s(()=>[l(c,{cols:"12",class:"ps-3 pb-6"},{default:s(()=>e[17]||(e[17]=[n("h3",null,"輪播圖管理",-1)])),_:1}),l(c,{cols:"12"},{default:s(()=>[l(E,null,{default:s(()=>[l(c,null,{default:s(()=>[l(E,null,{default:s(()=>[l(c,null,{default:s(()=>[l(v,{"prepend-icon":"mdi-image-plus",variant:"outlined",color:"teal-darken-1",class:"me-4",onClick:ye},{default:s(()=>e[18]||(e[18]=[d(" 新增輪播圖 ")])),_:1}),l(v,{"prepend-icon":"mdi-sort",variant:"outlined",color:"blue-grey-darken-2",onClick:_e},{default:s(()=>e[19]||(e[19]=[d(" 排序 ")])),_:1})]),_:1}),l(c,{sm:"3",lg:"2",xl:"1",class:"pe-1"},{default:s(()=>[l(Ye,{modelValue:f.value.isActive,"onUpdate:modelValue":e[0]||(e[0]=a=>f.value.isActive=a),items:ce,"item-title":"title","item-value":"value",label:"狀態篩選",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),l(c,{sm:"4",lg:"3",xl:"2"},{default:s(()=>[l(E,{class:"d-flex align-center"},{default:s(()=>[l(c,{class:"d-flex align-center"},{default:s(()=>[t.mdAndUp?Ue(($(),q(y,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[sa,"可搜尋標題或描述","top"]]):Oe("",!0),l(I,{modelValue:f.value.quickSearch,"onUpdate:modelValue":e[1]||(e[1]=a=>f.value.quickSearch=a),label:"快速搜尋","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(c,{cols:"12"},{default:s(()=>[l(Ze,{"items-per-page":B.value,"onUpdate:itemsPerPage":e[2]||(e[2]=a=>B.value=a),headers:me,items:L.value,loading:V.value,page:C.value,"items-length":K.value,class:"elevation-0 rounded","onUpdate:options":be},{item:s(({item:a,index:i})=>[n("tr",{class:Ie({"odd-row":i%2===0,"even-row":i%2!==0})},[n("td",oa,[l(G,{size:"small",color:"blue-grey",variant:"tonal"},{default:s(()=>[d(m(a.order||0),1)]),_:2},1024)]),n("td",null,[l(je,{size:"60",class:"rounded-lg my-2"},{default:s(()=>[l(Ge,{src:a.image,alt:a.title,cover:"",onError:Se},null,8,["src","alt"])]),_:2},1024)]),n("td",null,[n("div",ra,m(a.title),1)]),n("td",null,[n("div",na,m(a.description||"無"),1)]),n("td",null,[l(G,{color:Te(a),size:"small"},{default:s(()=>[d(m(ze(a)),1)]),_:2},1032,["color"])]),n("td",null,[n("div",ia,[n("span",null,m(le(a.startDate)),1),n("span",ua,m(se(a.startDate)),1)])]),n("td",null,[n("div",da,[n("span",null,m(le(a.endDate)),1),n("span",ca,m(se(a.endDate)),1)])]),n("td",null,[n("div",ma,[l(v,{icon:"",size:"small",color:"blue",variant:"text",onClick:p=>ke(a)},{default:s(()=>[l(y,{size:"18"},{default:s(()=>e[20]||(e[20]=[d(" mdi-pencil ")])),_:1})]),_:2},1032,["onClick"]),j(a)?($(),q(v,{key:1,icon:"",size:"small",color:"grey-darken-4",variant:"text",disabled:""},{default:s(()=>[l(y,{size:"18"},{default:s(()=>e[21]||(e[21]=[d(" mdi-clock-alert ")])),_:1})]),_:1})):($(),q(v,{key:0,icon:"",size:"small",color:a.isActive?"orange":"green",variant:"text",onClick:p=>Ve(a)},{default:s(()=>[l(y,{size:"18"},{default:s(()=>[d(m(a.isActive?"mdi-pause":"mdi-play"),1)]),_:2},1024)]),_:2},1032,["color","onClick"])),l(v,{icon:"",size:"small",color:"red",variant:"text",onClick:p=>De(a)},{default:s(()=>[l(y,{size:"18"},{default:s(()=>e[22]||(e[22]=[d(" mdi-delete ")])),_:1})]),_:2},1032,["onClick"])])])],2)]),_:1},8,["items-per-page","items","loading","page","items-length"])]),_:1})]),_:1})]),_:1})]),_:1}),l(de,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=a=>M.value=a),"max-width":"600",persistent:""},{default:s(()=>[l(re,{class:"rounded-lg"},{default:s(()=>[l(ne,{class:"d-flex align-center px-6 py-2 bg-teal-darken-1"},{default:s(()=>[l(y,{icon:"mdi-image-plus",size:o(b)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),n("span",pa,m(O.value?"編輯輪播圖":"新增輪播圖"),1),l(H),l(v,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:o(b)?"36":"32",onClick:Z},{default:s(()=>[l(y,{size:o(b)?"22":"18"},{default:s(()=>e[23]||(e[23]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),l(ie,{class:"px-6 py-4 mt-4"},{default:s(()=>[l(Ke,{ref_key:"formRef",ref:fe,onSubmit:Me(o(te),["prevent"])},{default:s(()=>[l(E,null,{default:s(()=>[l(c,{cols:"12"},{default:s(()=>[l(Xe,{modelValue:o(P).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>o(P).value.value=a),"error-messages":o(P).meta.touched?o(P).errorMessage.value:[],label:"輪播圖片 *",variant:"outlined",density:"compact",accept:"image/*","prepend-icon":"mdi-image","show-size":"",counter:""},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"12"},{default:s(()=>[l(I,{modelValue:o(z).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>o(z).value.value=a),"error-messages":o(z).meta.touched?o(z).errorMessage.value:[],label:"標題",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"12"},{default:s(()=>[l(ea,{modelValue:o(T).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>o(T).value.value=a),"error-messages":o(T).meta.touched?o(T).errorMessage.value:[],label:"描述",variant:"outlined",density:"compact",rows:"3",counter:"200"},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"12"},{default:s(()=>[l(I,{modelValue:o(A).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>o(A).value.value=a),"error-messages":o(A).meta.touched?o(A).errorMessage.value:[],label:"連結網址",variant:"outlined",density:"compact",placeholder:"https://example.com"},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"6"},{default:s(()=>[l(I,{modelValue:o(D).value.value,"onUpdate:modelValue":e[7]||(e[7]=a=>o(D).value.value=a),modelModifiers:{number:!0},"error-messages":o(D).meta.touched?o(D).errorMessage.value:[],label:"排序",variant:"outlined",density:"compact",type:"number",min:"1"},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"6"},{default:s(()=>[l(aa,{modelValue:o(U).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>o(U).value.value=a),label:"啟用狀態",color:"green","hide-details":""},null,8,["modelValue"])]),_:1}),l(c,{cols:"6"},{default:s(()=>[l(I,{modelValue:o(w).value.value,"onUpdate:modelValue":e[9]||(e[9]=a=>o(w).value.value=a),"error-messages":o(w).meta.touched?o(w).errorMessage.value:[],label:"開始時間",type:"datetime-local",variant:"outlined",density:"compact","prepend-icon":"mdi-calendar-clock","hide-details":"",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),l(c,{cols:"6"},{default:s(()=>[l(I,{modelValue:o(h).value.value,"onUpdate:modelValue":e[10]||(e[10]=a=>o(h).value.value=a),"error-messages":o(h).meta.touched?o(h).errorMessage.value:[],label:"結束時間",type:"datetime-local",variant:"outlined",density:"compact","prepend-icon":"mdi-calendar-clock","hide-details":"",clearable:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1}),l(ue,{class:"px-6 pb-5 pt-1"},{default:s(()=>[l(H),l(v,{variant:"outlined",color:"grey-darken-1",size:o(b)?"default":"small",onClick:Z},{default:s(()=>e[24]||(e[24]=[d(" 取消 ")])),_:1},8,["size"]),l(v,{color:"teal-darken-1",variant:"outlined",class:"ms-2",size:o(b)?"default":"small",loading:W.value,onClick:o(te)},{default:s(()=>[d(m(O.value?"更新":"新增"),1)]),_:1},8,["size","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(de,{modelValue:S.value,"onUpdate:modelValue":e[15]||(e[15]=a=>S.value=a),"max-width":"400"},{default:s(()=>[l(re,{class:"rounded-lg"},{default:s(()=>[l(ne,{class:"d-flex align-center px-6 py-2 bg-blue-grey-darken-2"},{default:s(()=>[l(y,{icon:"mdi-sort",size:o(b)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),e[26]||(e[26]=n("span",{class:"card-title text-white"},"輪播圖排序",-1)),l(H),l(v,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:o(b)?"36":"32",onClick:e[12]||(e[12]=a=>S.value=!1)},{default:s(()=>[l(y,{size:o(b)?"22":"18"},{default:s(()=>e[25]||(e[25]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),l(ie,{class:"px-6 py-4"},{default:s(()=>[e[28]||(e[28]=n("div",{class:"text-subtitle-1 mb-4"}," 拖拽調整輪播圖顯示順序 ",-1)),l(o(Le),{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=a=>R.value=a),"item-key":"_id",class:"sortable-list",handle:".drag-handle",animation:"200","ghost-class":"ghost-item","chosen-class":"chosen-item"},{item:s(({element:a,index:i})=>[($(),q(ta,{key:a._id,class:"border rounded mb-2"},{prepend:s(()=>[n("div",va,[l(y,{color:"grey-darken-1"},{default:s(()=>e[27]||(e[27]=[d(" mdi-drag-vertical ")])),_:1})])]),append:s(()=>[l(G,{size:"small",color:"blue-grey"},{default:s(()=>[d(m(i+1),1)]),_:2},1024)]),default:s(()=>[l(la,null,{default:s(()=>[d(m(a.title),1)]),_:2},1024)]),_:2},1024))]),_:1},8,["modelValue"])]),_:1}),l(ue,{class:"px-6 pb-5 pt-0"},{default:s(()=>[l(H),l(v,{variant:"outlined",color:"grey-darken-1",size:o(b)?"default":"small",onClick:e[14]||(e[14]=a=>S.value=!1)},{default:s(()=>e[29]||(e[29]=[d(" 取消 ")])),_:1},8,["size"]),l(v,{color:"blue-grey-darken-2",variant:"outlined",class:"ms-2",size:o(b)?"default":"small",loading:J.value,onClick:Ce},{default:s(()=>e[30]||(e[30]=[d(" 更新 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Be,{modelValue:N.value,"onUpdate:modelValue":e[16]||(e[16]=a=>N.value=a),width:320,title:"確認刪除輪播圖",message:`確定要刪除「${((r=Y.value)==null?void 0:r.title)||""}」嗎？此操作無法復原。`,"confirm-button-color":"red-lighten-1","cancel-button-color":"grey-darken-1","confirm-button-text":"刪除","cancel-button-text":"取消",onConfirm:we},null,8,["modelValue","message"])]}),_:1}))}},Wa=Fe(fa,[["__scopeId","data-v-15c068be"]]);export{Wa as default};

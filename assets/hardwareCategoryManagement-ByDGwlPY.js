import{f as K,r as m,w as le,k as $e,aV as o,Z as n,bH as a,a8 as l,a0 as c,bJ as w,a7 as p,$,b0 as Q,bf as q,F as R,_ as P,bM as se,u as N,b as re,aG as qe,bK as Pe}from"./@vue-Cr_z6yfx.js";import{u as Ne}from"./vue-router-CS4OewbW.js";import{u as Te,a as oe}from"./vee-validate-BXV9nMa7.js";import{_ as Be,u as Me,b as Fe}from"./index-ZcDhEpUM.js";import{i as Ae}from"./vuetify-use-dialog-C5oZ13xz.js";import{C as Le}from"./ConfirmDeleteDialogWithTextField-DtpfDroW.js";import{b as je,c as ne}from"./yup-WHNMwcW8.js";import{l as Ke}from"./lodash-CiJWSuVn.js";import{q as Re,Q as We,w as h,r as C,d as T,v as Z,a as W,g as v,D as ue,x as H,y as ie,ab as de,U as me,c as pe,e as ce,W as He,f as ve,V as fe,T as _}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./jspdf-DacfHTdZ.js";import"./core-js-D2hAHviU.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-DzadwsAs.js";const Oe={style:{width:"260px"},class:"ms-auto d-flex align-center"},Ge={class:"card-title mt-3 mb-2 mx-6 d-flex align-center justify-space-between"},Je={class:"order-number"},Qe={class:"card-title mt-3 mb-2 mx-6 d-flex align-center justify-space-between"},Ze={class:"order-number"},Xe={class:"card-title px-4 pb-2 d-flex align-center justify-space-between"},Ye={key:0,class:"d-flex align-center"},ea={class:"d-flex align-center item-container"},aa={__name:"hardwareCategoryManagement",setup(ta){const{apiAuth:z}=Fe(),ge=Me(),S=Ae(),ye=Ne(),{smAndUp:O}=Re(),G=K(()=>O.value?"default":"small"),B=m(!1),V=m(null),y=m(!1),f=m([{name:"",error:""}]),U=m(null),be=je({name:ne().required("請輸入名稱"),order:ne().required("請輸入排序").test("is-number","排序必須大於0",s=>{if(!s)return!0;const e=Number(s);return!isNaN(e)&&e>=1})}),{handleSubmit:Ve}=Te({validationSchema:be}),{value:x,errorMessage:xe}=oe("name"),{value:k,errorMessage:ke}=oe("order"),r=m({open:!1,id:"",type:0}),we=K(()=>O.value?"360":"100%"),M=m([]),F=m([]),he=K(()=>["新增硬體類型 ( 設備 )","新增硬體類型 ( 維修 )"][r.value.type]),Ce=K(()=>r.value.id?V.value?V.value.name!==x.value||V.value.order!==parseInt(k.value):!1:!0),E=m(""),A=m(!1),_e=Ke.debounce(()=>{D()},300);le(E,()=>{A.value=!0,b.value={0:1,1:1},_e()});const D=async(s=null)=>{try{A.value=!0;const e={page0:b.value[0],page1:b.value[1]};E.value&&(e.quickSearch=E.value);const{data:i}=await z.get("/hardware/categories/all",{params:e});if(i.success){const u=i.result.data.reduce((t,d)=>(d.type===0?t.equipment.push(d):t.maintenance.push(d),t),{equipment:[],maintenance:[]});s===0?M.value=u.equipment:(s===1||(M.value=u.equipment),F.value=u.maintenance),I.value=i.result.totalPages}}catch(e){j(e)}finally{A.value=!1}},X=async s=>{r.value={open:!0,id:"",type:s},U.value&&U.value.reset(),x.value="",k.value="",f.value=[{name:"",error:""}]},Y=async s=>{try{r.value={open:!0,id:s._id,type:s.type},x.value=s.name,k.value=s.order,V.value={...s}}catch(e){console.error("編輯項目時發生錯誤:",e),j(e)}},L=()=>{r.value={open:!1,id:"",type:r.value.type},V.value=null,U.value&&U.value.reset(),x.value="",k.value="",f.value=[{name:"",error:""}]},De=()=>{let s=!1;return f.value.forEach(e=>{e.error="",e.name.trim()||(e.error="請輸入名稱",s=!0)}),!s},ze=async s=>{if(s.preventDefault(),!y.value)try{if(y.value=!0,r.value.id)await Ve(async e=>{const i={name:e.name,type:r.value.type,order:parseInt(e.order)},{data:u}=await z.patch(`/hardware/categories/${r.value.id}`,i);if(!u.success)throw new Error(u.message||"更新失敗");S({text:"類型更新成功",snackbarProps:{color:"teal-lighten-1"}}),L(),D(r.value.type)})();else{if(!De()){y.value=!1;return}const e=f.value.filter(t=>t.name.trim());if(e.length===0){y.value=!1;return}const{data:i}=await z.get("/hardware/categories/max-order",{params:{type:r.value.type}});if(!i.success)throw new Error("獲取排序失敗");let u=i.result;for(const t of e){const{data:d}=await z.post("/hardware/categories",{name:t.name.trim(),type:r.value.type,order:u++});if(!d.success)throw new Error(d.message||"新增失敗")}S({text:"類型新增成功",snackbarProps:{color:"teal-lighten-1"}}),L(),D(r.value.type)}}catch(e){console.error("提交時發生錯誤:",e),j(e)}finally{y.value=!1}},Se=async()=>{if(r.value.id)try{const s=r.value.type;await z.delete(`/hardware/categories/${r.value.id}`),S({text:"類型刪除成功",snackbarProps:{color:"teal-lighten-1"}}),L(),D(s)}catch(s){j(s)}finally{B.value=!1}},j=s=>{var i,u,t;console.error("Error:",s);const e=((u=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:u.message)||"操作失敗";((t=s==null?void 0:s.response)==null?void 0:t.status)===401?(ge.logout(),ye.push("/login"),S({text:"登入已過期，請重新登入",snackbarProps:{color:"red-lighten-1"}})):S({text:e,snackbarProps:{color:"red-lighten-1"}})},b=m({0:1,1:1}),I=m({0:1,1:1}),ee=(s,e)=>{b.value[s]=e,D(s)},g=m({open:!1,count:"",error:""}),Ue=()=>{g.value={open:!0,count:"",error:""}},ae=()=>{g.value.open=!1},te=()=>{const s=parseInt(g.value.count);if(!s||s<1||s>10){g.value.error="請輸入1-10之間的數字";return}g.value.error="",f.value=Array(s).fill(null).map(()=>({name:"",error:""})),ae()},Ee=()=>{f.value.push({name:"",error:""})},Ie=s=>{f.value.splice(s,1)};return le(f,s=>{s.forEach(e=>{e.name.trim()&&(e.error="")})},{deep:!0}),$e(async()=>{await D()}),(s,e)=>(o(),n(We,{"max-width":"880"},{default:a(()=>{var i,u;return[l(Z,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-4 mb-4 bg-white"},{default:a(()=>[l(h,{cols:"12",class:"ps-3 pb-3 d-flex align-center"},{default:a(()=>[e[14]||(e[14]=c("h3",{class:"d-inline"}," 硬體類型管理 ",-1)),c("div",Oe,[w(l(C,{icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-2"},null,512),[[_,"可搜尋各類型名稱","start"]]),l(T,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=t=>E.value=t),label:"快速搜尋","append-inner-icon":"mdi-magnify",loading:A.value,"base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","loading"])])]),_:1}),l(h,{cols:"12",class:"mt-4"},{default:a(()=>[l(Z,{class:"d-flex justify-space-between"},{default:a(()=>[l(h,{cols:"12",md:"5",class:"custom-col"},{default:a(()=>[l(W,{class:"hardware-category-card",elevation:"0"},{default:a(()=>[c("div",Ge,[e[15]||(e[15]=p(" 硬體類型 (設備) ")),w((o(),n(v,{icon:"",size:"small",variant:"plain",color:"teal-darken-1",onClick:e[1]||(e[1]=t=>X(0))},{default:a(()=>[l(C,{icon:"mdi-plus",size:"24"})]),_:1})),[[_,"新增硬體設備類型","start"]])]),l(ue,null,{default:a(()=>[M.value.length>0?(o(!0),$(R,{key:0},Q(M.value,t=>(o(),n(H,{key:t._id},{prepend:a(()=>[c("div",Je,q(t.order),1)]),append:a(()=>[w((o(),n(v,{icon:"",color:"light-blue-darken-4",variant:"plain",size:"small",onClick:d=>Y(t)},{default:a(()=>[l(C,null,{default:a(()=>e[16]||(e[16]=[p("mdi-pencil")])),_:1})]),_:2},1032,["onClick"])),[[_,"編輯類型","start"]])]),default:a(()=>[l(ie,{class:"ms-2"},{default:a(()=>[p(q(t.name),1)]),_:2},1024)]),_:2},1024))),128)):(o(),n(H,{key:1,class:"bg-white"},{default:a(()=>e[17]||(e[17]=[c("div",{class:"text-center w-100 text-grey"}," 沒有資料 ",-1)])),_:1}))]),_:1}),I.value[0]>1?(o(),n(de,{key:0,modelValue:b.value[0],"onUpdate:modelValue":[e[2]||(e[2]=t=>b.value[0]=t),e[3]||(e[3]=t=>ee(0,t))],length:I.value[0],"total-visible":5,density:"compact",class:"mt-2 pb-2 px-2"},null,8,["modelValue","length"])):P("",!0)]),_:1})]),_:1}),l(h,{cols:"12",md:"5",class:"custom-col"},{default:a(()=>[l(W,{class:"hardware-category-card",elevation:"0"},{default:a(()=>[c("div",Qe,[e[18]||(e[18]=p(" 硬體類型 (維修) ")),w((o(),n(v,{icon:"",size:"small",variant:"plain",color:"teal-darken-1",onClick:e[4]||(e[4]=t=>X(1))},{default:a(()=>[l(C,{icon:"mdi-plus",size:"24"})]),_:1})),[[_,"新增硬體維修紀錄類型","start"]])]),l(ue,null,{default:a(()=>[F.value.length>0?(o(!0),$(R,{key:0},Q(F.value,t=>(o(),n(H,{key:t._id},{prepend:a(()=>[c("div",Ze,q(t.order),1)]),append:a(()=>[w((o(),n(v,{icon:"",color:"light-blue-darken-4",variant:"plain",size:"small",onClick:d=>Y(t)},{default:a(()=>[l(C,null,{default:a(()=>e[19]||(e[19]=[p("mdi-pencil")])),_:1})]),_:2},1032,["onClick"])),[[_,"編輯類型","start"]])]),default:a(()=>[l(ie,{class:"ms-2"},{default:a(()=>[p(q(t.name),1)]),_:2},1024)]),_:2},1024))),128)):(o(),n(H,{key:1,class:"bg-white"},{default:a(()=>e[20]||(e[20]=[c("div",{class:"text-center w-100 text-grey"}," 沒有資料 ",-1)])),_:1}))]),_:1}),I.value[1]>1?(o(),n(de,{key:0,modelValue:b.value[1],"onUpdate:modelValue":[e[5]||(e[5]=t=>b.value[1]=t),e[6]||(e[6]=t=>ee(1,t))],length:I.value[1],"total-visible":5,density:"compact",class:"mt-2 pb-2 px-2"},null,8,["modelValue","length"])):P("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(fe,{modelValue:r.value.open,"onUpdate:modelValue":e[10]||(e[10]=t=>r.value.open=t),persistent:"",width:we.value,fullscreen:!N(O)},{default:a(()=>[l(me,{ref_key:"form",ref:U,disabled:y.value,onSubmit:se(ze,["prevent"])},{default:a(()=>[l(W,{class:"rounded-lg px-4 pt-7 pb-6"},{default:a(()=>[c("div",Xe,[c("span",null,q(r.value.id?"編輯類型":he.value),1),r.value.id?P("",!0):(o(),$("div",Ye,[w((o(),n(v,{icon:"",color:"grey-darken-1",size:"22",class:"me-2",onClick:Ue},{default:a(()=>[l(C,{size:"14"},{default:a(()=>e[21]||(e[21]=[p(" mdi-plus-box-multiple-outline ")])),_:1})]),_:1})),[[_,"批量新增項目","start"]]),w((o(),n(v,{icon:"",color:"grey-darken-1",size:"22",onClick:Ee},{default:a(()=>[l(C,{size:"14"},{default:a(()=>e[22]||(e[22]=[p(" mdi-plus ")])),_:1})]),_:1})),[[_,"新增項目","start"]])]))]),l(pe,{class:"mt-3 pa-3"},{default:a(()=>[l(Z,null,{default:a(()=>[r.value.id?(o(),$(R,{key:1},[l(h,{cols:"12"},{default:a(()=>[l(T,{modelValue:N(x),"onUpdate:modelValue":e[7]||(e[7]=t=>re(x)?x.value=t:null),"error-messages":N(xe),label:"*名稱",type:"text",variant:"outlined",density:"compact",clearable:"","hide-details":"auto"},null,8,["modelValue","error-messages"])]),_:1}),l(h,{cols:"12"},{default:a(()=>[l(T,{modelValue:N(k),"onUpdate:modelValue":e[8]||(e[8]=t=>re(k)?k.value=t:null),"error-messages":N(ke),label:"*排序",variant:"outlined",density:"compact",hint:"輸入想要的順序位置，其他項目會自動調整","persistent-hint":""},null,8,["modelValue","error-messages"])]),_:1})],64)):(o(!0),$(R,{key:0},Q(f.value,(t,d)=>(o(),n(h,{key:d,cols:"12"},{default:a(()=>[c("div",ea,[l(T,{modelValue:t.name,"onUpdate:modelValue":J=>t.name=J,"error-messages":t.error,label:"*名稱",type:"text",variant:"outlined",density:"compact",clearable:"","hide-details":"auto"},null,8,["modelValue","onUpdate:modelValue","error-messages"]),f.value.length>1?(o(),n(v,{key:0,icon:"mdi-delete",variant:"text",color:"red-lighten-1",size:"small",class:"ms-2",onClick:J=>Ie(d)},null,8,["onClick"])):P("",!0)])]),_:2},1024))),128))]),_:1})]),_:1}),l(ce,{class:"px-3 pt-4"},{default:a(()=>[l(He,null,{default:a(({isHovering:t,props:d})=>[r.value.id?(o(),n(v,qe({key:0},d,{color:t?"red-lighten-1":"grey",variant:"outlined",size:G.value,"prepend-icon":"mdi-delete",onClick:e[9]||(e[9]=J=>B.value=!0)}),{default:a(()=>e[23]||(e[23]=[p(" 刪除 ")])),_:2},1040,["color","size"])):P("",!0)]),_:1}),l(ve),l(v,{color:"grey-darken-1",variant:"outlined",size:G.value,loading:y.value,onClick:L},{default:a(()=>e[24]||(e[24]=[p(" 取消 ")])),_:1},8,["size","loading"]),l(v,{color:"teal-darken-1",variant:"outlined",type:"submit",class:"ms-1",size:G.value,loading:y.value,disabled:r.value.id&&!Ce.value||y.value},{default:a(()=>e[25]||(e[25]=[p(" 送出 ")])),_:1},8,["size","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["disabled"])]),_:1},8,["modelValue","width","fullscreen"]),l(Le,{modelValue:B.value,"onUpdate:modelValue":e[11]||(e[11]=t=>B.value=t),title:"確認刪除類型",message:`確定要刪除「<span class='text-pink-lighten-1' style='font-weight: 800;'>${((i=V.value)==null?void 0:i.name)||""}</span>」嗎？ 此操作無法復原。`,"expected-name":((u=V.value)==null?void 0:u.name)||"","input-label":"類型名稱",onConfirm:Se},null,8,["modelValue","message","expected-name"]),l(fe,{modelValue:g.value.open,"onUpdate:modelValue":e[13]||(e[13]=t=>g.value.open=t),persistent:"",width:"300"},{default:a(()=>[l(W,{class:"rounded-lg px-3 pt-6 pb-4"},{default:a(()=>[l(me,{onSubmit:se(te,["prevent"])},{default:a(()=>[e[28]||(e[28]=c("div",{class:"card-title px-4 pb-2"}," 批量新增項目 ",-1)),l(pe,{class:"mt-3 pa-3"},{default:a(()=>[l(T,{modelValue:g.value.count,"onUpdate:modelValue":e[12]||(e[12]=t=>g.value.count=t),label:"請輸入要總共需要多少項目",type:"number",min:"1",max:"50",variant:"outlined",density:"compact","error-messages":g.value.error,"hide-details":"auto",onKeyup:Pe(te,["enter"])},null,8,["modelValue","error-messages"])]),_:1}),l(ce,{class:"px-3 pt-4"},{default:a(()=>[l(ve),l(v,{color:"grey-darken-1",variant:"outlined",onClick:ae},{default:a(()=>e[26]||(e[26]=[p(" 取消 ")])),_:1}),l(v,{color:"teal-darken-1",variant:"outlined",class:"ms-1",type:"submit"},{default:a(()=>e[27]||(e[27]=[p(" 確定 ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]}),_:1}))}},Ua=Be(aa,[["__scopeId","data-v-745118bd"]]);export{Ua as default};

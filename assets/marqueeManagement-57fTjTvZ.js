import{r as i,w as N,k as Ce,aV as ee,Z as te,bH as s,a8 as a,a0 as r,a7 as d,bf as c,aH as Se,u as f,bM as Ae}from"./@vue-Cr_z6yfx.js";import{i as Pe}from"./vuetify-use-dialog-C5oZ13xz.js";import{l as qe}from"./lodash-CiJWSuVn.js";import{_ as Te,b as Ue}from"./index-n6mFz3XI.js";import{d as Oe}from"./vuedraggable-6ak-rXVU.js";import{_ as Ie}from"./ConfirmDeleteDialog-CuZPFffe.js";import{_ as $e}from"./ConfirmDialog-CJtUY0XN.js";import{q as Me,Q as Fe,w as m,v as U,g as v,P as E,d as O,R as Be,F as C,r as V,a as ae,b as le,f as I,c as se,U as Le,S as Ne,a1 as Ee,e as oe,V as ne,x as Re,y as He}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";import"./core-js-D2hAHviU.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./vue-router-BFBClpR6.js";import"./jspdf-DsdNZwtm.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";import"./vue-lrpUOyH4.js";import"./sortablejs-CtLrRV7F.js";const Qe={class:"text-center"},We={class:"text-truncate",style:{"max-width":"200px"}},je={class:"d-flex flex-column"},Ze={class:"text-caption text-medium-emphasis"},Ge={class:"d-flex flex-column"},Je={class:"text-caption text-medium-emphasis"},Ke={class:"d-flex align-center gap-1 justify-center"},Xe={class:"card-title text-white"},Ye={class:"drag-handle cursor-move me-2"},et={class:"text-truncate",style:{"max-width":"420px",display:"inline-block","vertical-align":"middle"}},tt={__name:"marqueeManagement",setup(at){const p=Pe(),{apiAuth:y}=Ue(),{smAndUp:g}=Me(),S=i([]),b=i(!1),A=i(10),w=i(1),R=i(0),u=i({type:null,isActive:null,quickSearch:""}),H=[{label:"一般",value:"announcement"},{label:"系統",value:"system"},{label:"更新",value:"update"},{label:"維護",value:"maintenance"},{label:"活動",value:"event"}],re=[{title:"全部",value:null},...H.map(l=>({title:l.label,value:l.value}))],ie=[{title:"全部",value:null},{title:"啟用",value:!0},{title:"停用",value:!1},{title:"已過期",value:"expired"}],de=[{title:"排序",key:"order",sortable:!1,align:"center"},{title:"類型",key:"type",sortable:!0},{title:"內容",key:"content",sortable:!1},{title:"狀態",key:"isActive",sortable:!0},{title:"開始時間",key:"startDate",sortable:!0},{title:"結束時間",key:"endDate",sortable:!0},{title:"發布者",key:"publisher",sortable:!1},{title:"操作",key:"actions",sortable:!1,align:"center"}],_=i(!1),h=i(!1),ue=i(null),$=i(!1),o=i({type:"announcement",content:"",startDate:"",endDate:"",order:0,isActive:!0,_id:null}),k=i({type:!1,content:!1}),z=i(!1),P=i([]),M=i(!1),F=i(!1),B=i(!1),q=i(!1),Q=i(null),D=async()=>{var l,t;try{b.value=!0;const e={page:w.value,itemsPerPage:A.value};u.value.type&&(e.type=u.value.type),u.value.isActive!==null&&(u.value.isActive==="expired"?e.expired=!0:e.isActive=u.value.isActive),u.value.quickSearch&&(e.quickSearch=u.value.quickSearch);const{data:n}=await y.get("/marquees",{params:e});S.value=n.result.data,R.value=n.result.totalItems}catch(e){p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"載入失敗",snackbarProps:{color:"red-lighten-1"}})}finally{b.value=!1}},L=async()=>{w.value=1,await D()},ce=qe.debounce(()=>{w.value=1,b.value=!0,L().finally(()=>{b.value=!1})},300),me=l=>{l.page!==void 0&&(w.value=l.page),l.itemsPerPage!==void 0&&(A.value=l.itemsPerPage),D()},pe=async()=>{h.value=!1,await ve(),_.value=!0},ve=async()=>{ge();try{const{data:n}=await y.get("/marquees/max-order"),x=n.result||0;o.value.order=Number(x)+1}catch{const n=S.value.length>0?Math.max(...S.value.map(x=>x.order||0)):0;o.value.order=Number(n)+1}const l=new Date,t=l.getTimezoneOffset()*6e4,e=new Date(l.getTime()-t);o.value.startDate=e.toISOString().slice(0,16),o.value.isActive=!0},fe=l=>{h.value=!0,o.value={_id:l._id,type:l.type,content:l.content,order:l.order||0,isActive:l.isActive,startDate:l.startDate?Y(l.startDate):"",endDate:l.endDate?Y(l.endDate):""},k.value={type:!1,content:!1},_.value=!0},W=()=>{_.value=!1},ge=()=>{o.value={type:"announcement",content:"",startDate:"",endDate:"",order:0,isActive:!0,_id:null},k.value={type:!1,content:!1}},ye=()=>(k.value.type=!o.value.type,k.value.content=!o.value.content||o.value.content.trim()==="",!(k.value.type||k.value.content)),j=async()=>{var l,t;if(ye())try{$.value=!0;const e={type:o.value.type,content:o.value.content.trim(),order:o.value.order||0,isActive:o.value.isActive,startDate:o.value.startDate?new Date(o.value.startDate).toISOString():"",endDate:o.value.endDate?new Date(o.value.endDate).toISOString():""};let n;h.value&&o.value._id?n=await y.patch(`/marquees/${o.value._id}`,e):n=await y.post("/marquees",e),p({text:n.data.message||(h.value?"更新成功":"新增成功"),snackbarProps:{color:"teal-lighten-1"}}),_.value=!1,await D()}catch(e){p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}finally{$.value=!1}},be=async l=>{var t,e;try{const{data:n}=await y.patch(`/marquees/${l._id}/toggle`);p({text:n.message,snackbarProps:{color:"teal-lighten-1"}}),await D()}catch(n){p({text:((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||n.message||"切換失敗",snackbarProps:{color:"red-lighten-1"}})}},ke=l=>{Q.value=l._id,q.value=!0},xe=async()=>{var l,t;try{const{data:e}=await y.delete(`/marquees/${Q.value}`);p({text:e.message,snackbarProps:{color:"teal-lighten-1"}}),q.value=!1,await D()}catch(e){p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},Ve=async()=>{var l,t;try{const e={page:1,itemsPerPage:9999},{data:n}=await y.get("/marquees",{params:e});return n.result.data||[]}catch(e){return p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"載入失敗",snackbarProps:{color:"red-lighten-1"}}),[]}},we=async()=>{const l=await Ve();P.value=[...l].sort((t,e)=>(t.order||0)-(e.order||0)),z.value=!0},De=async()=>{var l,t;try{M.value=!0;const e=P.value.map((x,T)=>({id:x._id,order:T+1})),{data:n}=await y.patch("/marquees/order/update",{marquees:e});p({text:n.message,snackbarProps:{color:"teal-lighten-1"}}),z.value=!1,await D()}catch(e){p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"更新順序失敗",snackbarProps:{color:"red-lighten-1"}})}finally{M.value=!1}},_e=async()=>{var l,t;try{F.value=!0;const{data:e}=await y.post("/marquees/broadcast");p({text:e.message||"已重新推播",snackbarProps:{color:"teal-lighten-1"}})}catch(e){p({text:((t=(l=e.response)==null?void 0:l.data)==null?void 0:t.message)||e.message||"推播失敗",snackbarProps:{color:"red-lighten-1"}})}finally{F.value=!1}},Z=l=>{if(!l.endDate)return!1;const t=new Date;return new Date(l.endDate)<t},he=l=>Z(l)?"已過期":l.isActive?"啟用":"停用",ze=l=>Z(l)?"orange-darken-1":l.isActive?"green-darken-1":"grey-darken-1",G=l=>({system:"系統",update:"更新",announcement:"一般",maintenance:"維護",event:"活動"})[l]||l,J=l=>({system:"blue-darken-2",update:"cyan-darken-3",announcement:"grey-darken-2",maintenance:"red-darken-1",event:"indigo-darken-1"})[l]||"grey",K=l=>l?new Date(l).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}):"",X=l=>l?new Date(l).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!1}):"",Y=l=>{const t=new Date(l),e=t.getTimezoneOffset()*6e4;return new Date(t.getTime()-e).toISOString().slice(0,16)};return N(()=>u.value.quickSearch,()=>ce()),N(()=>u.value.type,()=>{w.value=1,b.value=!0,L().finally(()=>{b.value=!1})}),N(()=>u.value.isActive,()=>{w.value=1,b.value=!0,L().finally(()=>{b.value=!1})}),Ce(()=>{D()}),(l,t)=>(ee(),te(Fe,{"max-width":"1600"},{default:s(()=>[a(U,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-4 mb-4 bg-white"},{default:s(()=>[a(m,{cols:"12",class:"ps-3 pb-6"},{default:s(()=>t[18]||(t[18]=[r("h3",null,"跑馬燈管理",-1)])),_:1}),a(m,{cols:"12"},{default:s(()=>[a(U,null,{default:s(()=>[a(m,null,{default:s(()=>[a(U,null,{default:s(()=>[a(m,null,{default:s(()=>[a(v,{"prepend-icon":"mdi-bullhorn",variant:"outlined",color:"teal-darken-1",class:"me-4",onClick:pe},{default:s(()=>t[19]||(t[19]=[d(" 新增跑馬燈 ")])),_:1}),a(v,{"prepend-icon":"mdi-broadcast",variant:"outlined",color:"red-darken-1",class:"me-4",loading:F.value,onClick:t[0]||(t[0]=e=>B.value=!0)},{default:s(()=>t[20]||(t[20]=[d(" 重新推播 ")])),_:1},8,["loading"]),a(v,{"prepend-icon":"mdi-sort",variant:"outlined",color:"blue-grey-darken-2",onClick:we},{default:s(()=>t[21]||(t[21]=[d(" 排序 ")])),_:1})]),_:1}),a(m,{sm:"3",lg:"2",class:"pe-1"},{default:s(()=>[a(E,{modelValue:u.value.type,"onUpdate:modelValue":t[1]||(t[1]=e=>u.value.type=e),items:re,"item-title":"title","item-value":"value",label:"類型篩選",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(m,{sm:"3",lg:"2",class:"pe-1"},{default:s(()=>[a(E,{modelValue:u.value.isActive,"onUpdate:modelValue":t[2]||(t[2]=e=>u.value.isActive=e),items:ie,"item-title":"title","item-value":"value",label:"狀態篩選",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(m,{sm:"4",lg:"3"},{default:s(()=>[a(O,{modelValue:u.value.quickSearch,"onUpdate:modelValue":t[3]||(t[3]=e=>u.value.quickSearch=e),label:"快速搜尋（內容）","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(m,{cols:"12"},{default:s(()=>[a(Be,{"items-per-page":A.value,"onUpdate:itemsPerPage":t[4]||(t[4]=e=>A.value=e),headers:de,items:S.value,loading:b.value,page:w.value,"items-length":R.value,density:"compact",class:"elevation-0 rounded","onUpdate:options":me},{item:s(({item:e,index:n})=>{var x;return[r("tr",{class:Se({"odd-row":n%2===0,"even-row":n%2!==0})},[r("td",Qe,[a(C,{size:"small",color:"blue-grey",variant:"tonal"},{default:s(()=>[d(c(e.order||0),1)]),_:2},1024)]),r("td",null,[a(C,{color:J(e.type),size:"small"},{default:s(()=>[d(c(G(e.type)),1)]),_:2},1032,["color"])]),r("td",null,[r("div",We,c(e.content),1)]),r("td",null,[a(C,{color:ze(e),size:"small"},{default:s(()=>[d(c(he(e)),1)]),_:2},1032,["color"])]),r("td",null,[r("div",je,[r("span",null,c(K(e.startDate)),1),r("span",Ze,c(X(e.startDate)),1)])]),r("td",null,[r("div",Ge,[r("span",null,c(K(e.endDate)),1),r("span",Je,c(X(e.endDate)),1)])]),r("td",null,c(((x=e.publisher)==null?void 0:x.name)||"未知"),1),r("td",null,[r("div",Ke,[a(v,{icon:"",size:"small",color:"blue",variant:"text",onClick:T=>fe(e)},{default:s(()=>[a(V,{size:"18"},{default:s(()=>t[22]||(t[22]=[d(" mdi-pencil ")])),_:1})]),_:2},1032,["onClick"]),a(v,{icon:"",size:"small",color:e.isActive?"orange":"green",variant:"text",onClick:T=>be(e)},{default:s(()=>[a(V,{size:"18"},{default:s(()=>[d(c(e.isActive?"mdi-pause":"mdi-play"),1)]),_:2},1024)]),_:2},1032,["color","onClick"]),a(v,{icon:"",size:"small",color:"red",variant:"text",onClick:T=>ke(e)},{default:s(()=>[a(V,{size:"18"},{default:s(()=>t[23]||(t[23]=[d(" mdi-delete ")])),_:1})]),_:2},1032,["onClick"])])])],2)]}),_:1},8,["items-per-page","items","loading","page","items-length"])]),_:1})]),_:1})]),_:1})]),_:1}),a(ne,{modelValue:_.value,"onUpdate:modelValue":t[11]||(t[11]=e=>_.value=e),"max-width":"680",persistent:""},{default:s(()=>[a(ae,{class:"rounded-lg"},{default:s(()=>[a(le,{class:"d-flex align-center px-6 py-2 bg-teal-darken-1"},{default:s(()=>[a(V,{icon:"mdi-bullhorn",size:f(g)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),r("span",Xe,c(h.value?"編輯跑馬燈":"新增跑馬燈"),1),a(I),a(v,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:f(g)?"36":"32",onClick:W},{default:s(()=>[a(V,{size:f(g)?"22":"18"},{default:s(()=>t[24]||(t[24]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),a(se,{class:"px-6 py-4 mt-4"},{default:s(()=>[a(Le,{ref_key:"formRef",ref:ue,onSubmit:Ae(j,["prevent"])},{default:s(()=>[a(U,null,{default:s(()=>[a(m,{cols:"12",md:"4"},{default:s(()=>[a(E,{modelValue:o.value.type,"onUpdate:modelValue":t[5]||(t[5]=e=>o.value.type=e),items:H,"item-title":"label","item-value":"value",label:"類型 *",variant:"outlined",density:"compact",error:k.value.type},null,8,["modelValue","error"])]),_:1}),a(m,{cols:"12",md:"4"},{default:s(()=>[a(O,{modelValue:o.value.order,"onUpdate:modelValue":t[6]||(t[6]=e=>o.value.order=e),modelModifiers:{number:!0},label:"排序（選填）",type:"number",variant:"outlined",density:"compact",min:"0"},null,8,["modelValue"])]),_:1}),a(m,{cols:"12",md:"4"},{default:s(()=>[a(Ne,{modelValue:o.value.isActive,"onUpdate:modelValue":t[7]||(t[7]=e=>o.value.isActive=e),label:"啟用",color:"green",density:"compact","hide-details":""},null,8,["modelValue"])]),_:1}),a(m,{cols:"12",md:"6"},{default:s(()=>[a(O,{modelValue:o.value.startDate,"onUpdate:modelValue":t[8]||(t[8]=e=>o.value.startDate=e),label:"開始時間",type:"datetime-local",variant:"outlined",density:"compact","prepend-icon":"mdi-calendar-clock","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(m,{cols:"12",md:"6"},{default:s(()=>[a(O,{modelValue:o.value.endDate,"onUpdate:modelValue":t[9]||(t[9]=e=>o.value.endDate=e),label:"結束時間",type:"datetime-local",variant:"outlined",density:"compact","prepend-icon":"mdi-calendar-clock","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(m,{cols:"12"},{default:s(()=>[a(Ee,{modelValue:o.value.content,"onUpdate:modelValue":t[10]||(t[10]=e=>o.value.content=e),modelModifiers:{trim:!0},label:"內容 *",variant:"outlined",density:"compact",rows:"3",counter:"200",error:k.value.content},null,8,["modelValue","error"])]),_:1})]),_:1})]),_:1},512)]),_:1}),a(oe,{class:"px-6 pb-5 pt-0"},{default:s(()=>[a(I),a(v,{variant:"outlined",color:"grey-darken-1",size:f(g)?"default":"small",onClick:W},{default:s(()=>t[25]||(t[25]=[d(" 取消 ")])),_:1},8,["size"]),a(v,{color:"teal-darken-1",variant:"outlined",class:"ms-2",size:f(g)?"default":"small",loading:$.value,onClick:j},{default:s(()=>[d(c(h.value?"更新":"新增"),1)]),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ne,{modelValue:z.value,"onUpdate:modelValue":t[15]||(t[15]=e=>z.value=e),"max-width":"400"},{default:s(()=>[a(ae,{class:"rounded-lg"},{default:s(()=>[a(le,{class:"d-flex align-center px-6 py-2 bg-blue-grey-darken-2"},{default:s(()=>[a(V,{icon:"mdi-sort",size:f(g)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),t[27]||(t[27]=r("span",{class:"card-title text-white"},"跑馬燈排序",-1)),a(I),a(v,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:f(g)?"36":"32",onClick:t[12]||(t[12]=e=>z.value=!1)},{default:s(()=>[a(V,{size:f(g)?"22":"18"},{default:s(()=>t[26]||(t[26]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),a(se,{class:"px-6 py-4"},{default:s(()=>[t[29]||(t[29]=r("div",{class:"text-subtitle-1 mb-4"}," 拖拽調整跑馬燈顯示順序 ",-1)),a(f(Oe),{modelValue:P.value,"onUpdate:modelValue":t[13]||(t[13]=e=>P.value=e),"item-key":"_id",class:"sortable-list",handle:".drag-handle",animation:"200","ghost-class":"ghost-item","chosen-class":"chosen-item"},{item:s(({element:e,index:n})=>[(ee(),te(Re,{key:e._id,class:"border rounded mb-2"},{prepend:s(()=>[r("div",Ye,[a(V,{color:"grey-darken-1"},{default:s(()=>t[28]||(t[28]=[d(" mdi-drag-vertical ")])),_:1})])]),append:s(()=>[a(C,{size:"small",color:"blue-grey"},{default:s(()=>[d(c(n+1),1)]),_:2},1024)]),default:s(()=>[a(He,null,{default:s(()=>[a(C,{size:"x-small",color:J(e.type),class:"me-2"},{default:s(()=>[d(c(G(e.type)),1)]),_:2},1032,["color"]),r("span",et,c(e.content),1)]),_:2},1024)]),_:2},1024))]),_:1},8,["modelValue"])]),_:1}),a(oe,{class:"px-6 pb-5 pt-0"},{default:s(()=>[a(I),a(v,{variant:"outlined",color:"grey-darken-1",size:f(g)?"default":"small",onClick:t[14]||(t[14]=e=>z.value=!1)},{default:s(()=>t[30]||(t[30]=[d(" 取消 ")])),_:1},8,["size"]),a(v,{color:"blue-grey-darken-2",variant:"outlined",class:"ms-2",size:f(g)?"default":"small",loading:M.value,onClick:De},{default:s(()=>t[31]||(t[31]=[d(" 更新 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Ie,{modelValue:q.value,"onUpdate:modelValue":t[16]||(t[16]=e=>q.value=e),width:320,title:"確認刪除跑馬燈",message:"確定要刪除這則內容嗎？此操作無法復原。","confirm-button-color":"red-lighten-1","cancel-button-color":"grey-darken-1","confirm-button-text":"刪除","cancel-button-text":"取消",onConfirm:xe},null,8,["modelValue"]),a($e,{modelValue:B.value,"onUpdate:modelValue":t[17]||(t[17]=e=>B.value=e),"dialog-width":"320",title:"確認重新推播",message:"此動作將強制所有使用者重新顯示跑馬燈，是否繼續？","confirm-button-color":"red-lighten-1","cancel-button-color":"grey-darken-1","confirm-button-text":"確認","cancel-button-text":"取消","header-color":"bg-red-darken-1","header-icon":"mdi-bullhorn",onConfirm:_e},null,8,["modelValue"])]),_:1}))}},St=Te(tt,[["__scopeId","data-v-60e56e05"]]);export{St as default};

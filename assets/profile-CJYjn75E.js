import{r as c,f as L,aV as g,$ as G,a0 as s,Z as V,bH as l,_ as F,a7 as o,u as z,bJ as le,a8 as e,w as J,b3 as He,b0 as ve,bf as P,F as oe,bK as Qe,k as Ze,bM as Xe}from"./@vue-Cr_z6yfx.js";import{u as Ae,_ as ne,b as be,c as Ee,a as el,r as ll}from"./index-mGnb0KKF.js";import{i as ie}from"./vuetify-use-dialog-C5oZ13xz.js";import{q as te,J as Te,g as b,T as se,r as w,b as H,f as R,c as W,v as I,w as k,a as j,p as Le,ab as tl,e as Q,V as Z,O as al,a7 as sl,a8 as ol,d as ee,F as fe,ad as Ie,A as Re,a3 as nl,a4 as ae,Q as il,U as rl}from"./vuetify-CbddcmEc.js";import{_ as dl}from"./UserAvatar-CwvpGxzs.js";import{_ as ul}from"./ConfirmDialog-CJtUY0XN.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./vue-router-CS4OewbW.js";import"./jspdf-DacfHTdZ.js";import"./core-js-D2hAHviU.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";const De={__name:"FileUploadButton",setup(K){const D=c(null),A=Ae(),N=ie(),U=c(!1),{mdAndUp:h,width:x}=te(),S=L(()=>x.value>=1500),C=async v=>{const r=v.target.files[0];if(!r)return;if(!["image/jpeg","image/png"].includes(r.type)){N({text:"只能上傳 JPG、PNG、WEBP 格式的圖片",snackbarProps:{color:"red-lighten-1"}});return}if(r.size>2*1024*1024){N({text:"圖片大小不能超過 2MB",snackbarProps:{color:"red-lighten-1"}});return}const _=new FormData;_.append("image",r);try{U.value=!0,await A.updateAvatar(_);const B=new Date().getTime();A.avatar=`${A.avatar}?t=${B}`,N({text:"大頭貼更新成功",snackbarProps:{color:"teal-lighten-1"}})}catch(B){console.error("Upload error:",B),N({text:B.message||"上傳失敗",snackbarProps:{color:"red-lighten-1"}})}finally{U.value=!1,v.target.value=""}};return(v,r)=>(g(),G("div",null,[s("input",{ref_key:"fileInput",ref:D,type:"file",accept:"image/jpeg,image/png",style:{display:"none"},onChange:C},null,544),S.value?(g(),V(b,{key:0,"prepend-icon":"mdi-camera-outline",color:"blue-grey-darken-2",variant:"outlined",loading:U.value,onClick:r[0]||(r[0]=_=>v.$refs.fileInput.click())},{default:l(()=>[U.value?(g(),V(Te,{key:0,indeterminate:"",size:"20",width:"2",color:"deep-orange-darken-2",class:"me-2"})):F("",!0),r[3]||(r[3]=o(" 更換大頭貼 "))]),_:1},8,["loading"])):z(h)?le((g(),V(b,{key:1,icon:"",color:"blue-grey-darken-2",size:"32",class:"me-4",elevation:"2",loading:U.value,onClick:r[1]||(r[1]=_=>v.$refs.fileInput.click())},{default:l(()=>[e(w,{size:"18"},{default:l(()=>r[4]||(r[4]=[o(" mdi-camera-outline ")])),_:1})]),_:1},8,["loading"])),[[se,"更換大頭貼","top"]]):(g(),V(b,{key:2,icon:"",color:"blue-grey-darken-2",size:"28",class:"me-4",elevation:"2",loading:U.value,onClick:r[2]||(r[2]=_=>v.$refs.fileInput.click())},{default:l(()=>[e(w,{size:"14"},{default:l(()=>r[5]||(r[5]=[o(" mdi-camera-outline ")])),_:1})]),_:1},8,["loading"]))]))}},cl={class:"d-flex align-center justify-center h-100"},ml={class:"sub-title"},ge=6,pl={__name:"BackgroundImageDialog",props:{modelValue:{type:Boolean,default:!1},currentBackground:{type:String,default:""},isUpdating:{type:Boolean,default:!1}},emits:["update:modelValue","confirm","show-usage-stats"],setup(K,{emit:D}){const{mdAndUp:A,smAndUp:N}=te(),U=L(()=>A.value?"default":"small"),h=K,x=D,S=c([{name:"野火燎原",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_flame.png"},{name:"迷幻星空",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_purplesky.png"},{name:"小木屋",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_cabin.png"},{name:"機器人",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_robot.png"},{name:"靜謐之森",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_snowforest.png"},{name:"日出",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_sunrise.png"},{name:"龍貓",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_totoro.png"},{name:"移動城堡",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_castle.png"},{name:"霍格華茲",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_hogwarts.png"},{name:"咖波",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_capoo.png"},{name:"水晶球",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_pokemon.png"},{name:"Pingu",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_pingu.png"},{name:"史迪奇",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_stitch.png"},{name:"鳥居",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_shrine.png"},{name:"胡蝶忍",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_kochoshinobu.png"},{name:"Chiikawa",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_chiikawa.png"},{name:"紫月",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_purplemoon.png"},{name:"小新",url:"https://eip.ystravel.com.tw/uploads/card-bg/bg_profile_shinchan.png"}]),C=c(1),v=c(""),r=L({get:()=>h.modelValue,set:n=>x("update:modelValue",n)}),_=L(()=>Math.ceil(S.value.length/ge)),B=L(()=>{const n=(C.value-1)*ge,d=n+ge;return S.value.slice(n,d)});J(r,n=>{n&&(v.value=h.currentBackground||"",C.value=1)});const E=()=>{r.value=!1},T=()=>{x("confirm",v.value)},p=()=>{x("show-usage-stats")};return(n,d)=>{const O=He("permission");return g(),V(Z,{modelValue:r.value,"onUpdate:modelValue":d[1]||(d[1]=y=>r.value=y),"max-width":"900"},{default:l(()=>[e(j,{class:"rounded-lg"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-grey-darken-2 mb-2"},{default:l(()=>[e(w,{class:"me-2",size:"20"},{default:l(()=>d[2]||(d[2]=[o(" mdi-image ")])),_:1}),d[5]||(d[5]=s("span",{class:"card-title text-white"},"變更背景圖片",-1)),e(R),le((g(),V(b,{variant:"outlined",color:"white",class:"me-4",size:"small",onClick:p},{default:l(()=>d[3]||(d[3]=[o(" 使用統計 ")])),_:1})),[[O,"SYSTEM_BACKGROUND_IMAGE_READ"]]),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:U.value,ripple:!1,onClick:E},{default:l(()=>[e(w,null,{default:l(()=>d[4]||(d[4]=[o("mdi-close")])),_:1})]),_:1},8,["size"])]),_:1}),e(W,{class:"px-5 pb-0 pt-6"},{default:l(()=>[e(I,null,{default:l(()=>[(g(!0),G(oe,null,ve(B.value,(y,X)=>(g(),V(k,{key:X,cols:"12",sm:"6",md:"4",class:"text-center"},{default:l(()=>[e(j,{class:"cursor-pointer border rounded-lg",elevation:"0",onClick:Y=>v.value=y.url},{default:l(()=>[e(Le,{src:y.url,height:"180",cover:""},{default:l(()=>[s("div",cl,[v.value===y.url?(g(),V(w,{key:0,color:"white",size:"40",class:"pt-5"},{default:l(()=>d[6]||(d[6]=[o(" mdi-check-circle ")])),_:1})):F("",!0)])]),_:2},1032,["src"]),e(W,{class:"pa-2"},{default:l(()=>[s("div",ml,P(y.name),1)]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1}),_.value>1?(g(),V(tl,{key:0,modelValue:C.value,"onUpdate:modelValue":d[0]||(d[0]=y=>C.value=y),length:_.value,"total-visible":3,class:"mt-4",size:"x-small",variant:"flat",color:"blue-grey-darken-2"},null,8,["modelValue","length"])):F("",!0)]),_:1}),e(Q,{class:"px-5 mb-3 mt-1"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",size:z(N)?"default":"small",onClick:E},{default:l(()=>d[7]||(d[7]=[o(" 取消 ")])),_:1},8,["size"]),e(b,{color:"blue-grey-darken-2",variant:"outlined",size:z(N)?"default":"small",class:"ms-1",loading:K.isUpdating,onClick:T},{default:l(()=>d[8]||(d[8]=[o(" 確認 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}},fl=ne(pl,[["__scopeId","data-v-fe8a02b5"]]),gl={key:0,class:"d-flex justify-center align-center py-8"},vl={key:1},bl={class:"block-title font-weight-bold text-blue-grey-darken-2 mb-2"},yl={class:"block-title font-weight-bold text-blue-grey-darken-2 mb-2"},kl={class:"block-title font-weight-bold text-blue-grey-darken-2 mb-2"},_l={class:"d-flex flex-wrap gap-1"},wl={class:"card-title text-white"},xl={class:"d-flex align-center"},Vl={class:"text-caption text-blue-grey-darken-1 font-weight-medium"},Cl={class:"text-caption text-grey-darken-1"},zl={__name:"BackgroundImageUsageStatsDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(K,{emit:D}){const{mdAndUp:A}=te(),{apiAuth:N}=be(),U=ie(),h=L(()=>A.value?"default":"small"),x=K,S=D,C=c(!1),v=c([]),r=c(""),_=c(!1),B=c(null),E=L({get:()=>x.modelValue,set:f=>S("update:modelValue",f)}),T=L(()=>{const f=new Set;return v.value.forEach(i=>{i.users.forEach(m=>f.add(m._id))}),f.size}),p=L(()=>v.value.length),n=L(()=>{if(v.value.length===0)return null;const f=v.value.filter(i=>i.userCount>0);return f.length===0?null:f.reduce((i,m)=>m.userCount>i.userCount?m:i)}),d=[{title:"背景圖片",key:"backgroundImage",sortable:!1},{title:"背景名稱",key:"backgroundName",sortable:!0},{title:"使用人數",key:"userCount",sortable:!0},{title:"使用者",key:"users",sortable:!1},{title:"操作",key:"actions",sortable:!1}],O=f=>f>=10?"green":f>=5?"orange":f>=1?"blue":"grey",y=async()=>{try{C.value=!0;const{data:f}=await N.get("/users/background-image-usage-stats");if(f.success)v.value=f.result;else throw new Error(f.message||"載入統計資料失敗")}catch(f){console.error("載入使用統計失敗:",f),U({text:f.message||"載入統計資料失敗",snackbarProps:{color:"red-lighten-1"}})}finally{C.value=!1}},X=f=>{B.value=f,_.value=!0},Y=()=>{E.value=!1};return J(E,f=>{f&&y()}),(f,i)=>(g(),V(Z,{modelValue:E.value,"onUpdate:modelValue":i[4]||(i[4]=m=>E.value=m),"max-width":"1000"},{default:l(()=>[e(j,{class:"rounded-lg"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-grey-darken-2 mb-2"},{default:l(()=>[e(w,{class:"me-2",size:"20"},{default:l(()=>i[5]||(i[5]=[o(" mdi-chart-bar ")])),_:1}),i[7]||(i[7]=s("span",{class:"card-title text-white"},"背景圖片使用統計",-1)),e(R),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:h.value,ripple:!1,onClick:Y},{default:l(()=>[e(w,null,{default:l(()=>i[6]||(i[6]=[o("mdi-close")])),_:1})]),_:1},8,["size"])]),_:1}),e(W,{class:"px-5 pb-0 pt-6"},{default:l(()=>[C.value?(g(),G("div",gl,[e(Te,{indeterminate:"",color:"blue-grey-darken-2",size:52,width:4})])):(g(),G("div",vl,[e(I,{class:"mb-6"},{default:l(()=>[e(k,{cols:"12",sm:"4"},{default:l(()=>[e(j,{class:"text-center pa-4 border rounded",elevation:"0"},{default:l(()=>[s("div",bl,P(T.value),1),i[8]||(i[8]=s("div",{class:"text-subtitle-2 text-grey"}," 總使用人數 ",-1))]),_:1})]),_:1}),e(k,{cols:"12",sm:"4"},{default:l(()=>[e(j,{class:"text-center pa-4 border rounded",elevation:"0"},{default:l(()=>[s("div",yl,P(p.value),1),i[9]||(i[9]=s("div",{class:"text-subtitle-2 text-grey"}," 背景圖片總數 ",-1))]),_:1})]),_:1}),e(k,{cols:"12",sm:"4"},{default:l(()=>[e(j,{class:"text-center pa-4 border rounded",elevation:"0"},{default:l(()=>{var m;return[s("div",kl,P(((m=n.value)==null?void 0:m.backgroundName)||"無"),1),i[10]||(i[10]=s("div",{class:"text-subtitle-2 text-grey"}," 最多人使用背景 ",-1))]}),_:1})]),_:1})]),_:1}),e(al,{headers:d,items:v.value,loading:C.value,"items-per-page":10,search:r.value,class:"border py-2 mb-4 rounded"},{top:l(()=>[e(sl,{flat:"",class:"mb-4 pe-4",color:"white"},{default:l(()=>[e(ol,{class:"card-title text-blue-grey-darken-2"},{default:l(()=>i[11]||(i[11]=[o(" 背景圖片使用詳情 ")])),_:1}),e(R),e(ee,{modelValue:r.value,"onUpdate:modelValue":i[0]||(i[0]=m=>r.value=m),"append-inner-icon":"mdi-magnify",label:"搜尋背景圖片","single-line":"","hide-details":"",variant:"outlined",density:"compact",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1})]),"item.backgroundImage":l(({item:m})=>[s("div",null,[e(Le,{src:m.backgroundImage,width:"70",height:"40",cover:"",class:"rounded me-3 my-2"},null,8,["src"])])]),"item.userCount":l(({item:m})=>[e(fe,{color:O(m.userCount),size:"small"},{default:l(()=>[o(P(m.userCount)+" 人 ",1)]),_:2},1032,["color"])]),"item.users":l(({item:m})=>[s("div",_l,[(g(!0),G(oe,null,ve(m.users.slice(0,3),$=>(g(),V(fe,{key:$._id,label:"",size:"x-small",variant:"outlined",color:"blue-grey-darken-2",class:"me-1"},{default:l(()=>[o(P($.name),1)]),_:2},1024))),128)),m.users.length>3?(g(),V(fe,{key:0,size:"x-small",label:"",variant:"outlined",color:"grey"},{default:l(()=>[o(" +"+P(m.users.length-3)+" 人 ",1)]),_:2},1024)):F("",!0)])]),"item.actions":l(({item:m})=>[e(b,{size:"small",variant:"outlined",color:"blue-grey-darken-2",onClick:$=>X(m)},{default:l(()=>i[12]||(i[12]=[o(" 查看詳情 ")])),_:2},1032,["onClick"])]),_:2},1032,["items","loading","search"])]))]),_:1}),e(Q,{class:"px-5 mb-3"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",onClick:Y},{default:l(()=>i[13]||(i[13]=[o(" 關閉 ")])),_:1})]),_:1})]),_:1}),e(Z,{modelValue:_.value,"onUpdate:modelValue":i[3]||(i[3]=m=>_.value=m),"max-width":"760"},{default:l(()=>[e(j,{class:"rounded-lg"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-grey-darken-2 mb-2"},{default:l(()=>{var m;return[e(w,{class:"me-2",size:"20"},{default:l(()=>i[14]||(i[14]=[o(" mdi-account-group ")])),_:1}),s("span",wl,P((m=B.value)==null?void 0:m.backgroundName)+" - 使用詳情",1),e(R),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:h.value,ripple:!1,onClick:i[1]||(i[1]=$=>_.value=!1)},{default:l(()=>[e(w,null,{default:l(()=>i[15]||(i[15]=[o("mdi-close")])),_:1})]),_:1},8,["size"])]}),_:1}),e(W,{class:"px-5 pb-0 pt-6"},{default:l(()=>[e(I,null,{default:l(()=>{var m;return[(g(!0),G(oe,null,ve(((m=B.value)==null?void 0:m.users)||[],$=>(g(),V(k,{key:$._id,cols:"12",sm:"6",md:"4",class:"mb-2"},{default:l(()=>[e(j,{class:"py-2 px-3 border rounded-lg",elevation:"0"},{default:l(()=>[s("div",xl,[s("div",null,[s("div",Vl,P($.name),1),s("div",Cl,P($.email),1)])])]),_:2},1024)]),_:2},1024))),128))]}),_:1})]),_:1}),e(Q,{class:"px-5 mb-3"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",onClick:i[2]||(i[2]=m=>_.value=!1)},{default:l(()=>i[16]||(i[16]=[o(" 關閉 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]))}},Pl=ne(zl,[["__scopeId","data-v-902d4c6a"]]),hl={class:"mb-6"},Bl={class:"d-flex align-center mb-4"},Ul={class:"d-flex align-center mb-4"},Nl={class:"mb-3"},$l={__name:"SettingsDialog",props:{modelValue:{type:Boolean,default:!1},notificationPrefs:{type:Object,default:()=>({email:!0,line:!1,inbox:!0})},selectedScale:{type:Number,default:100},isLineBound:{type:Boolean,default:!1}},emits:["update:modelValue","update:notification-prefs","update:scale"],setup(K,{emit:D}){const{smAndUp:A}=te(),N=ie(),{apiAuth:U}=be(),h=Ee(),x=K,S=D,C=L(()=>A.value?"default":"small"),v=c(x.modelValue),r=c({...x.notificationPrefs}),_=c(x.selectedScale);J(()=>x.modelValue,p=>{v.value=p,p&&(r.value={...x.notificationPrefs},_.value=x.selectedScale)}),J(()=>x.notificationPrefs,p=>{r.value={...p}},{deep:!0}),J(()=>x.selectedScale,p=>{_.value=p});const B=async()=>{var p,n;try{const{data:d}=await U.put("/line/notification-preferences",{email:r.value.email,line:r.value.line,inbox:r.value.inbox});d.success&&(S("update:notification-prefs",{...r.value}),N({text:"通知偏好設定更新成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(d){console.error("更新通知偏好設定失敗:",d),N({text:((n=(p=d.response)==null?void 0:p.data)==null?void 0:n.message)||"更新通知偏好設定失敗",snackbarProps:{color:"red-lighten-1"}}),r.value={...x.notificationPrefs}}},E=p=>{h.setScale(p),S("update:scale",p),N({text:`介面縮放已設定為 ${p}%`,snackbarProps:{color:"teal-lighten-1"}})},T=()=>{S("update:modelValue",!1)};return(p,n)=>(g(),V(Z,{modelValue:v.value,"onUpdate:modelValue":n[4]||(n[4]=d=>v.value=d),"max-width":"600","onClick:outside":T,onKeydown:Qe(T,["esc"])},{default:l(()=>[e(j,{class:"rounded-lg"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-grey-darken-2"},{default:l(()=>[e(w,{class:"me-2",size:"20"},{default:l(()=>n[5]||(n[5]=[o(" mdi-cog ")])),_:1}),n[7]||(n[7]=s("span",{class:"card-title text-white"},"設定",-1)),e(R),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:C.value,ripple:!1,onClick:T},{default:l(()=>[e(w,null,{default:l(()=>n[6]||(n[6]=[o(" mdi-close ")])),_:1})]),_:1},8,["size"])]),_:1}),e(W,{class:"pa-6"},{default:l(()=>[s("div",hl,[s("div",Bl,[e(w,{class:"me-2",color:"blue-grey-darken-2",size:z(A)?"20":"18"},{default:l(()=>n[8]||(n[8]=[o(" mdi-bell ")])),_:1},8,["size"]),n[9]||(n[9]=s("span",{class:"settings-section-title"},"通知偏好設定",-1))]),e(Ie,{modelValue:r.value.email,"onUpdate:modelValue":[n[0]||(n[0]=d=>r.value.email=d),B],label:" EMAIL 通知",density:"compact","hide-details":"",class:"mb-2",color:"blue-grey-darken-2"},null,8,["modelValue"]),F("",!0),e(Ie,{modelValue:r.value.inbox,"onUpdate:modelValue":[n[2]||(n[2]=d=>r.value.inbox=d),B],label:" 內部收件匣通知",density:"compact","hide-details":"",color:"blue-grey-darken-2"},null,8,["modelValue"])]),e(Re,{class:"my-6"}),s("div",null,[s("div",Ul,[e(w,{class:"me-2",color:"blue-grey-darken-2",size:z(A)?"20":"18"},{default:l(()=>n[10]||(n[10]=[o(" mdi-monitor ")])),_:1},8,["size"]),n[11]||(n[11]=s("span",{class:"settings-section-title"},"顯示設定",-1))]),s("div",Nl,[n[12]||(n[12]=s("div",{class:"mb-2 sub-title-1 text-blue-grey-darken-2"}," 介面縮放： ",-1)),e(nl,{modelValue:_.value,"onUpdate:modelValue":[n[3]||(n[3]=d=>_.value=d),E],inline:"",density:"compact","hide-details":""},{default:l(()=>[e(ae,{label:"100%",value:100,color:"blue-grey-darken-2",class:"me-2"}),e(ae,{label:"115%",value:115,color:"blue-grey-darken-2",class:"me-2"}),e(ae,{label:"125%",value:125,color:"blue-grey-darken-2",class:"me-2"}),e(ae,{label:"150%",value:150,color:"blue-grey-darken-2"})]),_:1},8,["modelValue"]),n[13]||(n[13]=s("p",{class:"sub-title-2 text-blue-grey-darken-1 mt-2"}," *注意 : 調整縮放比例會影響網頁內容排版。 ",-1))])])]),_:1}),e(Q,{class:"me-4 mb-3"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",size:C.value,onClick:T},{default:l(()=>n[14]||(n[14]=[o(" 關閉 ")])),_:1},8,["size"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Sl=ne($l,[["__scopeId","data-v-909e22be"]]),Il={class:"name mb-3 opacity-90"},Dl={class:"text-subtitle-2 mb-4 opacity-70"},Al={style:{"font-size":"15px","font-weight":"600"},class:"opacity-90 mb-10"},El={key:0,class:"text-subtitle-2 opacity-80 font-weight-regular"},Tl={class:"profile-text-field"},Ll={class:"profile-text-field"},Rl={class:"profile-text-field"},jl={class:"profile-text-field"};const Fl={key:0},Ml={class:"notify-box"},Gl={class:"d-flex align-center"},Ol={class:"font-weight-bold notify-title"},Kl={class:"mt-4 px-4"},Jl={class:"sub-title-1 mb-2"},Wl={class:"text-center mt-5 mb-4"},Yl={class:"sub-title-1 mb-2"},ql={key:1},Hl={__name:"profile",setup(K){const{mdAndUp:D,width:A,smAndUp:N}=te(),U=L(()=>A.value>=1500),h=L(()=>D.value?"default":"small"),x=c(!1),S=c(!1),C=c(!1),v=c(!1),r=c(!1),_=c(!1),B=c(!1),E=c(!1),T=c(!1),p=c({currentPassword:"",newPassword:"",confirmPassword:""}),n=c(""),d=c(""),O=c(""),y=Ae(),X=el(),Y=Ee(),f=ie(),{apiAuth:i}=be(),m=c(Y.uiScale);J(()=>Y.uiScale,u=>{m.value=u});const $=c([]),je=u=>ll[u]||"未知",Fe=async()=>{if(y.isLogin)try{const u=await X.getUserRoles(y._id);$.value=u||[]}catch(u){console.error("載入用戶角色失敗:",u),$.value=[]}},ye=()=>{var t,a;return $.value.length===0?je(y.role)||"未知":$.value.length===1?((t=$.value[0].role)==null?void 0:t.name)||"未知角色":((a=$.value.sort((M,Pe)=>{var Ue,Ne,$e,Se;const he=((Ue=M.role)==null?void 0:Ue.level)||0,Be=((Ne=Pe.role)==null?void 0:Ne.level)||0;if(he!==Be)return Be-he;const Ye=(($e=M.role)==null?void 0:$e.name)||"",qe=((Se=Pe.role)==null?void 0:Se.name)||"";return Ye.localeCompare(qe)})[0].role)==null?void 0:a.name)||"未知角色"},Me=async u=>{try{B.value=!0,await y.updateBackgroundImage(u),f({text:"背景圖片更新成功",snackbarProps:{color:"teal-lighten-1"}}),_.value=!1}catch(t){f({text:t.message,snackbarProps:{color:"red-lighten-1"}})}finally{B.value=!1}},Ge=()=>{let u=!0;return p.value.currentPassword||(n.value="請輸入當前密碼",u=!1),p.value.newPassword?p.value.newPassword.length<8&&(d.value="新密碼長度至少需要8個字元",u=!1):(d.value="請輸入新密碼",u=!1),p.value.confirmPassword?p.value.newPassword!==p.value.confirmPassword&&(O.value="兩次輸入的密碼不相符",u=!1):(O.value="請確認新密碼",u=!1),u},ke=async()=>{if(Ge())try{S.value=!0;const u=await y.changePassword(p.value.currentPassword,p.value.newPassword);f({text:u.message,snackbarProps:{color:"teal-lighten-1"}}),y.isDefaultPasswordChanged=!0,re()}catch(u){f({text:u.message,snackbarProps:{color:"red-lighten-1"}})}finally{S.value=!1}},re=()=>{x.value=!1,p.value={currentPassword:"",newPassword:"",confirmPassword:""},n.value="",d.value="",O.value="",C.value=!1,v.value=!1,r.value=!1},de=c(!1),_e=()=>{setTimeout(()=>{de.value=!0},100)};J(()=>y.avatar,u=>{if(u){de.value=!1;const t=new Image;t.onload=()=>{_e()},t.onerror=()=>{_e()},t.src=u}else de.value=!0},{immediate:!0});const we=c({isBound:!1,lineUserId:null,lineDisplayName:null,linePictureUrl:null,lineBoundAt:null,notificationPreferences:{email:!0,line:!1,inbox:!0}}),ue=c({email:!0,line:!1,inbox:!0}),ce=c(!1),q=c(""),me=c(null),pe=c(!1),xe=c(!1),Ve=c(!1),Ce=async()=>{var u,t,a;try{const{data:M}=await i.get("/line/binding/status");M.success&&(we.value=M.data,ue.value={email:((u=M.data.notificationPreferences)==null?void 0:u.email)??!0,line:((t=M.data.notificationPreferences)==null?void 0:t.line)??!1,inbox:((a=M.data.notificationPreferences)==null?void 0:a.inbox)??!0})}catch(M){console.error("載入綁定狀態失敗:",M)}},Oe=async()=>{var u,t;try{pe.value=!0;const{data:a}=await i.post("/line/binding/generate");a.success&&(q.value=a.data.bindingToken,me.value=a.data.expiresAt,f({text:"認證碼產生成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){console.error("產生認證碼失敗:",a),f({text:((t=(u=a.response)==null?void 0:u.data)==null?void 0:t.message)||"產生認證碼失敗",snackbarProps:{color:"red-lighten-1"}})}finally{pe.value=!1}},Ke=async()=>{var u,t;try{xe.value=!0;const{data:a}=await i.delete("/line/binding");a.success&&(f({text:"解除綁定成功",snackbarProps:{color:"teal-lighten-1"}}),await Ce())}catch(a){console.error("解除綁定失敗:",a),f({text:((t=(u=a.response)==null?void 0:u.data)==null?void 0:t.message)||"解除綁定失敗",snackbarProps:{color:"red-lighten-1"}})}finally{xe.value=!1}},Je=async()=>{try{await navigator.clipboard.writeText(q.value),f({text:"認證碼已複製到剪貼簿",snackbarProps:{color:"teal-lighten-1"}})}catch(u){console.error("複製失敗:",u),f({text:"複製失敗",snackbarProps:{color:"red-lighten-1"}})}},Ql=u=>u?new Date(u).toLocaleString("zh-TW"):"未知",We=u=>u?new Date(u).toLocaleString("zh-TW"):"",ze=()=>{ce.value=!1,q.value="",me.value=null};return Ze(async()=>{await Fe(),await Ce()}),(u,t)=>(g(),G(oe,null,[e(il,{"max-width":"2100"},{default:l(()=>[e(I,null,{default:l(()=>[U.value?(g(),V(k,{key:0,md:"3",class:"pe-0"},{default:l(()=>[e(I,{class:"elevation-4 rounded-lg pt-9 pb-9 px-1 px-sm-10 mt-2 mt-sm-6 ms-4 me-2 mx-xl-12 bg-white"},{default:l(()=>[e(j,{width:"100%",elevation:"0"},{default:l(()=>[e(I,{class:"text-center"},{default:l(()=>[e(k,{cols:"12"},{default:l(()=>[e(dl,{user:z(y),size:"100"},null,8,["user"])]),_:1}),e(k,null,{default:l(()=>[s("div",Il,P(z(y).name),1),s("div",Dl,P(z(y).userId),1),s("div",Al,P(ye()),1),U.value?(g(),V(I,{key:0,class:"justify-center"},{default:l(()=>[e(k,{class:"py-3"},{default:l(()=>[e(De)]),_:1})]),_:1})):F("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):F("",!0),e(k,{xl:"9"},{default:l(()=>[e(I,{class:"elevation-4 rounded-lg pt-3 pt-sm-5 pb-6 px-2 px-sm-4 mt-2 mt-sm-6 mx-0 mx-md-4 me-xl-12 mb-4 bg-white"},{default:l(()=>[e(k,{cols:"12",class:"d-flex justify-space-between align-center"},{default:l(()=>[s("h3",null,[t[27]||(t[27]=o(" 個人資料管理    ")),z(D)?(g(),G("span",El,t[26]||(t[26]=[s("span",{class:"text-red-darken-2"},"* ",-1),o("若有需要修改 請聯絡管理者 ( 密碼可自行修改 ) ")]))):F("",!0)]),s("div",null,[e(I,null,{default:l(()=>[e(k,{class:"d-flex justify-center"},{default:l(()=>[U.value?F("",!0):(g(),V(De,{key:0})),z(D)?le((g(),V(b,{key:1,icon:"",color:"blue-grey-darken-2",size:"32",class:"me-4",elevation:"2",onClick:t[0]||(t[0]=a=>T.value=!0)},{default:l(()=>[e(w,{size:"18"},{default:l(()=>t[28]||(t[28]=[o(" mdi-cog ")])),_:1})]),_:1})),[[se,"設定","top"]]):(g(),V(b,{key:2,icon:"",color:"blue-grey-darken-2",size:"28",class:"me-4",elevation:"2",onClick:t[1]||(t[1]=a=>T.value=!0)},{default:l(()=>[e(w,{size:"14"},{default:l(()=>t[29]||(t[29]=[o(" mdi-cog ")])),_:1})]),_:1})),z(D)?le((g(),V(b,{key:3,icon:"",color:"blue-grey-darken-2",size:"32",class:"me-4",elevation:"2",onClick:t[2]||(t[2]=a=>_.value=!0)},{default:l(()=>[e(w,{size:"18"},{default:l(()=>t[30]||(t[30]=[o(" mdi-image ")])),_:1})]),_:1})),[[se,"變更背景圖片","top"]]):(g(),V(b,{key:4,icon:"",color:"blue-grey-darken-2",size:"28",class:"me-4",elevation:"2",onClick:t[3]||(t[3]=a=>_.value=!0)},{default:l(()=>[e(w,{size:"14"},{default:l(()=>t[31]||(t[31]=[o(" mdi-image ")])),_:1})]),_:1})),z(D)?le((g(),V(b,{key:5,icon:"",color:"light-blue-darken-3",size:"32",elevation:"2",onClick:t[4]||(t[4]=a=>x.value=!0)},{default:l(()=>[e(w,{size:"18"},{default:l(()=>t[32]||(t[32]=[o(" mdi-pencil ")])),_:1})]),_:1})),[[se,"修改密碼","top"]]):(g(),V(b,{key:6,icon:"",color:"light-blue-darken-3",size:"28",elevation:"2",onClick:t[5]||(t[5]=a=>x.value=!0)},{default:l(()=>[e(w,{size:"14"},{default:l(()=>t[33]||(t[33]=[o(" mdi-pencil ")])),_:1})]),_:1}))]),_:1})]),_:1})])]),_:1}),e(k,null,{default:l(()=>[e(Re,{class:"mb-5"})]),_:1}),e(k,{cols:"12"},{default:l(()=>[e(I,{class:"text-blue-grey-darken-2"},{default:l(()=>[e(k,{class:"py-0 mb-6",cols:"12",sm:"6",md:"4"},{default:l(()=>[e(I,null,{default:l(()=>[e(k,{cols:"3",sm:"12",class:"align-self-center py-0"},{default:l(()=>t[34]||(t[34]=[o(" 姓名 : ")])),_:1}),e(k,{cols:"9",sm:"12"},{default:l(()=>[s("div",Tl,P(z(y).name),1)]),_:1})]),_:1})]),_:1}),e(k,{class:"py-0 mb-6",cols:"12",sm:"6",md:"4"},{default:l(()=>[e(I,null,{default:l(()=>[e(k,{cols:"3",sm:"12",class:"align-self-center py-0"},{default:l(()=>t[35]||(t[35]=[o(" Email : ")])),_:1}),e(k,{cols:"9",sm:"12"},{default:l(()=>[s("div",Ll,P(z(y).email),1)]),_:1})]),_:1})]),_:1}),e(k,{class:"py-0 mb-6",cols:"12",sm:"6",md:"4"},{default:l(()=>[e(I,null,{default:l(()=>[e(k,{cols:"3",sm:"12",class:"align-self-center py-0 pe-0 pe-sm-2"},{default:l(()=>t[36]||(t[36]=[o(" 用戶編號 : ")])),_:1}),e(k,{cols:"9",sm:"12"},{default:l(()=>[s("div",Rl,P(z(y).isAdmin?z(y).adminId:z(y).userId),1)]),_:1})]),_:1})]),_:1}),e(k,{class:"py-0 mb-6",cols:"12",sm:"6",md:"4"},{default:l(()=>[e(I,null,{default:l(()=>[e(k,{cols:"3",sm:"12",class:"align-self-center py-0"},{default:l(()=>t[37]||(t[37]=[o(" 權限 : ")])),_:1}),e(k,{cols:"9",sm:"12"},{default:l(()=>[s("div",jl,P(ye()),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),F("",!0),F("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),e(Z,{modelValue:ce.value,"onUpdate:modelValue":t[8]||(t[8]=a=>ce.value=a),"max-width":"480"},{default:l(()=>[e(j,{class:"rounded-lg"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-darken-1 mb-2"},{default:l(()=>[e(w,{class:"me-2",size:"20"},{default:l(()=>t[46]||(t[46]=[o(" mdi-chat ")])),_:1}),t[48]||(t[48]=s("span",{class:"card-title text-white"},"綁定 LINE 帳號",-1)),e(R),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:h.value,ripple:!1,onClick:ze},{default:l(()=>[e(w,null,{default:l(()=>t[47]||(t[47]=[o(" mdi-close ")])),_:1})]),_:1},8,["size"])]),_:1}),e(W,{class:"pb-0"},{default:l(()=>[q.value?(g(),G("div",Fl,[t[53]||(t[53]=s("p",{class:"mb-3 card-content"}," 請在 LINE 中輸入以下認證碼： ",-1)),e(ee,{"model-value":q.value,readonly:"",variant:"outlined",density:"compact","append-inner-icon":"mdi-content-copy","onClick:appendInner":Je},null,8,["model-value"]),s("div",Ml,[s("div",Gl,[e(w,{color:"blue-darken-1",size:z(N)?"18":"16",class:"me-2"},{default:l(()=>t[49]||(t[49]=[o(" mdi-information ")])),_:1},8,["size"]),s("span",Ol," 認證碼將在 "+P(We(me.value))+" 過期 ",1)])]),s("ol",Kl,[s("li",Jl,[t[51]||(t[51]=o(" 在 LINE 中搜尋 @310ikxxu 或點擊下方連結加入官方帳號 ")),s("div",Wl,[e(b,{href:"https://line.me/R/ti/p/@310ikxxu",target:"_blank",color:"blue-darken-1",variant:"outlined",size:h.value,"prepend-icon":"mdi-link"},{default:l(()=>t[50]||(t[50]=[o(" Ystravel EIP 通知 ")])),_:1},8,["size"])])]),s("li",Yl," 輸入「"+P(q.value)+"」 ",1),t[52]||(t[52]=s("li",{class:"sub-title-1 mb-2"}," 等待綁定成功訊息 ",-1))])])):(g(),G("div",ql,[t[55]||(t[55]=s("p",{class:"mb-4 card-content"}," 點擊下方按鈕產生認證碼，並在 LINE 中輸入所產生之「 8位數認證碼 」來完成綁定。 ",-1)),e(b,{color:"blue-darken-1",variant:"outlined",size:h.value,loading:pe.value,onClick:Oe},{default:l(()=>t[54]||(t[54]=[o(" 產生認證碼 ")])),_:1},8,["size","loading"])]))]),_:1}),e(Q,{class:"me-4 mb-3"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",size:h.value,onClick:ze},{default:l(()=>t[56]||(t[56]=[o(" 關閉 ")])),_:1},8,["size"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(Z,{modelValue:x.value,"onUpdate:modelValue":t[18]||(t[18]=a=>x.value=a),"max-width":"320"},{default:l(()=>[e(j,{class:"rounded-lg pb-1"},{default:l(()=>[e(H,{class:"d-flex align-center ps-6 pe-4 py-1 bg-blue-darken-2 mb-4"},{default:l(()=>[e(w,{class:"me-2",size:"20"},{default:l(()=>t[57]||(t[57]=[o(" mdi-lock ")])),_:1}),t[59]||(t[59]=s("span",{class:"card-title text-white"},"修改密碼",-1)),e(R),e(b,{icon:"",variant:"plain",color:"white",class:"opacity-100",size:h.value,ripple:!1,onClick:re},{default:l(()=>[e(w,null,{default:l(()=>t[58]||(t[58]=[o(" mdi-close ")])),_:1})]),_:1},8,["size"])]),_:1}),e(W,{class:"pb-0"},{default:l(()=>[e(rl,{onSubmit:Xe(ke,["prevent"])},{default:l(()=>[e(ee,{modelValue:p.value.currentPassword,"onUpdate:modelValue":[t[9]||(t[9]=a=>p.value.currentPassword=a),t[10]||(t[10]=a=>n.value="")],"error-messages":n.value,type:C.value?"text":"password","append-inner-icon":C.value?"mdi-eye-off":"mdi-eye",label:"當前密碼",variant:"outlined",density:"compact",class:"mb-4","onClick:appendInner":t[11]||(t[11]=a=>C.value=!C.value)},null,8,["modelValue","error-messages","type","append-inner-icon"]),e(ee,{modelValue:p.value.newPassword,"onUpdate:modelValue":[t[12]||(t[12]=a=>p.value.newPassword=a),t[13]||(t[13]=a=>d.value="")],"error-messages":d.value,type:v.value?"text":"password","append-inner-icon":v.value?"mdi-eye-off":"mdi-eye",label:"新密碼",variant:"outlined",density:"compact",class:"mb-4","onClick:appendInner":t[14]||(t[14]=a=>v.value=!v.value)},null,8,["modelValue","error-messages","type","append-inner-icon"]),e(ee,{modelValue:p.value.confirmPassword,"onUpdate:modelValue":[t[15]||(t[15]=a=>p.value.confirmPassword=a),t[16]||(t[16]=a=>O.value="")],"error-messages":O.value,type:r.value?"text":"password","append-inner-icon":r.value?"mdi-eye-off":"mdi-eye",label:"確認新密碼",variant:"outlined",density:"compact",class:"mb-4","onClick:appendInner":t[17]||(t[17]=a=>r.value=!r.value)},null,8,["modelValue","error-messages","type","append-inner-icon"]),e(b,{type:"submit",style:{display:"none"}})]),_:1})]),_:1}),e(Q,{class:"me-4 mb-3"},{default:l(()=>[e(R),e(b,{color:"grey-darken-1",variant:"outlined",size:h.value,class:"me-2",onClick:re},{default:l(()=>t[60]||(t[60]=[o(" 取消 ")])),_:1},8,["size"]),e(b,{color:"blue-darken-2",variant:"outlined",size:h.value,loading:S.value,onClick:ke},{default:l(()=>t[61]||(t[61]=[o(" 確認 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(fl,{modelValue:_.value,"onUpdate:modelValue":t[19]||(t[19]=a=>_.value=a),"current-background":z(y).backgroundImage,"is-updating":B.value,onConfirm:Me,onShowUsageStats:t[20]||(t[20]=a=>E.value=!0)},null,8,["modelValue","current-background","is-updating"]),e(Pl,{modelValue:E.value,"onUpdate:modelValue":t[21]||(t[21]=a=>E.value=a)},null,8,["modelValue"]),e(ul,{modelValue:Ve.value,"onUpdate:modelValue":t[22]||(t[22]=a=>Ve.value=a),"dialog-width":"320",title:"解除 LINE 綁定",message:"您確定要解除 LINE 帳號綁定嗎？解除後將無法接收 LINE 通知。","confirm-button-color":"red-darken-1","confirm-button-text":"確認解除","cancel-button-text":"取消","header-color":"bg-red-lighten-1","header-icon":"mdi-alert-circle",onConfirm:Ke},null,8,["modelValue"]),e(Sl,{modelValue:T.value,"onUpdate:modelValue":t[23]||(t[23]=a=>T.value=a),"notification-prefs":ue.value,"selected-scale":m.value,"is-line-bound":we.value.isBound,"onUpdate:notificationPrefs":t[24]||(t[24]=a=>ue.value=a),"onUpdate:scale":t[25]||(t[25]=a=>m.value=a)},null,8,["modelValue","notification-prefs","selected-scale","is-line-bound"])],64))}},kt=ne(Hl,[["__scopeId","data-v-d7e396a8"]]);export{kt as default};

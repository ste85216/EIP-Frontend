import{r as u,w as Y,k as De,aV as N,Z as E,bH as t,a8 as a,a0 as i,a7 as d,bJ as Ue,_ as se,bf as c,aH as Fe,u as r,bM as Te}from"./@vue-Cr_z6yfx.js";import{i as Me}from"./vuetify-use-dialog-C5oZ13xz.js";import{l as $e}from"./lodash-CiJWSuVn.js";import{_ as Be,b as Ie}from"./index-mGnb0KKF.js";import{_ as qe}from"./ConfirmDeleteDialog-CuZPFffe.js";import{u as Oe,a as U}from"./vee-validate-BXV9nMa7.js";import{b as Ne,c as oe,f as Ee,d as Le}from"./yup-WHNMwcW8.js";import{d as He}from"./vuedraggable-6ak-rXVU.js";import{q as Qe,Q as We,w as p,v as F,g as f,P as re,r as b,d as Z,R as Ge,F as L,a as ie,b as ne,f as H,c as ue,x as Je,y as Ke,e as de,V as ce,U as Ye,a1 as Ze,S as je,Y as Xe,L as ea,T as aa}from"./vuetify-CbddcmEc.js";import"./perfect-debounce-Cp2ysxOb.js";import"./hookable-B8xFkYCm.js";import"./core-js-D2hAHviU.js";/* empty css             */import"./pinia-DBRIaiZ_.js";import"./vue-demi-Dq6ymT-8.js";import"./pinia-plugin-persistedstate-RV7uh3T-.js";import"./vue-router-CS4OewbW.js";import"./jspdf-DacfHTdZ.js";import"./@babel-BsCcpEdk.js";import"./fflate-EnPhvkmS.js";import"./unplugin-vue-router-B1N3mqWX.js";import"./axios-upsvKRUO.js";import"./vue3-google-login-Dx7TV_Hx.js";import"./vue-easy-lightbox-D952uME8.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-DzadwsAs.js";import"./vue-lrpUOyH4.js";import"./sortablejs-CtLrRV7F.js";const la={class:"text-center"},ta={class:"d-flex align-center"},sa={class:"text-truncate",style:{"max-width":"200px"}},oa={class:"text-truncate",style:{"max-width":"150px"}},ra={class:"d-flex align-center gap-1"},ia={class:"drag-handle cursor-move me-2"},na={class:"card-title text-white"},ua={class:"d-flex align-center"},da={class:"text-caption"},ca={__name:"sharedResourceManagement",setup(ma){const v=Me(),{apiAuth:V}=Ie(),{smAndUp:g}=Qe(),T=u([]),x=u(!1),M=u(10),_=u(1),j=u(0),m=u({type:null,isActive:null,quickSearch:""}),me=[{title:"全部",value:null},{title:"PDF",value:"pdf"},{title:"Word",value:"word"},{title:"Excel",value:"excel"},{title:"PowerPoint",value:"powerpoint"},{title:"圖片",value:"image"},{title:"壓縮檔",value:"zip"},{title:"其他",value:"other"}],pe=[{title:"全部",value:null},{title:"啟用",value:!0},{title:"停用",value:!1}],ve=[{title:"排序",key:"order",sortable:!1,align:"center",width:"80px"},{title:"檔案名稱",key:"name",sortable:!0},{title:"類型",key:"type",sortable:!0},{title:"描述",key:"description",sortable:!1},{title:"大小",key:"file.size",sortable:!0},{title:"下載次數",key:"downloadCount",sortable:!0},{title:"狀態",key:"isActive",sortable:!0},{title:"建立者",key:"creator",sortable:!1},{title:"操作",key:"actions",sortable:!1,width:"120px",align:"center"}],D=u(!1),$=u(!1),C=u(!1),B=u([]),Q=u(!1),fe=Ne({name:oe().required("請輸入檔案名稱").max(200,"名稱不能超過200字"),description:oe().max(500,"描述不能超過500字"),order:Ee().min(0,"排序順序不能小於0"),file:Le().nullable()}),{handleSubmit:ge,resetForm:X}=Oe({validationSchema:fe,validateOnMount:!1,initialValues:{name:"",description:"",order:0,isActive:!0,file:null}}),P=U("name"),I=U("description"),h=U("order"),A=U("isActive"),S=U("file"),w=u(null),W=u({_id:null}),y=u(!1),q=u(!1),ee=u(!1),G=u(null),ye=u(null),z=async()=>{var s,e;try{x.value=!0;const o={page:_.value,itemsPerPage:M.value};m.value.type&&(o.type=m.value.type),m.value.isActive!==null&&(o.isActive=m.value.isActive),m.value.quickSearch&&(o.search=m.value.quickSearch);const l=await V.get("/sharedResources",{params:o});T.value=l.data.result.data,j.value=l.data.result.totalItems}catch(o){console.error("載入共享資源錯誤:",o),v({text:((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||o.message||"載入共享資源失敗",snackbarProps:{color:"red-lighten-1"}})}finally{x.value=!1}},J=async()=>{_.value=1,await z()},be=$e.debounce(()=>{_.value=1,x.value=!0,J().finally(()=>{x.value=!1})},300),xe=s=>{s.page!==void 0&&(_.value=s.page),s.itemsPerPage!==void 0&&(M.value=s.itemsPerPage),z()},ke=async()=>{await Ve(),D.value=!0},Ve=async()=>{y.value=!1,X();try{const e=(await V.get("/sharedResources/max-order")).data.result||0;h.value.value=e+1}catch(s){console.error("取得最大排序值錯誤:",s);const e=T.value.length>0?Math.max(...T.value.map(o=>o.order||0)):0;h.value.value=e+1}P.value.value="",I.value.value="",A.value.value=!0,S.value.value=null,w.value=null},he=s=>{y.value=!0,P.value.value=s.name,I.value.value=s.description||"",h.value.value=s.order,A.value.value=s.isActive,S.value.value=null,w.value={...s.file,type:s.type},W.value={_id:s._id},D.value=!0},ae=ge(async s=>{var e,o,l;try{q.value=!0;const n=new FormData;n.append("name",s.name),n.append("description",s.description||""),n.append("order",s.order),n.append("isActive",A.value.value);const k=Array.isArray(s.file)?s.file[0]:s.file;if(console.log("檔案資料:",s.file),console.log("要上傳的檔案:",k),k&&k instanceof File)n.append("file",k);else if(!y.value){v({text:"請選擇要上傳的檔案",snackbarProps:{color:"orange-darken-1"}}),q.value=!1;return}let R;if(y.value){const O=W.value._id;R=await V.patch(`/sharedResources/${O}`,n,{headers:{"Content-Type":"multipart/form-data"}})}else R=await V.post("/sharedResources",n,{headers:{"Content-Type":"multipart/form-data"}});v({text:R.data.message,snackbarProps:{color:"teal-lighten-1"}}),K(),z()}catch(n){console.error("提交錯誤:",n),console.error("錯誤詳情:",(e=n.response)==null?void 0:e.data),console.error("請求配置:",n.config),v({text:((l=(o=n.response)==null?void 0:o.data)==null?void 0:l.message)||n.message||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}finally{q.value=!1}}),we=async()=>{var s,e;try{const o={page:1,itemsPerPage:9999};return(await V.get("/sharedResources",{params:o})).data.result.data||[]}catch(o){return console.error("載入共享資源錯誤:",o),v({text:((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||o.message||"載入共享資源失敗",snackbarProps:{color:"red-lighten-1"}}),[]}},_e=async()=>{const s=await we();B.value=[...s].sort((e,o)=>(e.order||0)-(o.order||0)),C.value=!0},ze=async()=>{var s,e;try{Q.value=!0;const o=B.value.map((n,k)=>({id:n._id,order:k+1})),l=await V.patch("/sharedResources/order/update",{sharedResources:o});v({text:l.data.message,snackbarProps:{color:"teal-lighten-1"}}),C.value=!1,await z()}catch(o){console.error("更新順序錯誤:",o),v({text:((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||o.message||"更新順序失敗",snackbarProps:{color:"red-lighten-1"}})}finally{Q.value=!1}},Ce=async s=>{var e,o;try{const l=await V.patch(`/sharedResources/${s._id}`,{isActive:!s.isActive});v({text:l.data.message,snackbarProps:{color:"teal-lighten-1"}}),z()}catch(l){console.error("切換狀態錯誤:",l),v({text:((o=(e=l.response)==null?void 0:e.data)==null?void 0:o.message)||l.message||"切換狀態失敗",snackbarProps:{color:"red-lighten-1"}})}},Pe=s=>{G.value=s,$.value=!0},Ae=async()=>{var s,e;try{ee.value=!0;const o=await V.delete(`/sharedResources/${G.value._id}`);v({text:o.data.message,snackbarProps:{color:"teal-lighten-1"}}),$.value=!1,z()}catch(o){console.error("刪除錯誤:",o),v({text:((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||o.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}finally{ee.value=!1}},K=()=>{D.value=!1,y.value=!1,X(),w.value=null,A.value.value=!0,h.value.value=0,W.value={_id:null}},Se=s=>({pdf:"PDF",word:"Word",excel:"Excel",powerpoint:"PowerPoint",image:"圖片",zip:"壓縮檔",other:"其他"})[s]||s,Re=s=>{switch(s){case"pdf":return"mdi-file-pdf-box";case"word":return"mdi-file-word-box";case"excel":return"mdi-file-excel-box";case"powerpoint":return"mdi-file-powerpoint-box";case"image":return"mdi-file-image";case"zip":return"mdi-folder-zip";default:return"mdi-file-document"}},le=s=>{switch(s){case"pdf":return"red";case"word":return"blue";case"excel":return"green";case"powerpoint":return"orange";case"image":return"purple";case"zip":return"amber";default:return"grey"}},te=s=>{if(!s)return"0 B";const e=1024,o=["B","KB","MB","GB"],l=Math.floor(Math.log(s)/Math.log(e));return Math.round(s/Math.pow(e,l)*100)/100+" "+o[l]};return Y(()=>m.value.quickSearch,s=>{be(s)}),Y(()=>m.value.type,()=>{_.value=1,x.value=!0,J().finally(()=>{x.value=!1})}),Y(()=>m.value.isActive,()=>{_.value=1,x.value=!0,J().finally(()=>{x.value=!1})}),De(()=>{z()}),(s,e)=>(N(),E(We,{"max-width":"1600"},{default:t(()=>{var o;return[a(F,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-4 mb-4 bg-white"},{default:t(()=>[a(p,{cols:"12",class:"ps-3 pb-6"},{default:t(()=>e[15]||(e[15]=[i("h3",null,"共享資源管理",-1)])),_:1}),a(p,{cols:"12"},{default:t(()=>[a(F,null,{default:t(()=>[a(p,null,{default:t(()=>[a(F,null,{default:t(()=>[a(p,null,{default:t(()=>[a(f,{"prepend-icon":"mdi-folder-plus-outline",variant:"outlined",color:"teal-darken-1",class:"me-4",onClick:ke},{default:t(()=>e[16]||(e[16]=[d(" 新增共享資源 ")])),_:1}),a(f,{"prepend-icon":"mdi-sort",color:"blue-grey-darken-2",variant:"outlined",onClick:_e},{default:t(()=>e[17]||(e[17]=[d(" 排序 ")])),_:1})]),_:1}),a(p,{sm:"3",lg:"2",xl:"2",class:"pe-1"},{default:t(()=>[a(re,{modelValue:m.value.type,"onUpdate:modelValue":e[0]||(e[0]=l=>m.value.type=l),items:me,"item-title":"title","item-value":"value",label:"類型篩選",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(p,{sm:"3",lg:"2",class:"pe-1"},{default:t(()=>[a(re,{modelValue:m.value.isActive,"onUpdate:modelValue":e[1]||(e[1]=l=>m.value.isActive=l),items:pe,"item-title":"title","item-value":"value",label:"狀態篩選",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),a(p,{sm:"4",lg:"3"},{default:t(()=>[a(F,{class:"d-flex align-center"},{default:t(()=>[a(p,{class:"d-flex align-center"},{default:t(()=>[s.mdAndUp?Ue((N(),E(b,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[aa,"可搜尋名稱或描述","top"]]):se("",!0),a(Z,{modelValue:m.value.quickSearch,"onUpdate:modelValue":e[2]||(e[2]=l=>m.value.quickSearch=l),label:"快速搜尋","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(p,{cols:"12"},{default:t(()=>[a(Ge,{"items-per-page":M.value,"onUpdate:itemsPerPage":e[3]||(e[3]=l=>M.value=l),headers:ve,items:T.value,loading:x.value,page:_.value,"items-length":j.value,class:"elevation-0 rounded","onUpdate:options":xe},{item:t(({item:l,index:n})=>{var k,R;return[i("tr",{class:Fe({"odd-row":n%2===0,"even-row":n%2!==0})},[i("td",la,[a(L,{size:"small",color:"blue-grey",variant:"tonal"},{default:t(()=>[d(c(l.order||0),1)]),_:2},1024)]),i("td",null,[i("div",ta,[i("div",sa,c(l.name),1)])]),i("td",null,[a(L,{color:le(l.type),size:"small"},{default:t(()=>[d(c(Se(l.type)),1)]),_:2},1032,["color"])]),i("td",null,[i("div",oa,c(l.description||"-"),1)]),i("td",null,c(te((k=l.file)==null?void 0:k.size)),1),i("td",null,c(l.downloadCount||0),1),i("td",null,[a(L,{color:l.isActive?"green-darken-1":"grey-darken-1",size:"small"},{default:t(()=>[d(c(l.isActive?"啟用":"停用"),1)]),_:2},1032,["color"])]),i("td",null,c(((R=l.creator)==null?void 0:R.name)||"未知"),1),i("td",null,[i("div",ra,[a(f,{icon:"",size:"small",color:"blue",variant:"text",onClick:O=>he(l)},{default:t(()=>[a(b,{size:"18"},{default:t(()=>e[18]||(e[18]=[d(" mdi-pencil ")])),_:1})]),_:2},1032,["onClick"]),a(f,{icon:"",size:"small",color:l.isActive?"orange":"green",variant:"text",onClick:O=>Ce(l)},{default:t(()=>[a(b,{size:"18"},{default:t(()=>[d(c(l.isActive?"mdi-pause":"mdi-play"),1)]),_:2},1024)]),_:2},1032,["color","onClick"]),a(f,{icon:"",size:"small",color:"red",variant:"text",onClick:O=>Pe(l)},{default:t(()=>[a(b,{size:"18"},{default:t(()=>e[19]||(e[19]=[d(" mdi-delete ")])),_:1})]),_:2},1032,["onClick"])])])],2)]}),_:1},8,["items-per-page","items","loading","page","items-length"])]),_:1})]),_:1})]),_:1})]),_:1}),a(ce,{modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=l=>C.value=l),"max-width":"400"},{default:t(()=>[a(ie,{class:"rounded-lg"},{default:t(()=>[a(ne,{class:"d-flex align-center px-6 py-2 bg-blue-grey-darken-2"},{default:t(()=>[a(b,{icon:"mdi-sort",size:r(g)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),e[21]||(e[21]=i("span",{class:"card-title text-white"},"共享資源排序",-1)),a(H),a(f,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:r(g)?"36":"32",onClick:e[4]||(e[4]=l=>C.value=!1)},{default:t(()=>[a(b,{size:r(g)?"22":"18"},{default:t(()=>e[20]||(e[20]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),a(ue,{class:"px-6 py-4"},{default:t(()=>[e[23]||(e[23]=i("div",{class:"text-subtitle-1 mb-4"}," 拖拽調整共享資源顯示順序 ",-1)),a(r(He),{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=l=>B.value=l),"item-key":"_id",class:"sortable-list",handle:".drag-handle",animation:"200","ghost-class":"ghost-item","chosen-class":"chosen-item"},{item:t(({element:l,index:n})=>[(N(),E(Je,{key:l._id,class:"border rounded mb-2"},{prepend:t(()=>[i("div",ia,[a(b,{color:"grey-darken-1"},{default:t(()=>e[22]||(e[22]=[d(" mdi-drag-vertical ")])),_:1})])]),append:t(()=>[a(L,{size:"small",color:"blue-grey"},{default:t(()=>[d(c(n+1),1)]),_:2},1024)]),default:t(()=>[a(Ke,null,{default:t(()=>[d(c(l.name),1)]),_:2},1024)]),_:2},1024))]),_:1},8,["modelValue"])]),_:1}),a(de,{class:"px-6 pb-5 pt-0"},{default:t(()=>[a(H),a(f,{variant:"outlined",color:"grey-darken-1",size:r(g)?"default":"small",onClick:e[6]||(e[6]=l=>C.value=!1)},{default:t(()=>e[24]||(e[24]=[d(" 取消 ")])),_:1},8,["size"]),a(f,{color:"blue-grey-darken-2",variant:"outlined",class:"ms-2",size:r(g)?"default":"small",loading:Q.value,onClick:ze},{default:t(()=>e[25]||(e[25]=[d(" 更新 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ce,{modelValue:D.value,"onUpdate:modelValue":e[13]||(e[13]=l=>D.value=l),"max-width":"800",persistent:"",scrollable:""},{default:t(()=>[a(ie,{class:"rounded-lg"},{default:t(()=>[a(ne,{class:"d-flex align-center px-6 py-2 bg-teal-darken-1"},{default:t(()=>[a(b,{icon:"mdi-folder-plus-outline",size:r(g)?"20":"18",color:"white",class:"me-2"},null,8,["size"]),i("span",na,c(y.value?"編輯共享資源":"新增共享資源"),1),a(H),a(f,{icon:"",variant:"plain",class:"opacity-100",ripple:!1,color:"white",size:r(g)?"36":"32",onClick:K},{default:t(()=>[a(b,{size:r(g)?"22":"18"},{default:t(()=>e[26]||(e[26]=[d(" mdi-close ")])),_:1},8,["size"])]),_:1},8,["size"])]),_:1}),a(ue,{class:"px-6 py-4 mt-4"},{default:t(()=>[a(Ye,{ref_key:"formRef",ref:ye,onSubmit:Te(r(ae),["prevent"])},{default:t(()=>[a(F,null,{default:t(()=>[a(p,{cols:"12",md:"8"},{default:t(()=>[a(Z,{modelValue:r(P).value.value,"onUpdate:modelValue":e[8]||(e[8]=l=>r(P).value.value=l),"error-messages":r(P).meta.touched?r(P).errorMessage.value:[],label:"檔案名稱 *",variant:"outlined",density:"compact",counter:"200",clearable:""},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12",md:"4"},{default:t(()=>[a(Z,{modelValue:r(h).value.value,"onUpdate:modelValue":e[9]||(e[9]=l=>r(h).value.value=l),"error-messages":r(h).meta.touched?r(h).errorMessage.value:[],label:"排序順序",type:"number",variant:"outlined",density:"compact",hint:"數字越小越靠前"},null,8,["modelValue","error-messages"])]),_:1}),a(p,{cols:"12"},{default:t(()=>[a(Ze,{modelValue:r(I).value.value,"onUpdate:modelValue":e[10]||(e[10]=l=>r(I).value.value=l),label:"描述",variant:"outlined",density:"compact",rows:"3",counter:"500",clearable:""},null,8,["modelValue"])]),_:1}),a(p,{cols:"12",md:"6",class:"ms-3"},{default:t(()=>[a(je,{modelValue:r(A).value.value,"onUpdate:modelValue":e[11]||(e[11]=l=>r(A).value.value=l),label:"啟用狀態",color:"green",density:"compact","hide-details":""},null,8,["modelValue"])]),_:1}),a(p,{cols:"12"},{default:t(()=>[a(Xe,{modelValue:r(S).value.value,"onUpdate:modelValue":e[12]||(e[12]=l=>r(S).value.value=l),label:y.value?"更換檔案（選填）":"檔案 *",variant:"outlined",density:"compact","prepend-icon":"mdi-paperclip","show-size":"","error-messages":r(S).meta.touched&&!y.value&&!r(S).value.value?["請選擇檔案"]:[]},null,8,["modelValue","label","error-messages"])]),_:1}),y.value&&w.value?(N(),E(p,{key:0,cols:"12"},{default:t(()=>[a(ea,{type:"info",variant:"tonal",density:"compact",class:"mb-0"},{default:t(()=>[i("div",ua,[a(b,{color:le(w.value.type),size:"24",class:"me-3"},{default:t(()=>[d(c(Re(w.value.type)),1)]),_:1},8,["color"]),i("div",null,[e[27]||(e[27]=i("div",{class:"text-subtitle-2 font-weight-bold"}," 目前檔案 ",-1)),i("div",da,c(w.value.originalName)+" ("+c(te(w.value.size))+") ",1)])])]),_:1})]),_:1})):se("",!0)]),_:1})]),_:1},8,["onSubmit"])]),_:1}),a(de,{class:"px-6 pb-5 pt-0"},{default:t(()=>[a(H),a(f,{variant:"outlined",color:"grey-darken-1",size:r(g)?"default":"small",onClick:K},{default:t(()=>e[28]||(e[28]=[d(" 取消 ")])),_:1},8,["size"]),a(f,{color:"teal-darken-1",variant:"outlined",class:"ms-2",size:r(g)?"default":"small",loading:q.value,onClick:r(ae)},{default:t(()=>[d(c(y.value?"更新":"新增"),1)]),_:1},8,["size","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(qe,{modelValue:$.value,"onUpdate:modelValue":e[14]||(e[14]=l=>$.value=l),width:320,title:"確認刪除共享資源",message:`確定要刪除「${((o=G.value)==null?void 0:o.name)||""}」嗎？此操作無法復原。`,"confirm-button-color":"red-lighten-1","cancel-button-color":"grey-darken-1","confirm-button-text":"刪除","cancel-button-text":"取消",onConfirm:Ae},null,8,["modelValue","message"])]}),_:1}))}},Ea=Be(ca,[["__scopeId","data-v-61c77533"]]);export{Ea as default};
